# 概述
交换式以太网是一种星型拓扑结构网络，以交换机为核心设备进行组建。它不需要改变共享式以太网的其它硬件，仅需要以交换机代替集线器，节省了用户升级网络的成本。

以太网交换式同时提供多个通道，比传统的集线器提供更多的带宽。传统的共享式以太网采用广播方式通信，每次只能在一对用户间进行通信，如果发生碰撞还得重试，交换式以太网则允许多对用户同时进行通信。

以太网交换机一般都含有专用于处理数据包转发业务的ASIC(Application Specific Integrated Circuit)芯片，因此转发速度非常快。

# 术语
## CAM表
CAM表是交换机在数据链路层转发数据帧时要查找的表，其中存储了MAC地址与端口的对应关系，支持虚拟局域网功能的交换机还会记录端口所属的VLAN ID。交换机具有自动学习MAC地址的功能，以此来填充CAM表。

内容寻址存储器(Content Addressable Memory,CAM)是一种特殊的存储器，其每个存储单元都包含一个内嵌的逻辑比较组件，当写入新数据时，将会和内部存储的每条数据进行比较，并返回与写入数据相同的所有地址信息。

RAM是根据地址读、写数据的存储单元；而CAM恰恰相反，它返回的是与输入数据内容相匹配的地址信息。其不仅广泛应用在交换机与路由器上，还可用于CPU的Cache控制器等场合。

# 交换机工作流程
## 地址学习
交换机刚启动时CAM表是空的，当终端之间相互通信时，交换机将会通过地址学习过程填充CAM表项。

在以下示例中，PC1要与PC3相互通信。

<div align="center">

![学习机制](./Assets-交换式以太网/交换机工作流程-学习机制.jpg)

</div>

当交换机收到PC1发来的数据帧时，读取源MAC地址，查找CAM表，发现没有关于该MAC地址的记录，则将源端口和MAC地址写入CAM表中。

## 泛洪转发
交换机读取目的地址，查找CAM表，发现没有相关记录，随即复制该帧，并向除了源端口的所有其它端口转发该帧，此行为与集线器相同。

<div align="center">

![泛洪转发](./Assets-交换式以太网/交换机工作流程-泛洪转发.jpg)

</div>

PC3收到该帧后进行回复，其它PC发现该帧的MAC地址与自己的接口地址不一致，则丢弃该帧。

<div align="center">

![目标主机进行回应](./Assets-交换式以太网/交换机工作流程-目标主机进行回应.jpg)

</div>

## 直接转发
交换机收到回复帧之后，记录源端口和MAC地址，并且读取目的地址，查找CAM表，发现该MAC地址与E1端口相关联，则向E1端口转发该帧。

<div align="center">

![直接转发](./Assets-交换式以太网/交换机工作流程-直接转发.jpg)

</div>
  
## 老化机制
当一个表项在一段时间内没有被更新，老化计时器归零后，这个表项将被清除。

## 删除机制
当一个端口状态变为关闭之后，所有从该端口学习到的表项将被立即清除。

## 更新机制
若将PC3与PC2连接的端口互换（各连接一个下级交换机，使插拔设备时E1和E3端口不变为关闭状态，此图中已省略），当交换机检测到帧的源地址与CAM表项不匹配时，则更新CAM表中的记录。

<div align="center">

![更新机制](./Assets-交换式以太网/交换机工作流程-更新机制.jpg)

</div>

## 帧过滤机制
当一个端口收到的数据帧目的地址对应目标是端口自身时，将被直接丢弃。

<div align="center">

![帧过滤机制](./Assets-交换式以太网/交换机工作流程-帧过滤机制.jpg)

</div>

# 交换机工作方式
🔷 直通式(Cut Through)

只检查帧头目的地址，然后立刻开始转发。

这种方式无差错校验功能，易丢包；但延迟最低，部分特殊场合有相关应用。

🔷 存储转发式(Store and Forward)

将接收到的帧先缓存下来，进行完整性校验，确定完整后才转发。

这种方式转发时延较大，成本较高；但可靠性比其他方式更高，是目前主要的转发方式。

🔷 无碎片式(Fragment Free)

首先检查帧的长度是否够64个字节，若小于64字节则丢弃，若大于64字节，则发送该帧。

这种方式可保证碰撞碎片不在网络中传播，处理速度介于直通式和存储转发式之间，是一种折中的处理方式。

# 命令列表
## Cisco设备
### 基本配置
🔷 添加静态表项

```text
Cisco(config) # mac address-table static <MAC地址> interface <端口ID> vlan <VLAN ID>
```

该功能是指MAC地址对应的设备只能连接到本VLAN中的对应端口，对于其他通过该端口连接的设备则没有限制。

🔷 更改老化时间

Cisco设备的CAM表默认老化时间为300秒，我们可以更改为其他数值，如果设为"0"，则表项永不超时。

```text
Cisco(config)# mac-address-table aging-time <老化时间/秒> [vlan <VLAN ID>]
```

### 调试工具
🔶 查看CAM表内容

```text
Cisco# show mac address-table
```

🔶 清除CAM表内容

```text
Cisco# clear mac address-table [dynamic] [vlan <VLAN ID>]
```

参数说明：

🔺 `dynamic`

添加此选项时将删除所有动态学习到的表项，保留静态表项；不添加此选项则删除所有表项。
