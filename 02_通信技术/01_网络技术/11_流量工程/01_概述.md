# 简介
服务质量(Quality of Service, QoS)是指利用各种基础设施，为特定网络业务提供更优服务的技术。当网络传输发生拥塞时，QoS技术能够使得重要业务流量被优先转发，从而保障通信系统高效运行。

QoS主要实现了这些功能：不同业务流量的分类与标记、拥塞管理、流量整型与监管、改善链路效率，相关标准在RFC 3644等文档中定义与演进。

QoS可以解决时延、阻塞、抖动等问题，若网络中只有对时延不敏感的应用（如Web或E-Mail），QoS并不重要；若存在重要业务或多媒体流量，QoS就显得十分重要了。

# 通信质量问题
## 带宽不足
一条链路的可用带宽取决于链路上最小的带宽，当带宽不足(Lack of Bandwidth)时，将会影响业务的可靠性。

我们可以通过以下方式改善带宽不足的问题：

🔷 升级带宽

升级链路带宽能够从根本上解决问题，管理成本较低，但经济成本较高。

🔷 压缩与解压

压缩帧或IP报头，以减少需要传输的总数据量。

由于压缩、解压缩过程需要消耗时间，该方案不适用于时延敏感型应用，导致无法覆盖部分场景。

🔷 部署QoS技术

通过给不同业务设置优先级，使得重要报文能够优先传输。

该方案能够利用现有设备，经济成本较低；但需要系统地进行规划与配置，管理成本较高。

## 端到端的时延
一条链路的时延是数据包途径所有站点的时延之和，也被称为端到端的时延(End-to-end Delay)。

链路上的时延具体分为以下类型：

🔶 串行化延时(Serialization Delay)

设备将数据流转换为传输介质所需信号的调制与解调时间，该部分不可控。

🔶 传播延时(Propagation Delay)

信号在物理介质上传播所需的时间，该部分不可控。

🔶 处理延时(Processing Delay)

设备查找数据帧或数据包出站接口所需的时间，该部分不可控。

🔶 队列延时(Queuing Delay)

数据帧或数据包在接口缓冲区等待的时间，该部分可以通过QoS进行控制。

## 抖动
一个报文中的分组可能通过不同的链路传输，它们经历的时延也不同，到达目标节点后将会乱序，这被称为抖动(Jitter)。

抖动对实时性不敏感的应用影响较为轻微，对语音和视频业务影响较为严重。

## 丢包
设备接口缓冲队列默认使用尾丢弃机制，如果缓冲队列已经塞满，新进入的报文将被丢弃，这被称为丢包(Packet Loss)。

我们有时也会主动进行丢包，通过WRED等机制主动丢弃优先级不高的报文，以确保重要业务的稳定。

# QoS服务模型
## 尽力而为
未配置QoS策略的普通网络提供尽力而为(Best Effort)的服务，这种网络无法保证重要业务优先。

## 集成服务
集成服务(IntServ)通过协议信令进行控制，每个节点收到信令后预留一定的带宽。

这种网络通常使用RSVP协议进行控制，灵活度较差，通常用于VoIP等业务类型固定的专用网络。

## 差分服务
差分服务(DiffServ)是使用最广泛的模型，我们可以为每个节点配置不同的QoS策略，控制特定业务的转发行为，灵活度较高。

# 常用的QoS策略
网络控制与管理协议（路由协议、SSH等）带宽需求小、对时延和抖动不敏感，但影响数据的转发，需要确保指令优先送达；语音流量带宽需求较小，但对时延和抖动非常敏感，需要尽快转发；视频流量带宽需求较大，对时延和抖动较为敏感，但数据冗余度较高，偶尔丢包不会产生严重影响；其它业务流量对网络质量的要求较低。

综上所述，各种流量的优先程度从高到低如下文列表所示：

- 控制层面与管理层面协议
- 重要的语音业务流量
- 重要的视频业务流量
- 重要的业务流量
- 普通的业务流量
