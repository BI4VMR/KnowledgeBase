# 概述
随着网络技术的发展，IPv4的缺点逐渐显露：

- 地址空间有限，已经资源短缺。
- 地址分配杂乱无章，导致Internet路由表条目过多，且聚合困难。
- 数据包头部复杂且长度可变，占用硬件资源多，转发效率低。
- 对组播、安全性、移动漫游等特性支持不足。

IPv4的缺点限制了技术的发展，IETF在20世纪90年代提出了IPv6技术来解决这些问题，IPv6具有以下优点：

- 拥有更大的地址空间，且配置更简单。
- 地址分配更规律，便于路由聚合，减小Internet路由表规模。
- 简化了数据包头部，取消校验和，将可选字段变为定长，提高转发效率。
- 对组播、移动漫游等支持更好，且集成IP Sec机制，安全性更佳。

# 术语
## 接口标识符
IPv6地址由网络前缀和接口标识符两个部分组成，其中接口标识符用于标识设备上的接口，相当于IPv4的主机号。

接口标识符可以随机生成，也可以采用"MAC to EUI-64"方式转换得出。

## EUI-64标准
EUI-64是将MAC地址转换为接口标识符的一种标准。

EUI-64标识符的生成方式为：

1. 在MAC地址的高24位和低24位之间插入FFFE。
2. 将MAC地址的G/L位（从左到右第7位）取反。

在MAC地址中，G/L位为"1"时表示本地地址，为"0"时表示全局地址；在EUI-64标准中，第7位为"1"时表示全球唯一地址，为"0"时表示本地唯一地址。

# 报文格式
IPv6的报文头部分为基本报头与扩展报头，其中基本报头是必选的，包含基础信息；而扩展报头时可选的，仅当需要使用特定功能时才会携带。

## 基本报头
IPv6的基本报头结构如下图所示：

<div align="center">

![IPv6报文头部](./Assets-IPv6/IPv6报文头部.jpg)

</div>

🔺 绿色表示该字段与IPv4含义完全相同。

🔺 蓝色表示该字段与IPv4相比含义有变化。

🔺 灰色表示该字段与IPv4相比是新增的字段。

🔷 Version

协议版本号，长度1字节。

在IPv6中取值固定为"6"。

🔷 Traffic Class

流量类别，长度1字节。

类似于IPv4中的ToS字段，用于标识报文的优先级。

🔷 Flow Label

流标签，长度2字节。

具有相同取值的数据包属于同一个数据流。

🔷 Payload Length

数据载荷长度，长度2字节。

表明该IPv6数据包除基本报头以外部分的字节数，包含扩展头部与有效数据载荷。

🔷 Next Header

下一头部类型，长度1字节。

用于表示基本报头后部的数据类型。若存在扩展报头，表示第一个扩展报头的类型；否则表示IP包承载的上层协议类型。

🔷 Hop Limit

越点数量限制，长度1字节。

功能类似于IPv4中的TTL字段。

🔷 Source Address

源地址。

🔷 Destination Address

目的地址。

## 扩展报头
扩展报头作用与IPv4中的可选字段相同，它们被放置在基本报头和有效数据载荷之间，并且都是定长的，便于路由软件进行处理。

目前共有逐跳选项、目的地选项、松散源路由、分片控制、认证(AH)、封装安全载荷(ESP)和六种报头。

# 编址方式
## 书写格式
IPv6地址的长度为128位（16字节），使用“冒号分十六进制”格式表示，每个地址均由前缀和接口标识符两部分组成，前缀相当于IPv4的网络ID；接口标识符相当于主机ID。

IPv6地址不再划分类别，而是根据前缀确定用途。IPv6也不再使用子网掩码的形式表示前缀长度，而是使用 `/xx` 的格式，紧接着地址书写。

此处给出一个合法的IPv6地址作为示例：

```text
12AB:0000:0000:CD30:0000:0000:0000:0000/60
```

## 简写规则
IPv6地址长度较长，书写较为不便，因此符合一定规则时我们可以进行简写：

1. 每个小节开头的"0"可以省略。
2. 内容为"0000"的小节可以简写为一个"0"。
3. 多个连续的"0000"小节可以用双冒号( `::` )表示，但只能使用一次，应当优先简化"0"最多的部分。

前文示例中的地址可以简写为：

```text
12AB::CD30:0:0:0:0/60

12AB:0:0:CD30::/60
```

上述两种方式都是正确的，选择第二种方式更为简洁。

## 特殊表示方法
某些情况下冒号会产生歧义，例如：在包含IPv6地址的URL中，地址和应用层端口号都含有冒号；此时我们可以将IPv6地址用方括号( `[]` )包围以消除歧义。

```text
https://[12AB:0000:0000:CD30:0000:0000:0000:0000]:8080/
```

# 单播地址
单播(Unicast)地址是用于标识单个接口的地址。

## 可聚合全球单播地址
可聚合全球单播地址(Aggregate Global Unicast Addresses, AGUA)是由IANA分配的、可在全球路由的公网地址，首部固定为"001(2000)"，范围为："2000::/3"到"3FFF::/3"。这种地址相当于IPv4的公网地址，一个接口可以拥有多个AGUA地址。

AGUA地址的结构如下：

```text
<001><全局路由前缀><子网ID><接口标识符>
   3            45      16          64
```

IPv6公网地址的最小前缀长度为32位，一般分配给运营商；运营商分配给组织的前缀长度为48位，剩余16位用于划分子网；如果用户不需要再划分子网，则通常分配64位的地址块，例如手机等移动设备。

## 链路本地地址
每个启用了IPv6的接口会自动生成一个链路本地地址(Link-Local Address)，首部固定为"1111111010(FE80)"。这种地址仅用于在接口所属的链路内通信，相当于IPv4的自动专用地址。

链路本地地址的结构如下：

```text
<FE80><::0><接口标识符>
   10   54          64
```

链路本地地址的接口标识符一般采用EUI-64标准生成，也可以手动配置。非以太网接口可能没有MAC地址，因此无法使用EUI-64生成该地址，此时生成规则由设备厂商自行指定。

## 站点本地地址
站点本地地址(Site-Local Address)的首部固定为"1111111011(FEC0)"，相当于IPv4的私有地址，用于私有网络内部的站点编址。

站点本地地址的结构如下：

```text
<FEC0><::0><子网ID><接口标识符>
   10   38      16          64
```

## 唯一本地地址
唯一本地地址(Unique-Local Address)是比站点本地地址更为常用的私有地址，首部固定为"11111101(FD00)"。

```text
<FD00><::0><子网ID><接口标识符>
   10   38      16          64
```

## 特殊地址
部分IP地址具有特殊的用途，我们不能将这些地址配置在普通设备上。

<div align="center">

|    特殊地址    |     用途     |
| :------------: | :----------: |
|    `::/128`    |   未知地址   |
|   `::1/128`    | 本地环回地址 |
| `::<IPv4地址>` | IPv4兼容地址 |

</div>

🔶 未知地址

与IPv4的未知地址类似，当设备未获取到有效IPv6地址时可作为源地址使用。

🔶 本地环回地址

与IPv4的本地环回地址类似，指向当前设备自身。

🔶 IPv4兼容地址

IPv4兼容地址(IPv4 Compatible Address)通过在IPv4地址前填充"0"，将其转为IPv6地址，该标准已经废弃，不应当再被使用。

# 组播地址
组播(Multicast)地址用于标识不同设备上的一组接口。

## 普通组播地址
普通组播地址是指可以用于业务的地址，这种地址首部固定为"11111111(FF)"，范围为："FF00::/8"到"FFFF::/8"。

紧接着首部的8位表示标记(Flag)和播送范围(Scope)，结构如下图所示：

<div align="center">

![IPv6组播地址的结构](./Assets-IPv6/IPv6组播地址的结构.jpg)

</div>

标记的前三位固定为"0"，末位为"0"时表示这是一个固定分配的地址；为"1"时表示这是一个临时分配的地址。

播送范围的取值和含义如下表所示：

<div align="center">

| Scope取值 |   含义   |
| :-------: | :------: |
|     0     |   预留   |
|     1     | 节点本地 |
|     2     | 链路本地 |
|     5     | 站点本地 |
|     8     | 组织本地 |
|     E     | 全局播送 |
|     F     |   预留   |

</div>

## 特殊组播地址
部分组播地址具有特殊的用途，我们不应将其用作业务地址。

<div align="center">

| 组播地址  |       用途        | 播送范围 |
| :-------: | :---------------: | :------: |
| `FF01::1` |     所有节点      | 节点本地 |
| `FF01::2` |    所有路由器     | 节点本地 |
| `FF02::1` |     所有节点      | 链路本地 |
| `FF02::2` |    所有路由器     | 链路本地 |
| `FF02::5` |  所有OSPF路由器   | 链路本地 |
| `FF02::6` | 所有OSPF-DR路由器 | 链路本地 |
| `FF02::9` |   所有RIP路由器   | 链路本地 |
| `FF02::D` |   所有PIM路由器   | 链路本地 |
| `FF05::2` |    所有路由器     | 站点本地 |

</div>

## 被请求节点组播地址
IPv6节点会为每个单播地址加入对应的组播组，以便侦听其它节点的MAC地址请求，这种机制取代ARP协议实现了IP与MAC的映射。

被请求节点(Solicited-Node)组播地址首部固定为"FF02:0:0:0:0:1:FF/104"，剩余部分为接口标识符的后24位。

```text
<ff02:0:0:0:0:1:ff><XX:XXXX>
                104       24
```

# 任播地址
任播(Anycast)是IPv6提供的一种新机制，用于更好地实现CDN等技术。任播地址用于标识一组接口，且地址空间与单播地址重合。任播数据包一般由协议控制传递给离发送者最近的节点，便于高效的分发热门资源。

# 基本应用
## 场景描述
本实验将通过IPv6技术，实现不同设备之间的网络层互联。

本实验的拓扑如下图所示：

<div align="center">

![IPv6实验拓扑](./Assets-IPv6/IPv6实验拓扑.jpg)

</div>

主机PC1与PC2（均为VPCS模拟器）分别与路由器R1的两个接口直连，我们为它们配置IPv6地址，以实现网络层的互联。

## 配置步骤
我们首先为路由器的两个接口配置IPv6地址。

```text
# 进入接口配置菜单
R1(config)# int e0/1

# 开启IPv6功能
# 部分Cisco设备默认关闭IPv6协议，我们需要先在接口上启用IPv6协议。
R1(config-if)# ipv6 enable

# 配置IPv6地址
R1(config-if)# ipv6 address FD00:10::1/64

# 返回前级菜单
R1(config-if)# exit


R1(config)# int e0/2
R1(config-if)# ipv6 enable
R1(config-if)# ipv6 address FD00:20::1/64
R1(config-if)# exit
```

然后在PC1与PC2上配置IPv6地址。

```text
# ===== PC1 =====
PC1> ip FD00:10::2/64       
PC1 : fd00:10::2/64


# ===== PC2 =====
PC2> ip FD00:20::/64 eui64
PC2 : fd00:20::2050:79ff:fe66:6804/64 eui-64
```

配置完成后，我们可以使用 `show ipv6 interface brief` 命令查看路由器R1的接口状态。

```text
R1# show ipv6 interface brief
Ethernet0/0            [administratively down/down]
    unassigned
Ethernet0/1            [up/up]
    FE80::A8BB:CCFF:FE00:1010
    FD00:10::1
Ethernet0/2            [up/up]
    FE80::A8BB:CCFF:FE00:1020
    FD00:20::1
Ethernet0/3            [administratively down/down]
    unassigned
```

根据该命令的输出结果，我们可以看到人工配置的地址已经应用到对应接口了，除此之外每个接口都有一个自动生成的链路本地地址（FE80开头的地址）。

## 功能测试
我们在PC1上进行Ping测试，目标为对应的路由器接口。

```text
PC1> ping fd00:10::2      

fd00:10::2 icmp_seq=1 ttl=64 time=0.001 ms
fd00:10::2 icmp_seq=2 ttl=64 time=0.001 ms
fd00:10::2 icmp_seq=3 ttl=64 time=0.001 ms
fd00:10::2 icmp_seq=4 ttl=64 time=0.001 ms
fd00:10::2 icmp_seq=5 ttl=64 time=0.001 ms
```

上述结果表明IPv6通信正常，配置无误。

# 命令列表
## Cisco设备
### 基本配置
🔷 配置接口的IPv6功能状态

```text
# 开启/关闭IPv6功能
Cisco(config-if)# [no] ipv6 enable
```

只有该选项设为开启时，接口上的其他IPv6配置项才会生效。

🔷 配置接口的IPv6地址

```text
# 手工指定完整的地址
Cisco(config-if)# ipv6 address <IPv6地址>/64 [link-local]

# 指定前缀，然后使用EUI-64标准自动生成完整的地址。
Cisco(config-if)# ipv6 address <前缀>/64 eui-64

# 配置基于SLAAC的IPv6地址
Cisco(config-if)# ipv6 address autoconfig
```

参数说明：

🔺 `link-local`

将该地址设为链路本地地址，覆盖原先自动生成的地址。

IPv6没有IPv4中每个接口最多拥有两个地址的限制，接口可以拥有多个IPv6地址，因此以上几种方式配置的地址可以并存。

### 调试工具
🔶 查看接口的IPv6信息

使用 `show ipv6 interface {brief | <接口名称>}` 命令可以查看接口的IPv6相关信息。

参数说明：

🔺 `brief`

添加该选项则显示上述摘要信息，否则显示详细信息。

🔺 `接口名称`

指定接口名称时，仅显示对应接口的信息，否则显示所有接口的信息。

<br />

我们可以添加"brief"选项以查看所有接口的摘要信息。

```text
Cisco# show ipv6 interface brief
Ethernet0/0            [administratively down/down]
    unassigned
Ethernet0/1            [up/up]
    FE80::A8BB:CCFF:FE00:1010
    FD00:10::1
Ethernet0/2            [up/up]
    FE80::A8BB:CCFF:FE00:1020
    FD00:20::1
Ethernet0/3            [administratively down/down]
    unassigned
```
