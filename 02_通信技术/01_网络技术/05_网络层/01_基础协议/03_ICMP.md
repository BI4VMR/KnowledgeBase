# 概述
IP协议本身没有提供任何可靠性机制，如果数据包在传输过程中发生异常，发送者无法知晓详细信息。

为了传递与IP相关的错误消息，人们设计了Internet报文控制协议(Internet Control Message Protocol, ICMP)，该协议作为IP网络的辅助协议，能够为我们提供一些有用的诊断信息，帮助我们排除通信故障。

# 报文格式
ICMP消息封装在IP数据包中传输，协议号为"1"，其中包含通用报文头部和长度可变的消息内容。

<div align="center">

![ICMP报文格式](./Assets-ICMP/ICMP报文格式.jpg)

</div>

🔷 Type

消息类型，长度1字节。

用于对各种消息进行粗略的分类。

🔷 Code

消息代码，长度1字节。

用于对某种类型的报文进行细分，描述更加详细的信息。

🔷 Checksum

校验和，长度2字节。

用于校验ICMP报文的完整性。

# 报文类型
ICMP报文可以分为差错报文与信息报文两个大类，其中差错报文用于报告错误，信息报文则用于配置或测试网络，常见的ICMP消息可参考下表：

<div align="center">

| Type  |  正式名称  | 类型  |         用途或含义         |
| :---: | :--------: | :---: | :------------------------: |
|   0   |  回显应答  | 信息  | 检测本地与目的主机的连通性 |
|   8   |  回显请求  | 信息  | 检测本地与目的主机的连通性 |
|   3   | 目标不可达 | 差错  |    数据包无法到达目的地    |
|   5   |   重定向   | 差错  |    告知源主机最优的路径    |
|  11   |    超时    | 差错  |         TTL值耗尽          |
|  12   |  参数问题  | 差错  |        报文格式出错        |

</div>

其中Type 3有很多常用的消息代码：

<div align="center">

| Code  |   正式名称   |               含义               |
| :---: | :----------: | :------------------------------: |
|   0   |  网络不可达  |    没有到达目的网络的路由信息    |
|   1   |  主机不可达  | 目标网络可达，但目标主机不可达。 |
|   2   |  协议不可达  |           协议类型未知           |
|   3   |  端口不可达  |          目标端口未开放          |
|   4   |  数据包过大  |       数据包过大但不可分片       |
|   5   |  源路由失败  |             路由失败             |
|  13   | 管理禁止通信 |   数据包被管理员配置的策略禁止   |

</div>

# 回显测试
Ping是我们经常使用的调试工具，可以检测节点间的连通性、丢包率与时延。

Ping程序可以使用ICMP的Type 0和Type 8报文，测试发起节点向目标节点发送Echo Request报文(Type 8)，然后等待对方应答，若对方成功接收该报文，将会回复Echo Reply报文(Type 0)，测试发起节点收到该回复即表明目标节点可达，双向通信正常。

<div align="center">

![ICMP回显测试](./Assets-ICMP/ICMP回显测试.jpg)

</div>

由于Echo报文中携带了序列号，因此同时进行多组测试时，也不会发生混乱，发送方还能根据收发一对报文的时间差计算出两点间的往返延迟。

有时防火墙并不允许转发ICMP消息，因此Ping工具通常还支持使用TCP或UDP协议进行探测，具体使用方式因平台而异。

# 路由追踪
Trace Route也是我们经常使用的调试工具，它能探测两个节点之间通信经过了哪些中间节点。

测试发起节点首先向目标节点发送TTL为1的Echo Request报文，路径上的第一个路由器收到后发现数据包TTL降为0，返还Time Exceeded报文，发起方就知道该节点为第一跳。以此类推，发送方每次发送TTL比原先大1的回显请求报文，探测路径上的每一个节点，直到目标节点回复应答报文为止。

<div align="center">

![ICMP回显测试](./Assets-ICMP/ICMP路由追踪.jpg)

</div>

传输路径上的部分节点可能不会回复ICMP消息，发送方的计时器超时后将显示该节点不可达，如果这些节点并不禁止转发ICMP消息，Trace Route程序仍然可以探测后续的其它节点。

# 重定向
ICMP重定向报文用于向终端通告最优的路由信息。如果路由器发现数据包的出入站接口相同，说明没有必要通过自己转发；若路由器恰好知道网段内的最优网关，就会通过ICMP重定向报文通告给终端。

现代网络架构中通常只使用单一的网关，故该报文较少出现。

以下场景中，PC1以R2为默认网关，R2有指向R1环回接口的路由。当PC1访问R1的环回接口时，将数据包发给默认网关R2，R2查询路由表后发现该数据包应该发给R1，出入站接口相同，于是发送重定向报文给PC1，告知最佳路径为R1。

<div align="center">

![ICMP重定向功能](./Assets-ICMP/ICMP重定向功能.jpg)

</div>

接收到重定向报文后，部分终端会添加一条主机路由优化流量，部分终端将不予理会。开启VRRP功能的路由器会主动关闭重定向功能，防止主备网关切换发生异常。
