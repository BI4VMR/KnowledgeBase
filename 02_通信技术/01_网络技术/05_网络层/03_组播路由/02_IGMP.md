# 概述
互联网组管理协议(Internet Group Management Protocol, IGMP)是TCP/IP协议栈中负责IPv4组播成员管理的协议。IGMP在接收者与其所在网络的组播路由器之间建立并维护组播组成员关系，配合组播路由协议引导组播流量。

IGMP现有版本1(RFC 1112)、版本2(RFC 2236)和版本3(RFC 3376)，版本1实现了基本的组管理功能；版本2添加了查询器选举和成员离组通知功能；版本3为SSM服务而设计，当前被广泛应用的是版本2。

# 报文格式
IGMP报文封装在IP报文中传输，协议号为2。

<div align="center">

![IGMPv1报文格式](./Assets-IGMP/IGMPv1报文格式.jpg)

</div>

🔷 Type

报文类型，长度2字节。

<div align="center">

| 数值  |       报文类型       |
| :---: | :------------------: |
| 0x11  |     通用查询报文     |
| 0x12  | 成员报告报文(IGMPv1) |
| 0x16  | 成员报告报文(IGMPv2) |
| 0x17  |     成员离组报文     |

</div>

🔷 Reserved/Max Response Time

在IGMPv1中，该字段未被使用，取值始终为"0"。

在IGMPv2中，表示主机回应时间的最大值。

🔷 Checksum

IGMP报文的校验和，长度2字节。

🔷 Group Address

组播组地址，长度4字节。

该字段在不同类型的报文中含义有所不同，各节点发送报文时，根据实际需要填入内容。

# 报文类型
## 通用组查询报文
组查询报文(General Query)由查询器向网络发出，用于查询组播组是否存在以及维护组成员关系，Group Address字段置"0"。

## 特定组查询报文
特定组查询报文(Group-Specific Query)是IGMPv2中新增的报文，用于查询特定组播组的成员，格式同通用组查询报文，Group Address字段为被查询组的地址。

## 成员报告报文
成员报告报文(Report)由主机向组播组发出，用于申请加入某个组播组或者应答路由器的查询报文。

## 成员离组报文
成员离组报文(Leave)是IGMPv2中特有的报文，主机离开某个组播组后发送该报文，通知组播路由器。

# 工作流程
## 周期性查询
查询器向网段内发送通用组查询报文，目的地址为"224.0.0.1"，网段内所有主机和路由器均能收到该报文。所有收到查询报文的主机启用一个随机计时器，计时器最先超时的主机发送成员报告报文，目的地址为所在的组播组地址，路由器收到报告即为该组生成转发表项"(*,G)"；同组的其它主机收到该报告后，抑制自身的报告，没有必要再发送了。

查询器执行通用查询的周期默认为30秒，主机的随机计时器取值为 `[0, 10]` 秒，IGMPv2中精确到小数点后一位，且可以自行修改。

## 入组报告
新加入的成员将会主动发送报告报文，通知组播路由器生成转发表项。

## 离组报告
IGMPv1主机将会静默离组，若组播组在本地网络还有其它成员，路由器仍然能收到成员报告报文；若组播组在本地网络没有其它成员，路由器将在一段时间后删除转发表项。

IGMPv2主机离组时将会向"224.0.0.2"发送成员离组报文，通知网络内所有路由器。收到离组报告后，路由器针对该组发送特定组查询报文，同时启动成员关系定时器，若定时器超时却未收到成员报告，则移除对应转发表项。

特定组查询报文的最大发送次数和间隔可以自行设置，默认值为2次和1秒，成员关系定时器的数值为 $发送次数 × 间隔$ 。

## 查询器选举
当网络中存在多个路由器时，为了节约带宽资源，需要选出一个路由器作为查询器。在IGMPv1中，查询器由PIM协议的DR担任；更高的版本中可以自行选举查询器，选举过程见后文。

起初所有路由器都向网段内发送通用查询报文，路由器收到其它节点的查询报文后，将其IP地址与自身接口地址作比较，最终网段内地址最小的路由器成为查询器。其它路由器不再发送周期性查询报文，而是启动一个定时器，每次收到查询器的报文后重置；若该定时器超时，则认为查询器失效，重新开始选举过程。



<!-- TODO
设置通用查询间隔
Cisco(config-if)#ip igmp query-interval [查询间隔/秒]
设置回应计时器最大值
Cisco(config-if)#ip igmp query-max-response-time [最大响应时间/秒]

加入指定的组播组
Cisco(config-if)#ip igmp join-group [组播地址] {source [SSM源地址]} 

设置特定组查询报文最大发送次数
Cisco(config-if)#ip igmp last-member-query-count [最大发送次数]

设置特定组查询报文发送间隔
Cisco(config-if)#ip igmp last-member-query-interval [间隔/毫秒]
-->
