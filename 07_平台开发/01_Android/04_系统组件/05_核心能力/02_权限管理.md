# ç®€ä»‹
æƒé™(Permission)æœºåˆ¶æ˜¯ç”¨æˆ·éšç§ä¿æŠ¤çš„ä¸€ä¸ªé‡è¦ç¯èŠ‚ã€‚

æ¯ä¸ªAndroidåº”ç”¨ç¨‹åºéƒ½è¿è¡Œåœ¨ç‹¬ç«‹çš„JVMä¹‹ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ— æ³•å¾—çŸ¥è™šæ‹Ÿæœºå¤–éƒ¨çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šå¤–éƒ¨å­˜å‚¨å™¨ã€è®¾å¤‡ä½ç½®ã€ä¼ æ„Ÿå™¨ä¿¡æ¯ç­‰ã€‚ä½†æ˜¯ï¼Œæœ‰äº›åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ç¡®å®éœ€è¦ä¸è™šæ‹Ÿæœºå¤–éƒ¨è¿›è¡Œäº¤äº’ï¼Œæ­¤æ—¶å°±è¦é€šè¿‡æƒé™æœºåˆ¶è¿›è¡Œæˆæƒã€‚

# æƒé™ç±»å‹
## æ™®é€šæƒé™(Normal)
æ™®é€šæƒé™æ‰€éœ€è®¿é—®çš„ä¿¡æ¯è¶…å‡ºäº†è™šæ‹Ÿæœºçš„èŒƒå›´ï¼Œä½†ä¸ä¼šé€ æˆç”¨æˆ·éšç§æ³„æ¼æˆ–å¯¼è‡´è®¾å¤‡å®‰å…¨é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè¿æ¥äº’è”ç½‘çš„æƒé™ã€‚

æ­¤ç±»æƒé™æ— éœ€ç”¨æˆ·ä¸»åŠ¨è¿›è¡Œæˆæƒï¼Œç”¨æˆ·ä¹Ÿæ— æ³•å°†å…¶ç¦ç”¨ï¼›åªè¦æ“ä½œç³»ç»Ÿæ²¡æœ‰ç‰¹æ®Šçš„è®¾ç½®ï¼Œåº”ç”¨ç¨‹åºå£°æ˜åå³å¯æ­£å¸¸ä½¿ç”¨ã€‚

## å±é™©æƒé™(Dangerous)
å±é™©æƒé™æ‰€éœ€è®¿é—®çš„ä¿¡æ¯æ¶‰åŠç”¨æˆ·éšç§ï¼Œæˆ–è€…å¯èƒ½å¯¹è®¾å¤‡æ­£å¸¸è¿è¡Œé€ æˆå¹²æ‰°ï¼Œä¾‹å¦‚ï¼šè®¾å¤‡ä½ç½®ã€å¤–éƒ¨å­˜å‚¨å™¨ã€é€šè®¯å½•ç­‰ã€‚

æ­¤ç±»æƒé™ä½¿ç”¨ä¹‹å‰éœ€è¦ç”±åº”ç”¨ç¨‹åºå‘èµ·ç”³è¯·ï¼Œç³»ç»Ÿå°†ä¼šå¼¹å‡ºçª—å£è¿›è¡Œè¯¢é—®ï¼Œå¾—åˆ°ç”¨æˆ·ç¡®è®¤åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ç”¨æˆ·å¯ä»¥åœ¨ç³»ç»Ÿè®¾ç½®ä¸­éšæ—¶æ’¤é”€è¿™äº›æˆæƒï¼Œå› æ­¤ç¨‹åºæ¯æ¬¡è®¿é—®å‰ï¼Œéƒ½éœ€è¦åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰ç›¸åº”çš„æˆæƒã€‚

## ç­¾åæƒé™(Signature)
ç­¾åæƒé™é€šå¸¸æ˜¯ä¸€äº›ç³»ç»Ÿçº§æ“ä½œçš„æƒé™ï¼Œä¾‹å¦‚ï¼šå®‰è£…ã€å¸è½½åº”ç”¨ç¨‹åºã€‚

æ­¤ç±»æƒé™å¹¶ä¸å…è®¸ç”¨æˆ·æ‰‹åŠ¨æˆäºˆæˆ–æ’¤é”€ï¼Œå½“åº”ç”¨ç¨‹åºçš„ç­¾åä¸ç³»ç»Ÿç­¾ååŒ¹é…æ—¶æ‰å¯æ­£å¸¸ä½¿ç”¨ï¼›é€šå¸¸é€‚ç”¨äºè®¾å¤‡åˆ¶é€ å•†çš„é¢„è£…è½¯ä»¶ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºåˆ™æ— æ³•ä½¿ç”¨ã€‚

# å£°æ˜ä¸è¯·æ±‚æƒé™
## å£°æ˜æƒé™
å½“åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ä¾èµ–æŸäº›æƒé™æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨Manifestæ–‡ä»¶ä¸­è¿›è¡Œå£°æ˜ï¼Œæ¯ä¸ª `<uses-permission>` æ ‡ç­¾ä»£è¡¨ä¸€æ¡æƒé™ã€‚

æ­¤å¤„ä»¥â€œè·å–è®¾å¤‡ç²—ç•¥ä½ç½®â€ä¸â€œè·å–è®¾å¤‡ç²¾ç¡®ä½ç½®â€æƒé™ä¸ºä¾‹ï¼š

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="net.bi4vmr.study">

    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />

    <application ...>
</manifest>
```

å¯¹äºæ™®é€šæƒé™ï¼Œåªéœ€è¦å®Œæˆæ­¤æ­¥éª¤å³å¯æ­£å¸¸ä½¿ç”¨ã€‚

## è¯·æ±‚è¿è¡Œæ—¶æƒé™
### æ—§API
â€œè·å–è®¾å¤‡ä½ç½®â€æ˜¯ä¸€ç§å±é™©æƒé™ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä»…è¦è¿›è¡Œå£°æ˜ï¼Œè¿˜éœ€è¦åœ¨é€»è¾‘ä»£ç ä¸­åŠ¨æ€åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æˆæƒã€‚

æˆ‘ä»¬åœ¨æµ‹è¯•Activityä¸Šæ”¾ç½®ä¸€ä¸ªæŒ‰é’®ï¼ŒæŒ‰é’®è¢«è§¦å‘åï¼Œæ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æƒé™ï¼Œè‹¥å·²æœ‰æƒé™åˆ™å¯ä»¥è®¿é—®ä½ç½®APIï¼Œå¦åˆ™éœ€è¦è¿›è¡Œç”³è¯·ã€‚

DemoBaseUI.java:

```java
public class DemoBaseUI extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.ui_demo_base);

        Button btnRequest = findViewById(R.id.btnRequest);
        btnRequest.setOnClickListener(v -> {
            if (checkPermission()) {
                Log.i("myapp", "å·²æ‹¥æœ‰è¯¥æƒé™ï¼Œå¯ä»¥è®¿é—®ä½ç½®ä¿¡æ¯ã€‚");
                // ç›¸å…³ä¸šåŠ¡æ“ä½œ ...
            } else {
                // å‡†å¤‡éœ€è¦è¯·æ±‚çš„æƒé™åˆ—è¡¨
                String[] reqParams = new String[]{
                        Manifest.permission.ACCESS_COARSE_LOCATION,
                        Manifest.permission.ACCESS_FINE_LOCATION};
                // è¯·æ±‚æƒé™
                requestPermissions(reqParams, 100);
            }
        });
    }

    // æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æŸé¡¹æƒé™
    private boolean checkPermission() {
        int code = checkSelfPermission(Manifest.permission.ACCESS_FINE_LOCATION);
        Log.i("myapp", "Check result code: " + code);
        if (code == PackageManager.PERMISSION_GRANTED) {
            Log.i("myapp", "å·²æ‹¥æœ‰è¯¥æƒé™ã€‚");
            return true;
        } else {
            Log.i("myapp", "æœªæ‹¥æœ‰è¯¥æƒé™ï¼Œæˆ–æ— æ³•è¯†åˆ«æˆæƒçŠ¶æ€ã€‚");
            return false;
        }
    }

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        Log.i("myapp", "OnRequestPermissionsResult. Request: " + requestCode);
        for (int i = 0; i < permissions.length; i++) {
            Log.i("myapp", permissions[i] + " | " + grantResults[i]);
        }
    }
}
```

æˆ‘ä»¬é¦–å…ˆé€šè¿‡Contextçš„ `checkSelfPermission(String permission)` æ–¹æ³•æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰â€œè·å–è®¾å¤‡ç²¾ç¡®ä½ç½®â€æƒé™ï¼Œå¦‚æœå·²æœ‰æƒé™åˆ™è¿›è¡Œåç»­ä¸šåŠ¡æ“ä½œï¼ˆæ­¤å¤„çœç•¥å…·ä½“å†…å®¹ï¼‰ï¼›å¦‚æœæ²¡æœ‰è¯¥æƒé™ï¼Œåˆ™éœ€è¦è¿›è¡ŒåŠ¨æ€ç”³è¯·ã€‚

Contextçš„ `requestPermissions(String[] permissions, int request)` æ–¹æ³•ç”¨äºç”³è¯·æƒé™ï¼Œç¬¬ä¸€å‚æ•°"permissions"æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯ä»¥åŒæ—¶è¯·æ±‚å¤šé¡¹ä¸åŒç±»å‹çš„æƒé™ï¼Œç³»ç»Ÿå°†ä¼šåˆ†åˆ«å¼¹å‡ºå¯¹è¯æ¡†è¯¢é—®ç”¨æˆ·æ˜¯å¦æˆæƒã€‚ç¬¬äºŒå‚æ•°"request"æ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œå°†ä¼šåœ¨ç»“æœå›è°ƒæ–¹æ³•ä¸­å‡ºç°ï¼Œç”¨äºåŒºåˆ†å­˜åœ¨å¤šå¤„è¯·æ±‚çš„æƒ…å†µã€‚

å½“ç”¨æˆ·å…³é—­æ‰€æœ‰æˆæƒå¼¹çª—åï¼Œ `onRequestPermissionsResult()` å›è°ƒå°†ä¼šè§¦å‘ï¼Œç¬¬ä¸€å‚æ•°"requestCode"å¯¹åº”è¯·æ±‚è€…ä¼ å…¥çš„æ•°å€¼ï¼Œç¬¬äºŒå‚æ•°ä¸ç¬¬ä¸‰å‚æ•°æ˜¯ä¸¤ä¸ªç­‰é•¿çš„æ•°ç»„ï¼Œåˆ†åˆ«å¯¹åº”æ¯é¡¹æƒé™çš„æˆæƒçŠ¶æ€ã€‚æ­¤æ—¶å¦‚æœè¯·æ±‚çš„æƒé™è¢«å…è®¸ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä¸šåŠ¡æ“ä½œï¼Œå¦åˆ™åº”å½“åœ¨ç•Œé¢ä¸Šæç¤ºç”¨æˆ·ç¼ºå°‘æƒé™åŠŸèƒ½å—é™ã€‚

ç›®å‰ç³»ç»Ÿæ”¯æŒä¸‰ç§æƒé™çŠ¶æ€ï¼šâ€œå·²æˆæƒâ€ã€â€œæ¯æ¬¡éƒ½è¯¢é—®â€ã€â€œå·²æ‹’ç»â€ï¼Œå¯¹äºå·²ç»è¢«ç”¨æˆ·æ˜ç¡®æ‹’ç»çš„æƒé™ï¼Œæˆ‘ä»¬è°ƒç”¨ `requestPermissions()` æ–¹æ³•ç³»ç»Ÿä¹Ÿä¸ä¼šå†å¼¹å‡ºå¯¹è¯æ¡†ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ `onRequestPermissionsResult()` å›è°ƒè¯·æ±‚å¤±è´¥ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ­¤å›è°ƒä¸­è°ƒç”¨Contextçš„ `shouldShowRequestPermissionRationale(String permission)` æ–¹æ³•ï¼Œåˆ¤æ–­æƒé™æ˜¯å¦è¢«ç”¨æˆ·æ˜ç¡®æ‹’ç»ã€‚

```java
@Override
public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
    super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    for (int i = 0; i < permissions.length; i++) {
        // åˆ¤æ–­â€œè¯·æ±‚ç²¾ç¡®ä½ç½®â€æƒé™æ˜¯å¦è¢«ç”¨æˆ·æ‹’ç»
        if (permissions[i].equals(Manifest.permission.ACCESS_FINE_LOCATION) && (grantResults[i] == PackageManager.PERMISSION_DENIED)) {
            if (!shouldShowRequestPermissionRationale(Manifest.permission.ACCESS_FINE_LOCATION)) {
                Log.i("myapp", "ç”¨æˆ·ä¸å…è®¸æˆæƒå¹¶è®¾ä¸ºä¸å†æç¤ºã€‚");
            }
        }
    }
}
```

> âš ï¸ è­¦å‘Š
>
> æ£€æµ‹æƒé™æ˜¯å¦è¢«æ‹’ç»çš„æ–¹æ³• `shouldShowRequestPermissionRationale(String permission)` åªèƒ½åœ¨è¯·æ±‚å®Œæˆåçš„ `onRequestPermissionsResult()` å›è°ƒä¸­ä½¿ç”¨ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¯·æ±‚æƒé™ä¹‹å‰è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¹Ÿä¼šå¾—åˆ°"false"è¿”å›å€¼ã€‚

å¯¹äºå·²è¢«ç”¨æˆ·æ˜ç¡®æ‹’ç»çš„æƒé™ï¼Œæˆ‘ä»¬åªèƒ½å¼•å¯¼ç”¨æˆ·è¿›å…¥ç³»ç»Ÿè®¾ç½®é¡µé¢æ‰‹åŠ¨æˆäºˆæƒé™ã€‚

```java
Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
Uri uri = Uri.fromParts("package", getPackageName(), null);
intent.setData(uri);
startActivity(intent);
```

### æ–°API
æ—§çš„æƒé™è¯·æ±‚æ¥å£ä¸ `startActivityForResult()` æ–¹æ³•ç±»ä¼¼ï¼Œå­˜åœ¨è€¦åˆæ€§è¾ƒå¼ºçš„é—®é¢˜ï¼Œå› æ­¤SDKä¸­æä¾›äº†å¯¹åº”çš„ActivityResultContractæ–¹æ¡ˆï¼Œæ¯ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªå›è°ƒï¼Œä»£ç ç»“æ„æ›´ä¸ºæ¸…æ™°ã€‚

DemoContractsUI.java:

```java
public class DemoRequest2UI extends AppCompatActivity {

    private final ActivityResultLauncher<String> activityLauncher = getActivityResultLauncher();

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.ui_demo_base);

        Button btnRequest = findViewById(R.id.btnRequest);
        btnRequest.setOnClickListener(v -> {
            if (checkPermission()) {
                Log.i("myapp", "å·²æ‹¥æœ‰è¯¥æƒé™ï¼Œå¯ä»¥è®¿é—®ä½ç½®ä¿¡æ¯ã€‚");
                // ç›¸å…³ä¸šåŠ¡æ“ä½œ ...
            } else {
                // è¯·æ±‚æƒé™
                activityLauncher.launch(Manifest.permission.ACCESS_FINE_LOCATION);
            }
        });
    }

    // æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æŸé¡¹æƒé™
    private boolean checkPermission() {
        int code = checkSelfPermission(Manifest.permission.ACCESS_FINE_LOCATION);
        Log.i("myapp", "Check result code: " + code);
        if (code == PackageManager.PERMISSION_GRANTED) {
            Log.i("myapp", "å·²æ‹¥æœ‰è¯¥æƒé™ã€‚");
            return true;
        } else {
            Log.i("myapp", "æœªæ‹¥æœ‰è¯¥æƒé™ï¼Œæˆ–æ— æ³•è¯†åˆ«æˆæƒçŠ¶æ€ã€‚");
            return false;
        }
    }

    // è·å–ActivityResultLauncherçš„æ–¹æ³•
    private ActivityResultLauncher<String> getActivityResultLauncher() {
        return registerForActivityResult(new ActivityResultContracts.RequestPermission(),
                new ActivityResultCallback<Boolean>() {
                    @Override
                    public void onActivityResult(Boolean result) {
                        if (result) {
                            Log.i("myapp", "ç”¨æˆ·å·²æˆäºˆè¯¥æƒé™ã€‚");
                        } else {
                            Log.i("myapp", "ç”¨æˆ·æ‹’ç»æˆäºˆè¯¥æƒé™ã€‚");
                            if (!shouldShowRequestPermissionRationale(Manifest.permission.ACCESS_FINE_LOCATION)) {
                                Log.i("myapp", "ç”¨æˆ·ä¸å…è®¸æˆæƒå¹¶è®¾ä¸ºä¸å†æç¤ºã€‚");
                            }
                        }
                    }
                });
    }
}
```

Contextçš„ `registerForActivityResult()` æ–¹æ³•ç”¨äºæ³¨å†Œåå®šï¼Œç¬¬äºŒå‚æ•°ActivityResultCallbackå³è¯·æ±‚ç»“æœå›è°ƒï¼Œå¸ƒå°”å€¼å‚æ•°"result"è¡¨ç¤ºè¯·æ±‚ç»“æœã€‚è¿™ç§åå®šå¯¹åº”çš„ActivityResultLauncherçš„ `launch()` æ–¹æ³•ç”¨äºè¯·æ±‚æƒé™ï¼Œå‚æ•°å³æƒé™åç§°ã€‚

é™¤äº†å•ä¸€æƒé™è¯·æ±‚åå®šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸€æ¬¡è¯·æ±‚å¤šä¸ªæƒé™ï¼Œè¿™ç§ActivityResultLauncherçš„ `launch()` æ–¹æ³•æ¥å—ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªæƒé™ã€‚

```java
// è·å–ActivityResultLauncherçš„æ–¹æ³•ï¼ˆå¤šä¸ªæƒé™ï¼‰
private ActivityResultLauncher<String[]> getActivityResultLauncher2() {
    return registerForActivityResult(new ActivityResultContracts.RequestMultiplePermissions(),
            new ActivityResultCallback<Map<String, Boolean>>() {
                @Override
                public void onActivityResult(Map<String, Boolean> result) {
                    // å¤šä¸ªæƒé™çš„è¯·æ±‚ç»“æœã€‚å…¶ä¸­Keyä¸ºåç§°ï¼›Valueä¸ºç»“æœã€‚
                }
            });
}
```

# AppOpsManager
## ç®€ä»‹
AppOpsManageræ˜¯Android 4.3å¼•å…¥çš„æƒé™ç®¡ç†å·¥å…·ï¼Œå®ƒæ¯”è¿è¡Œæ—¶æƒé™æœºåˆ¶æ›´æ—©å‡ºç°ï¼Œå¯ä»¥è¯»å–ç³»ç»Ÿé¢„è®¾çš„é…ç½®æ–‡ä»¶ï¼Œå†³å®šæ˜¯å¦æˆäºˆåº”ç”¨æŸäº›æƒé™ï¼›é™¤æ­¤ä¹‹å¤–ï¼ŒAppOpsManagerè¿˜ä¼šè®°å½•åº”ç”¨ç”³è¯·æƒé™çš„åŠ¨ä½œä¸æˆæƒç»“æœï¼Œä»¥ä¾¿å¼€å‘è€…å®¡è®¡æ•æ„Ÿæƒé™çš„ä½¿ç”¨çŠ¶å†µã€‚

AppOpsManagerä¸å…¶ä»–ç³»ç»ŸæœåŠ¡ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `AppOpsManager manager = context.getSystemService(AppOpsManager.class)` è·å–AppOpsManagerå®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶ä»–æ¥å£ã€‚

AppOpsManagerå°†åº”ç”¨è¯·æ±‚æƒé™çš„è¡Œä¸ºç§°ä¸ºæ“ä½œ(Operation)ï¼Œç®€ç§°ä¸ºOPï¼›OPåœ¨Frameworkä¸­ä½¿ç”¨æ•°å­—ç¼–å·è¡¨ç¤ºï¼Œæ‰€æœ‰çš„æ•°å­—ç¼–å·éƒ½åœ¨AppProtoEnumsç±»ä¸­ï¼Œè¯¥ç±»å°†åœ¨ç³»ç»Ÿç¼–è¯‘æœŸé—´è‡ªåŠ¨ç”Ÿæˆï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¿é—®å®ƒï¼Œä½†å¯ä»¥é€šè¿‡AppOpsManagerç±»ä¸­çš„"OPSTR_"ç³»åˆ—å­—ç¬¦ä¸²å¸¸é‡è¡¨ç¤ºOPåç§°ï¼Œå½“æˆ‘ä»¬ä¼ å…¥OPåç§°åï¼ŒAppOpsManagerå°†é€šè¿‡éšè—æ–¹æ³• `int strOpToOp(String op)` å°†OPåç§°è½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­—ç¼–å·ã€‚

ä»¥â€œè®¿é—®æ‘„åƒå¤´æ“ä½œâ€ä¸ºä¾‹ï¼Œä¸‹æ–‡ä»£ç å—å±•ç¤ºäº†OPæ•°å­—ç¼–ç ä¸åç§°çš„æ˜ å°„å…³ç³»ã€‚

"AppOpsManager.java":

```java
// OPæ•°å­—ç¼–å·ï¼Œåº”ç”¨ä¾§ä¸èƒ½ç›´æ¥è®¿é—®ã€‚
@UnsupportedAppUsage
public static final int OP_CAMERA = AppProtoEnums.APP_OP_CAMERA;

// OPåç§°ï¼Œåº”ç”¨ä¾§å¯ä»¥è®¿é—®ã€‚
public static final String OPSTR_CAMERA = "android:camera";
```

## æŸ¥è¯¢è¿‘æœŸçš„OPäº‹ä»¶
æˆ‘ä»¬å¯ä»¥é€šè¿‡AppOpsManagerå¯¹è±¡çš„ `List<AppOpsManager.PackageOps> getPackagesForOps(int[] ops)` æ–¹æ³•æˆ– `List<AppOpsManager.PackageOps> getPackagesForOps(String[] ops)` æ–¹æ³•æŸ¥è¯¢è¿‘æœŸçš„OPäº‹ä»¶è®°å½•ï¼Œå”¯ä¸€å‚æ•° `ops` è¡¨ç¤ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„OPï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æŸ¥è¯¢ç‰¹å®šç±»å‹çš„äº‹ä»¶ï¼Œéœ€è¦ä¼ å…¥è¿™äº›äº‹ä»¶ç¼–å·æˆ–åç§°æ‰€ç»„æˆçš„æ•°ç»„ï¼›å¦‚æœæˆ‘ä»¬å¸Œæœ›æŸ¥è¯¢æ‰€æœ‰äº‹ä»¶ï¼Œå¯ä»¥ä¼ å…¥ç©ºå€¼ã€‚

ä¸Šè¿°çš„ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯éšè—APIï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è°ƒç”¨å®ƒä»¬ï¼›å¦‚æœå½“å‰åº”ç”¨ç¨‹åºæ‹¥æœ‰ `android.Manifest.permission.GET_APP_OPS_STATS` æƒé™ï¼Œå¯ä»¥æŸ¥è¯¢æ‰€æœ‰åº”ç”¨çš„OPè®°å½•ï¼Œå¦‚æœæ²¡æœ‰è¢«æˆäºˆè¯¥æƒé™ï¼Œåˆ™åªèƒ½æŸ¥è¯¢å½“å‰ç¨‹åºè‡ªèº«çš„OPè®°å½•ã€‚

è¿”å›å€¼ `List<AppOpsManager.PackageOps>` å³OPä¿¡æ¯åˆ—è¡¨ï¼ŒPackageOpsæ˜¯AppOpsManagerçš„å†…éƒ¨ç±»ï¼Œå…·ä½“çš„æ•°æ®ç»“æ„å¯å‚è€ƒä¸‹æ–‡ä»£ç å—ï¼š

"PackageOps.java":

```java
public static final class PackageOps {

    // è¯·æ±‚è€…çš„åŒ…å
    private final String mPackageName;

    // è¯·æ±‚è€…çš„UID
    private final int mUid;

    // OPåˆ—è¡¨
    private final List<OpEntry> mEntries;
}
```

ç”±äºä¸€ä¸ªåº”ç”¨ç¨‹åºå¯èƒ½åŒæ—¶è¯·æ±‚å¤šä¸ªOPï¼Œå› æ­¤PackageOpså¯¹è±¡ä¸­åµŒå¥—äº†OpEntryå¯¹è±¡åˆ—è¡¨ï¼ŒOpEntryè¡¨ç¤ºè¯¥ç¨‹åºçš„æ¯ä¸ªOPï¼Œå…·ä½“çš„æ•°æ®ç»“æ„å¯å‚è€ƒä¸‹æ–‡ä»£ç å—ï¼š

"OpEntry.java":

```java
public static final class OpEntry {

    // OPæ•°å­—ç¼–å·
    private final int mOp;

    // è¯·æ±‚ç»“æœç¼–å·
    private final @Mode int mMode;

    // è¯¦æƒ…
    private final @NonNull Map<String, AttributedOpEntry> mAttributedOpEntries;

    // è·å–OPæ•°å­—ç¼–å·
    public int getOp() {}

    // è·å–è¯·æ±‚ç»“æœç¼–å·
    public @Mode int getMode() {
            return mMode;
        }

    // å½“å‰æ˜¯å¦æ­£åœ¨è¿è¡Œ
    public boolean isRunning() {}
}
```

OpEntryå¯¹è±¡ä¸­ä»ç„¶å­˜åœ¨åµŒå¥—ç»“æ„ï¼Œä½†æˆ‘ä»¬é€šå¸¸ä¸å¿…å…³æ³¨AttributedOpEntryï¼Œè§£æè‡³æœ¬å±‚çº§å·²ç»å¯ä»¥è·å–è¶³å¤Ÿä¸°å¯Œçš„OPä¿¡æ¯äº†ã€‚

è¯¥ç±»çš„ `boolean isRunning()` æ–¹æ³•è¾ƒä¸ºé‡è¦ï¼Œå®ƒèƒ½å¤ŸæŒ‡ç¤ºè¯¥OPæ˜¯å¦æ­£åœ¨è¿è¡Œä¸­ã€‚ä»…æœ‰éƒ¨åˆ†OPå…·æœ‰è¯¥å±æ€§ï¼Œä¾‹å¦‚ï¼šå½“ç¨‹åºè¯·æ±‚é«˜ç²¾åº¦GNSSä¿¡æ¯æ—¶ï¼ŒOP `MONITOR_HIGH_POWER_LOCATION(42)` çš„è¿è¡ŒçŠ¶æ€å°†å˜ä¸º"true"ï¼Œå½“ç¨‹åºåœæ­¢è¯¥æ“ä½œåï¼ŒOPçš„è¿è¡ŒçŠ¶æ€å°†å˜ä¸º"false"ã€‚å¦å¤–ä¸€éƒ¨åˆ†OPæ²¡æœ‰è¯¥å±æ€§ï¼Œå®ƒä»¬æ˜¯ç¬æ€çš„ï¼Œè¿è¡ŒçŠ¶æ€æ°¸è¿œä¸º"false"ï¼Œä¾‹å¦‚ï¼šç²—ç•¥ä½ç½® `COARSE_LOCATION(0)` å’Œç²¾ç¡®ä½ç½® `FINE_LOCATION(1)` ã€‚

å¸¸è§çš„å…·æœ‰è¿è¡ŒçŠ¶æ€å±æ€§çš„OPå¦‚ä¸‹æ–‡åˆ—è¡¨æ‰€ç¤ºï¼š

- `MONITOR_HIGH_POWER_LOCATION(42)` : å½“ç¨‹åºè¯·æ±‚é«˜ç²¾åº¦GNSSä¿¡æ¯æ—¶è§¦å‘ã€‚
- `CAMERA(26)` : å½“ç¨‹åºä½¿ç”¨æ‘„åƒå¤´æ—¶è§¦å‘ã€‚
- `RECORD_AUDIO(27)` : å½“ç¨‹åºä½¿ç”¨éº¦å…‹é£æ—¶è§¦å‘ã€‚
- `PHONE_CALL_MICROPHONE(100)` : å½“ç¨‹åºè¿›è¡Œè¯­éŸ³é€šè¯æ—¶è§¦å‘ã€‚
- `PHONE_CALL_CAMERA(101)` : å½“ç¨‹åºè¿›è¡Œè§†é¢‘é€šè¯æ—¶è§¦å‘ã€‚

## ç›‘å¬OPè¿è¡ŒçŠ¶æ€æ”¹å˜äº‹ä»¶
æˆ‘ä»¬å¯ä»¥é€šè¿‡AppOpsManagerå¯¹è±¡çš„ `startWatchingActive(String[] ops, Executor executor, OnOpActiveChangedListener callback)` æ–¹æ³•å’Œ `startWatchingActive(int[] ops, Executor executor, OnOpActiveChangedListener callback)` æ–¹æ³•æ³¨å†Œç›‘å¬å™¨ï¼Œç›‘å¬å…·æœ‰è¿è¡ŒçŠ¶æ€OPçš„çŠ¶æ€å˜åŒ–äº‹ä»¶ã€‚

ä¸Šè¿°çš„ä¸¤ä¸ªæ–¹æ³•ç¬¬ä¸€å‚æ•° `ops` éƒ½ä¸å¯ä¸ºç©ºå€¼ï¼Œæˆ‘ä»¬å¿…é¡»æ˜ç¡®åœ°å£°æ˜æ„Ÿå…´è¶£çš„OPï¼›å…¶ä¸­ç¬¬ä¸€å‚æ•°ç±»å‹ä¸ºStringæ•°ç»„çš„æ–¹æ³•ä¸OnOpActiveChangedListeneréƒ½æ˜¯å…¬å¼€APIã€‚

ç¬¬äºŒå‚æ•° `executor` ç”¨äºè®¾ç½®äº‹ä»¶å›è°ƒè‡³ç›‘å¬è€…æ—¶æ‰€ä½¿ç”¨çš„çº¿ç¨‹æ± ï¼›ç¬¬ä¸‰å‚æ•° `callback` æ˜¯ç›‘å¬å™¨çš„å…·ä½“å®ç°ã€‚å¦‚æœå½“å‰åº”ç”¨ç¨‹åºæ‹¥æœ‰ `android.Manifest.permission.WATCH_APPOPS` æƒé™ï¼Œå¯ä»¥ç›‘å¬æ‰€æœ‰åº”ç”¨çš„OPçŠ¶æ€å˜åŒ–äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰è¢«æˆäºˆè¯¥æƒé™ï¼Œåˆ™åªèƒ½ç›‘å¬å½“å‰ç¨‹åºè‡ªèº«äº§ç”Ÿçš„äº‹ä»¶ã€‚

OnOpActiveChangedListeneræ¥å£åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³• `onOpActiveChanged(String op, int uid, String packageName, boolean active)` ï¼Œæ¯å½“æ„Ÿå…´è¶£çš„OPè¿è¡ŒçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è¢«è§¦å‘ã€‚ç¬¬ä¸€å‚æ•° `op` æ˜¯å­—ç¬¦ä¸²å½¢å¼çš„OPåç§°ï¼›ç¬¬äºŒå‚æ•° `uid` æ˜¯è¯·æ±‚è€…çš„UIDï¼›ç¬¬ä¸‰å‚æ•° `packageName` æ˜¯è¯·æ±‚è€…çš„åŒ…åï¼›ç¬¬å››å‚æ•° `active` æ˜¯å½“å‰çš„è¿è¡ŒçŠ¶æ€ã€‚


<!-- TODO
## ç›‘æ§æ•æ„Ÿæƒé™çš„ä½¿ç”¨çŠ¶å†µ
è‡ªä»Android 12å¼€å§‹ï¼ŒAOSPæ–°å¢äº†éšç§æƒé™æŒ‡ç¤ºå™¨ï¼Œæ¯å½“åº”ç”¨ç¨‹åºæ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´ã€éº¦å…‹é£æ—¶ï¼ŒçŠ¶æ€æ å°±ä¼šå‡ºç°å¯¹åº”çš„å›¾æ ‡æç¤ºç”¨æˆ·ï¼Œç”¨æˆ·è¿˜å¯ä»¥ç‚¹å‡»å›¾æ ‡æŸ¥çœ‹åº”ç”¨åç§°ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹AOSPçš„ç›¸å…³ç½‘é¡µï¼š [ğŸ§­ AOSP - éšç§æŒ‡ç¤ºæ ‡å¿—è¯´æ˜](https://source.android.com/docs/core/permissions/privacy-indicators) ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨AppOpsManageræä¾›çš„æ¥å£ï¼Œç›‘æ§åº”ç”¨ç¨‹åºçš„æ•æ„Ÿæƒé™ä½¿ç”¨çŠ¶å†µï¼Œå¹¶å¯¹ç”¨æˆ·è¿›è¡Œæé†’ã€‚

-->
