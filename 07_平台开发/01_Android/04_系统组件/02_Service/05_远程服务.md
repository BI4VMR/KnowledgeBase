# ç®€ä»‹
åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹æ— æ³•ç›´æ¥è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ï¼Œä¸ºäº†å®ç°è¿›ç¨‹é—´é€šä¿¡(IPC)ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å‡è®¤å¯çš„ç¼–ç¨‹æ¥å£ï¼Œä»¥å®ç°åŒæ–¹çš„æ•°æ®äº¤äº’ã€‚

Androidå¹³å°æä¾›äº†AIDL(Android Interface Definition Language)ï¼Œç”¨äºæè¿°è·¨è¿›ç¨‹é€šä¿¡æ‰€ä½¿ç”¨çš„æ¥å£ï¼ŒAIDLæ–‡ä»¶ä¼šè¢«Gradleç¼–è¯‘å¹¶ç”Ÿæˆå¯¹åº”çš„Javaä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»‘å®šæœåŠ¡çš„æ–¹å¼ä½¿ç”¨è¿™äº›ä»£ç æä¾›çš„æ¥å£ï¼Œä¸å…¶ä»–åº”ç”¨ç¨‹åºè¿›è¡Œäº¤äº’ã€‚

AIDLæ¥å£æ”¯æŒä»¥ä¸‹æ•°æ®ç±»å‹ï¼š

- Javaä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹
- Stringå’ŒCharSequenceç±»å‹
- Mapå’ŒListç±»å‹
- Parcelableç±»å‹

å¦‚æœæˆ‘ä»¬éœ€è¦ä¼ é€’è‡ªå®šä¹‰ç±»å‹çš„æ•°æ®ï¼Œå¿…é¡»ä¸ºå…¶å®ç°Parcelableæ¥å£ï¼Œä»¥ä¾¿è¿›è¡Œåºåˆ—åŒ–ä¼ è¾“ã€‚

æœ¬ç« çš„ç¤ºä¾‹å·¥ç¨‹è¯¦è§ä»¥ä¸‹é“¾æ¥ï¼š

- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šè¿œç¨‹æœåŠ¡ - æœåŠ¡ç«¯](https://github.com/BI4VMR/Study-Android/tree/master/M04_System/C02_Service/S04_AIDL-Server)
- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šè¿œç¨‹æœåŠ¡ - å®¢æˆ·ç«¯](https://github.com/BI4VMR/Study-Android/tree/master/M04_System/C02_Service/S04_AIDL-Client)


# åŸºæœ¬åº”ç”¨
ä¸‹æ–‡ç¤ºä¾‹å±•ç¤ºäº†AIDLçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š

ğŸ”´ ç¤ºä¾‹ä¸€ï¼šAIDLçš„åŸºæœ¬åº”ç”¨ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡AIDLå®ç°å‰æ–‡ç¤ºä¾‹ä¸­çš„ä¸‹è½½æœåŠ¡ï¼Œè¿›è¡Œç®€å•çš„è·¨è¿›ç¨‹é€šä¿¡ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬ç¼–å†™AIDLæ¥å£ï¼Œå®šä¹‰æœåŠ¡ç«¯æ‰€æ”¯æŒçš„èƒ½åŠ›ã€‚

AIDLæ–‡ä»¶çš„åç¼€ä¸º `.aidl` ï¼Œåº”å½“æ”¾ç½®äº `<æ¨¡å—æ ¹ç›®å½•>/src/main/aidl/<åŒ…å>/` ç›®å½•ä¸­ï¼Œæ­¤å¤„çš„ `<åŒ…å>` å†³å®šäº†AIDLæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆçš„Javaæ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚

æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ç¨‹ä½œä¸ºæœåŠ¡ç«¯ï¼Œå¹¶åˆ›å»ºAIDLæ–‡ä»¶ `src/main/aidl/net/bi4vmr/aidl/IDownloadService.aidl` ï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹ï¼š

"IDownloadService.aidl":

```java
package net.bi4vmr.aidl;

interface IDownloadService {

    // è·å–æœåŠ¡ç«¯è¿›ç¨‹ID
    int getPID();

    // æ·»åŠ ä»»åŠ¡å¹¶å¼€å§‹ä¸‹è½½
    void addTask(in String url);

    // è·å–ä»»åŠ¡åˆ—è¡¨
    List<String> getTasks();
}
```

AIDLæ–‡ä»¶çš„è¯­æ³•ä¸Javaæ¥å£ç±»ä¼¼ï¼Œ `package` è¯­å¥ä¸­çš„è·¯å¾„ä¸ºè¯¥æ–‡ä»¶åœ¨ `<æ¨¡å—æ ¹ç›®å½•>/src/main/aidl/` ç›®å½•å†…çš„è·¯å¾„ã€‚

AIDLæ¥å£ä¸­çš„å¼•ç”¨ç±»å‹æ•°æ®é»˜è®¤éƒ½ä¸å¯ä¸ºç©ºï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯ç©ºçš„å‚æ•°æˆ–è¿”å›å€¼ï¼Œéœ€è¦æ·»åŠ  `@nullable` æ³¨è§£ï¼Œä¾‹å¦‚ï¼š `void addTask(in @nullable String url)` ã€‚

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯å®ç°AIDLæ¥å£ï¼Œæä¾›æ¥å£å¯¹åº”çš„èƒ½åŠ›ã€‚

æˆ‘ä»¬é¦–å…ˆä¸ºæœåŠ¡ç«¯å·¥ç¨‹æ‰§è¡Œä¸€æ¬¡Makeæˆ–Buildä»»åŠ¡ï¼Œä½¿Gradleç”ŸæˆAIDLå¯¹åº”çš„Javaç±»ã€‚ç¼–è¯‘å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ¨¡å—çš„ `build/generated/aidl_source_output_dir/debug/out` ç›®å½•ä¸­æ˜¯å¦å­˜åœ¨ `IDownloadService.java` ç­‰æ–‡ä»¶ã€‚

IDownloadServiceç±»ä¸­æœ‰ä¸€ä¸ªæŠ½è±¡ç±»IDownloadService.Stubï¼Œå®ƒç»§æ‰¿è‡ªBinderç±»ï¼ŒBinderå³Androidç³»ç»Ÿçš„æ ¸å¿ƒRPCæœºåˆ¶ã€‚æˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯Serviceå†…å®ç°IDownloadService.Stubä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œç¼–å†™å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚

"DownloadService.java":

```java
public class DownloadService extends Service {

    @Override
    public IBinder onBind(Intent intent) {
        return new DownloadImpl();
    }

    // AIDLæ¥å£çš„å®ç°ç±»
    private static class DownloadImpl extends IDownloadService.Stub {

        // ä»»åŠ¡é›†åˆ
        private final List<String> tasks = new ArrayList<>();

        // è·å–æœåŠ¡ç«¯è¿›ç¨‹ID
        @Override
        public int getPID() {
            int pid = Process.myPid();
            return pid;
        }

        // æ·»åŠ ä¸‹è½½ä»»åŠ¡
        @Override
        public void addTask(String url) {
            // åœ¨æ­¤å¤„å®ç°ä¸‹è½½ä¸šåŠ¡ï¼Œæ­¤å¤„çœç•¥ã€‚
            tasks.add(url);
        }

        // æŸ¥è¯¢ä¸‹è½½ä»»åŠ¡
        @Override
        public List<String> getTasks() {
            return tasks;
        }
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"DownloadServiceKT.kt":

```kotlin
class DownloadServiceKT : Service() {

    override fun onBind(intent: Intent): IBinder {
        return DownloadImpl()
    }

    /**
     * AIDLæ¥å£çš„å®ç°ç±»ã€‚
     */
    private inner class DownloadImpl : IDownloadService.Stub() {

        // ä»»åŠ¡é›†åˆ
        private val tasks: MutableList<String> = mutableListOf()

        // è·å–æœåŠ¡ç«¯è¿›ç¨‹ID
        override fun getPID(): Int {
            val pid = Process.myPid()
            return pid
        }

        // æ·»åŠ ä¸‹è½½ä»»åŠ¡
        override fun addTask(url: String) {
            // åœ¨æ­¤å¤„å®ç°ä¸‹è½½ä¸šåŠ¡ï¼Œæ­¤å¤„çœç•¥ã€‚
            tasks.add(url)
        }

        // æŸ¥è¯¢ä¸‹è½½ä»»åŠ¡
        override fun getTasks(): List<String> {
            return tasks
        }
    }
}
```

Serviceç¼–å†™å®Œæˆåï¼Œæˆ‘ä»¬åœ¨Manifestæ–‡ä»¶ä¸­æ³¨å†Œè¯¥ç»„ä»¶ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªActionæ ‡ç­¾ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯ç»‘å®šå®ƒã€‚

"AndroidManifest.xml":

```xml
<service
    android:name=".base.DownloadService"
    android:exported="true"
    android:process=":service">

    <intent-filter>
        <action android:name="net.bi4vmr.aidl.DOWNLOAD" />
    </intent-filter>
</service>
```

åœ¨ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº† `android:process=":service"` å±æ€§ï¼Œå› æ­¤DownloadServiceå°†ä¼šè¿è¡Œåœ¨åä¸º `<æœåŠ¡ç«¯åŒ…å>:service` çš„ç‹¬ç«‹è¿›ç¨‹ä¸­ï¼Œå³ä½¿æˆ‘ä»¬ä»æœåŠ¡ç«¯çš„é»˜è®¤è¿›ç¨‹ `<æœåŠ¡ç«¯åŒ…å>` ç»‘å®šè¯¥æœåŠ¡ï¼Œä¹Ÿå±äºè·¨è¿›ç¨‹é€šä¿¡ã€‚

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ç»‘å®šè¯¥æœåŠ¡ï¼Œå¹¶è°ƒç”¨AIDLæ¥å£ã€‚

å®¢æˆ·ç«¯è‹¥è¦è®¿é—®AIDLæ¥å£ï¼Œéœ€è¦èƒ½å¤Ÿå¼•ç”¨AIDLæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆçš„Javaç±»ã€‚æ­¤å¤„æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿è¿›è¡Œå®éªŒï¼Œç›´æ¥å°†AIDLæ–‡ä»¶ä»æœåŠ¡ç«¯å¤åˆ¶åˆ°å®¢æˆ·ç«¯å·¥ç¨‹ï¼Œå¹¶ä¿æŒç›¸åŒçš„ç›®å½•ç»“æ„ï¼Œç”±å®¢æˆ·ç«¯ç¼–è¯‘ç”ŸæˆJavaç±»ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†AIDLæ–‡ä»¶ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œç”±æœåŠ¡ç«¯ä¾èµ–è¯¥æ¨¡å—å¹¶å®ç°ä¸šåŠ¡æ¥å£é€»è¾‘ï¼Œç”±å®¢æˆ·ç«¯ä¾èµ–è¯¥æ¨¡å—å¹¶å®ç°ç»‘å®šã€è§£ç»‘ç­‰çŠ¶æ€ç®¡ç†ï¼Œç„¶åå°†å®¢æˆ·ç«¯ä½œä¸ºJARåŒ…æˆ–AARåŒ…å‘å¸ƒåˆ°Mavenä»“åº“ï¼›è°ƒç”¨è€…æ— éœ€å…³å¿ƒå®¢æˆ·ç«¯çš„å†…éƒ¨å®ç°ï¼Œåªéœ€é›†æˆå®¢æˆ·ç«¯SDKå³å¯è¿œç¨‹è°ƒç”¨æœåŠ¡ç«¯æä¾›çš„èƒ½åŠ›ã€‚

è¿œç¨‹æœåŠ¡çš„ä½¿ç”¨æ–¹æ³•ä¸æœ¬åœ°æœåŠ¡ç±»ä¼¼ï¼Œéƒ½éœ€è¦é€šè¿‡ `bindService()` æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå¹¶åœ¨ `onServiceConnected()`å›è°ƒä¸­è·å–IBinderå®ç°ç±»ï¼Œç„¶åè°ƒç”¨ä¸šåŠ¡æ¥å£ã€‚

"TestUIBase.java":

```java
public class TestUIBase extends AppCompatActivity {

    private final ServiceConnection connection = new DLServiceConnection();
    private IDownloadService downloadService;
    private boolean isServiceConnected = false;

    /**
     * æœåŠ¡è¿æ¥å›è°ƒå®ç°ç±»ã€‚
     */
    private class DLServiceConnection implements ServiceConnection {

        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            // ä½¿ç”¨StubæŠ½è±¡ç±»çš„ `asInterface()` æ–¹æ³•å°†Binderå¯¹è±¡è½¬æ¢ä¸ºå¯¹åº”çš„Serviceå¯¹è±¡ã€‚
            downloadService = IDownloadService.Stub.asInterface(service);
            // å°†è¿æ¥æ ‡è®°ä½ç½®ä¸º `true` ï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚
            isServiceConnected = true;
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            // å°†è¿æ¥æ ‡è®°ä½ç½®ä¸º `false`
            isServiceConnected = false;
            // å°†Serviceå®ä¾‹ç½®ç©º
            downloadService = null;
        }
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        /* ç»‘å®šæœåŠ¡ */
        Intent intent = new Intent();
        // è¿œç¨‹æœåŠ¡æ‰€åœ¨è½¯ä»¶åŒ…å
        intent.setPackage("net.bi4vmr.study.system.service.aidlserver");
        // è¿œç¨‹æœåŠ¡çš„Actionå‚æ•°
        intent.setAction("net.bi4vmr.aidl.DOWNLOAD");
        // ç»‘å®šæœåŠ¡
        boolean result = bindService(intent, connection, Context.BIND_AUTO_CREATE);
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"TestUIBaseKT.kt":

```kotlin
class TestUIBaseKT : AppCompatActivity() {

    private val connection: DLServiceConnection = DLServiceConnection()
    private var downloadService: IDownloadService? = null
    private var isServiceConnected: Boolean = false

    /**
     * æœåŠ¡è¿æ¥å›è°ƒå®ç°ç±»ã€‚
     */
    private inner class DLServiceConnection : ServiceConnection {

        override fun onServiceConnected(name: ComponentName, service: IBinder) {
            // ä½¿ç”¨StubæŠ½è±¡ç±»çš„ `asInterface()` æ–¹æ³•å°†Binderå¯¹è±¡è½¬æ¢ä¸ºå¯¹åº”çš„Serviceå¯¹è±¡ã€‚
            downloadService = IDownloadService.Stub.asInterface(service)
            // å°†è¿æ¥æ ‡è®°ä½ç½®ä¸º `true` ï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚
            isServiceConnected = true
        }

        override fun onServiceDisconnected(name: ComponentName) {
            // å°†è¿æ¥æ ‡è®°ä½ç½®ä¸º `false`
            isServiceConnected = false
            // å°†Serviceå®ä¾‹ç½®ç©º
            downloadService = null
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        /* ç»‘å®šæœåŠ¡ */
        val intent = Intent()
        // è¿œç¨‹æœåŠ¡æ‰€åœ¨è½¯ä»¶åŒ…å
        intent.setPackage("net.bi4vmr.study.system.service.aidlserver")
        // è¿œç¨‹æœåŠ¡çš„Actionå‚æ•°
        intent.setAction("net.bi4vmr.aidl.DOWNLOAD")
        // ç»‘å®šæœåŠ¡
        val result: Boolean = bindService(intent, connection, Context.BIND_AUTO_CREATE)
    }
}
```

AIDLç¼–è¯‘ç”Ÿæˆçš„Javaä»£ç ä¸­ï¼Œ `IDownloadService.Stub.asInterface()` æ–¹æ³•å¯ä»¥å°† `onServiceConnected()` å›è°ƒæ–¹æ³•ä¸­çš„ç¬¬äºŒå‚æ•° `service` è½¬æ¢ä¸ºIDownloadServiceç±»å‹ï¼Œæ–¹ä¾¿åç»­è°ƒç”¨ä¸šåŠ¡æ¥å£ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¾¿å¯é€šè¿‡ `downloadService` å®ä¾‹è°ƒç”¨æœåŠ¡ç«¯çš„ä¸šåŠ¡æ–¹æ³•ï¼Œæ­¤å¤„ä»¥ `addTask()` æ¥å£ä¸ºä¾‹ï¼š

"TestUIBase.java":

```java
public void testAddTask() {
    // æ ¹æ®è¿æ¥çŠ¶æ€æ ‡å¿—ä½å’ŒBinderçŠ¶æ€æ£€æµ‹ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè®¿é—®æ¥å£
    if (!isServiceConnected || !downloadService.asBinder().isBinderAlive()) {
        Log.i(TAG, "è¿æ¥æœªå°±ç»ªï¼");
        return;
    }

    try {
        String task = "https://test.net/1.txt";
        downloadService.addTask(task);
    } catch (RemoteException e) {
        e.printStackTrace();
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"TestUIBaseKT.kt":

```kotlin
private fun testAddTask() {
    // æ ¹æ®è¿æ¥çŠ¶æ€æ ‡å¿—ä½å’ŒBinderçŠ¶æ€æ£€æµ‹ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè®¿é—®æ¥å£
    if (!isServiceConnected || downloadService?.asBinder()?.isBinderAlive != true) {
        Log.i(TAG, "è¿æ¥æœªå°±ç»ªï¼")
        return
    }

    try {
        val task = "https://test.net/1.txt"
        requireNotNull(downloadService).addTask(task)
    } catch (e: RemoteException) {
        appendLog(e.message ?: "æœªçŸ¥é”™è¯¯ã€‚")
        e.printStackTrace()
    }
}
```

åœ¨çœŸæ­£æ‰§è¡Œè¿œç¨‹è°ƒç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ¤æ–­æœåŠ¡çš„è¿æ¥çŠ¶æ€æ˜¯å¦ä¸ºå°±ç»ªï¼Œå¹¶æ£€æµ‹æœåŠ¡ç«¯è¿›ç¨‹æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆé˜²æ­¢æœåŠ¡ç«¯è¿›ç¨‹å´©æºƒä½†è¿˜æ²¡æ¥å¾—åŠé€šçŸ¥å®¢æˆ·ç«¯ï¼‰ã€‚åœ¨è¿œç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¸šåŠ¡è‡ªèº«çš„å¼‚å¸¸ï¼Œè¿˜å¯èƒ½å‘ç”Ÿè¿œç¨‹è°ƒç”¨å¼‚å¸¸ï¼šRemoteExceptionï¼Œå› æ­¤æˆ‘ä»¬æœ€å¥½æ·»åŠ å¼‚å¸¸æ•è·è¯­å¥ã€‚


# è‡ªå®šä¹‰æ•°æ®ç±»å‹
Binderæ”¯æŒé€šè¿‡Parcelå®¹å™¨å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ä¼ è¾“ï¼Œå¯¹äºè‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå…¶å®ç°Parcelableæ¥å£ï¼Œéšåå³å¯åœ¨AIDLæ¥å£ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

å…³äºParcelableæ¥å£çš„çŸ¥è¯†è¯¦è§ç›¸å…³ç« èŠ‚ï¼š [ğŸ§­ Parcelableæ¥å£](../01_é€šç”¨ç»„ä»¶/05_Parcelableæ¥å£.md) ã€‚

ğŸŸ  ç¤ºä¾‹äºŒï¼šé€šè¿‡AIDLæ¥å£ä¼ é€’è‡ªå®šä¹‰ç±»å‹å¯¹è±¡ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»¥å‰æ–‡â€œç¤ºä¾‹ä¸€â€ä¸ºåŸºç¡€ï¼Œå°†è¡¨ç¤ºä¸‹è½½ä»»åŠ¡çš„æ•°æ®ç±»å‹ä»Stringæ”¹ä¸ºè‡ªå®šä¹‰ç±»å‹ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å®šä¹‰å®ä½“ç±»ï¼Œç”¨æ¥è¡¨ç¤ºä¸‹è½½ä»»åŠ¡ã€‚

"DownloadItem.java":

```java
public class DownloadItem implements Parcelable {

    // ä»»åŠ¡ID
    private int id;
    // ä¸‹è½½åœ°å€
    private String url;
    // è¿›åº¦
    private float percent;

    public static final Creator<DownloadItem> CREATOR = new Creator<DownloadItem>() {
        @Override
        public DownloadItem createFromParcel(Parcel in) {
            return new DownloadItem(in);
        }

        @Override
        public DownloadItem[] newArray(int size) {
            return new DownloadItem[size];
        }
    };

    // Parcelæ„é€ æ–¹æ³•
    protected DownloadItem(Parcel in) {
        // æŒ‰å±æ€§é¡ºåºä»Parcelå®¹å™¨ä¸­è¯»å‡ºå±æ€§å€¼
        id = in.readInt();
        url = in.readString();
        percent = in.readFloat();
    }

    @Override
    public int describeContents() {
        return 0;
    }

    @Override
    public void writeToParcel(Parcel dest, int flags) {
        // æŒ‰å±æ€§é¡ºåºå‘Parcelå®¹å™¨ä¸­å†™å…¥å±æ€§å€¼
        dest.writeInt(id);
        dest.writeString(url);
        dest.writeFloat(percent);
    }

    /* æ­¤å¤„çœç•¥Getã€Setä¸æ„é€ æ–¹æ³•... */
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"DownloadItemKT.kt":

```kotlin
data class DownloadItemKT(
    var id: Int,
    var url: String,
    var percent: Float
) : Parcelable {

    companion object CREATOR : Parcelable.Creator<DownloadItemKT> {
        override fun createFromParcel(parcel: Parcel): DownloadItemKT {
            return DownloadItemKT(parcel)
        }

        override fun newArray(size: Int): Array<DownloadItemKT?> {
            return arrayOfNulls(size)
        }
    }

    constructor(parcel: Parcel) : this(
        // æŒ‰å±æ€§é¡ºåºä»Parcelå®¹å™¨ä¸­è¯»å‡ºå±æ€§å€¼
        id = parcel.readInt(),
        url = parcel.readString() ?: "",
        percent = parcel.readFloat()
    )

    override fun describeContents(): Int {
        return 0
    }

    override fun writeToParcel(parcel: Parcel, flags: Int) {
        // æŒ‰å±æ€§é¡ºåºå‘Parcelå®¹å™¨ä¸­å†™å…¥å±æ€§å€¼
        parcel.apply {
            writeInt(id)
            writeString(url)
            writeFloat(percent)
        }
    }
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨AIDLæ¥å£ä¸­å°†DownloadItemåˆ†åˆ«ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼ã€‚

è‹¥è¦åœ¨AIDLæ¥å£ä¸­ä½¿ç”¨å®ç°äº†Parcelableæ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªAIDLæ–‡ä»¶æè¿°è¯¥ç±»å‹ã€‚

"DownloadItem.aidl":

```java
// è¯¥è·¯å¾„ä¸ºåŒåJavaç±»æ‰€åœ¨çš„åŒ…
package net.bi4vmr.study.types;

// å£°æ˜å…¶ç±»å‹ä¸ºParcelable
parcelable DownloadItem;
```

æ­¤å¤„çš„ `package` åŒ…åä¸ºåŒåJavaç±»æ‰€åœ¨è·¯å¾„ï¼Œ `parcelable` è¡¨ç¤ºéœ€è¦é€šè¿‡Parcelæ–¹å¼åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å…¶ä»–AIDLæ–‡ä»¶ä¸­å°†è¯¥ç±»å‹ä½œä¸ºå‚æ•°æˆ–è¿”å›å€¼ã€‚

"IDownloadService2.aidl":

```java
// è¯¥è·¯å¾„ä¸ºå¯¹åº”AIDLæ–‡ä»¶æ‰€åœ¨çš„åŒ…
import net.bi4vmr.aidl.entity.DownloadItem;

interface IDownloadService2 {

    // æ·»åŠ ä»»åŠ¡å¹¶å¼€å§‹ä¸‹è½½
    void addTask(in DownloadItem task);

    // è·å–ä»»åŠ¡åˆ—è¡¨
    List<DownloadItem> getTasks();
}
```

æ­¤å¤„çš„ `import` è¯­å¥åº”å½“æŒ‡å‘ `DownloadItem.aidl` åœ¨AIDLæºç é›†ä¸­çš„åŒ…åï¼Œè€Œé `DownloadItem.java` åœ¨Javaæºç é›†ä¸­çš„åŒ…åã€‚

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯åˆ†åˆ«æ‰§è¡Œä¸€æ¬¡Makeæˆ–Buildä»»åŠ¡ï¼Œç„¶åä¿®æ”¹æ¥å£å®ç°ï¼Œé€‚é…æ–°çš„æ•°æ®ç±»å‹ã€‚


# æ•°æ®æ–¹å‘æ ‡ç­¾
åœ¨å®šä¹‰AIDLæ¥å£æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºéƒ¨åˆ†å‚æ•°æŒ‡å®šä¸€ä¸ªæ•°æ®æ–¹å‘æ ‡ç­¾ï¼Œä¾‹å¦‚å‰æ–‡â€œç¤ºä¾‹äºŒâ€ä¸­çš„ `addTask(in DownloadItem task)` æ¥å£ã€‚è¯¥æ ‡ç­¾å¯ä»¥å–å€¼ä¸º `in` ã€ `out` æˆ– `inout` ï¼Œç”¨äºæ§åˆ¶ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´å‚æ•°çš„åŒæ­¥æƒ…å†µã€‚

ä¸ºäº†è¯´æ˜æ•°æ®æ–¹å‘æ ‡ç­¾çš„ä½œç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆå›é¡¾ä¸€ä¸‹Javaä¸­åŸºæœ¬æ•°æ®ç±»å‹ä¸å¼•ç”¨æ•°æ®ç±»å‹å‚æ•°ä¼ å€¼è¡Œä¸ºçš„å·®å¼‚ã€‚

ğŸŸ¡ ç¤ºä¾‹ä¸‰ï¼šåŸºæœ¬ä¸å¼•ç”¨æ•°æ®ç±»å‹å‚æ•°çš„åŒºåˆ«ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨æ–¹æ³•å†…éƒ¨åˆ†åˆ«ä¿®æ”¹åŸºæœ¬ä¸å¼•ç”¨æ•°æ®ç±»å‹å‚æ•°çš„å€¼ï¼Œå¹¶åœ¨æ–¹æ³•å¤–éƒ¨è§‚å¯Ÿå®ƒä»¬ã€‚

"TestDataTypes.java":

```java
public class TestDataTypes {

    public static void main(String[] args) {
        int num = 1;
        List<String> list = new ArrayList<>();
        list.add("a");
        System.out.println("åˆå§‹æƒ…å†µ - Numï¼š" + num);
        System.out.println("åˆå§‹æƒ…å†µ - Listï¼š" + list);

        // è°ƒç”¨æ–¹æ³•ä¿®æ”¹"num"å’Œ"list"çš„å€¼
        add(num, list);

        // æ–¹æ³•æ‰§è¡Œåï¼Œ"num"å’Œ"list"çš„å€¼ã€‚
        System.out.println("æ–¹æ³•å¤–éƒ¨ - Numï¼š" + num);
        System.out.println("æ–¹æ³•å¤–éƒ¨ - Listï¼š" + list);
    }

    static void add(int num, List<String> argList) {
        // æ”¹å˜å‚æ•°çš„å€¼ï¼ˆå‘åˆ—è¡¨ä¸­æ·»åŠ ä¸€é¡¹ï¼‰
        num += 1;
        // æ”¹å˜å‚æ•°çš„å€¼ï¼ˆå‘åˆ—è¡¨ä¸­æ·»åŠ ä¸€é¡¹ï¼‰
        argList.add("b");

        System.out.println("æ–¹æ³•å†…éƒ¨ - Numï¼š" + num);
        System.out.println("æ–¹æ³•å†…éƒ¨ - Listï¼š" + argList);
    }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
åˆå§‹æƒ…å†µ - Numï¼š1
åˆå§‹æƒ…å†µ - Listï¼š[a]
æ–¹æ³•å†…éƒ¨ - Numï¼š2
æ–¹æ³•å†…éƒ¨ - Listï¼š[a, b]
æ–¹æ³•å¤–éƒ¨ - Numï¼š1
æ–¹æ³•å¤–éƒ¨ - Listï¼š[a, b]
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

åœ¨ `add()` æ–¹æ³•å†…éƒ¨ä¿®æ”¹å˜é‡åï¼ŒåŸºæœ¬æ•°æ®ç±»å‹çš„åŸå§‹å˜é‡ `num` æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œè€Œå¼•ç”¨æ•°æ®ç±»å‹çš„åŸå§‹å˜é‡ `list` ä¹Ÿè¢«åŒæ­¥ä¿®æ”¹äº†ã€‚

å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹å˜é‡ï¼Œå…¶ä¸­å­˜å‚¨çš„æ˜¯å€¼æœ¬èº«ï¼Œä¼ é€’ç»™æ–¹æ³•æ—¶å°†ä¼šè¢«å¤åˆ¶ä¸ºä¸´æ—¶å˜é‡ï¼Œåœ¨æ–¹æ³•å†…éƒ¨ä¿®æ”¹ä¸´æ—¶å˜é‡ä¸å½±å“åŸå˜é‡ã€‚å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹å˜é‡ï¼Œå…¶ä¸­å­˜å‚¨çš„æ˜¯æŒ‡å‘å€¼å†…å­˜ç©ºé—´çš„åœ°å€ï¼Œä¼ é€’ç»™æ–¹æ³•æ—¶ä¸´æ—¶å˜é‡ä»ç„¶æŒ‡å‘åŒä¸€å†…å­˜åŒºåŸŸï¼Œå› æ­¤åœ¨æ–¹æ³•å†…éƒ¨ä¿®æ”¹ä¸´æ—¶å˜é‡ç­‰åŒäºä¿®æ”¹åŸå˜é‡ã€‚

ç”±äºAIDLæ˜¯è·¨è¿›ç¨‹çš„é€šä¿¡æœºåˆ¶ï¼ŒåŒä¸€ä¸ªå‚æ•°åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿›ç¨‹å„è‡ªæ‹¥æœ‰ä¸åŒçš„å†…å­˜åœ°å€ï¼Œè‹¥è¦ä¸ä¸Šè¿°ç¤ºä¾‹ä¸­çš„è¡Œä¸ºä¿æŒä¸€è‡´ï¼Œåœ¨æœåŠ¡ç«¯ä¿®æ”¹å‚æ•°ååŒæ­¥å˜åŒ–ç»™å®¢æˆ·ç«¯ï¼Œå°†ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½å¿…é¡»ä¿è¯ä¸¤ç«¯å‚æ•°çš„ä¸€è‡´æ€§ï¼Œå› æ­¤AIDLè®¾è®¡äº†æ–¹å‘æ ‡ç­¾ç”¨æ¥æ§åˆ¶åŒæ­¥æ–¹å¼ã€‚

ä¸‰ç§æ ‡ç­¾åŠå…¶å«ä¹‰å¦‚ä¸‹æ–‡å†…å®¹æ‰€ç¤ºï¼š

ğŸ”¶ `in` æ ‡ç­¾

å®¢æˆ·ç«¯å‚æ•°çš„å€¼å¯ä»¥ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œä½†å¦‚æœæœåŠ¡ç«¯æ›´æ”¹äº†æ­¤å‚æ•°ï¼Œå˜åŒ–ä¸ä¼šåŒæ­¥ç»™å®¢æˆ·ç«¯ã€‚

åœ¨å‰æ–‡â€œç¤ºä¾‹ä¸‰â€ä¸­ï¼Œå‡å¦‚æˆ‘ä»¬å®šä¹‰AIDLæ¥å£ `add(in List<String> list)` å¹¶é€šè¿‡å®¢æˆ·ç«¯è°ƒç”¨å®ƒï¼ŒæœåŠ¡ç«¯å°†ä¼šæ”¶åˆ°å†…å®¹ä¸º `[a]` çš„åˆ—è¡¨ã€‚å½“æœåŠ¡ç«¯å¯¹è¡¨é¡¹è¿›è¡Œå¢å‡ä¸”RPCè¿‡ç¨‹ç»“æŸåï¼Œå®¢æˆ·ç«¯åˆ—è¡¨å†…å®¹ä»ä¸º `[a]` ï¼Œä¸ä¼šåŒæ­¥å˜åŒ–ã€‚

`in` æ ‡ç­¾èƒ½å¤Ÿæ»¡è¶³ç»å¤§å¤šæ•°åœºæ™¯ï¼Œå› ä¸ºå®¢æˆ·ç«¯é€šå¸¸ä½¿ç”¨è¿”å›å€¼æˆ–å¼‚æ­¥å›è°ƒæ¥å£è·å–RPCç»“æœï¼Œè¿œç¨‹è°ƒç”¨å®Œæ¯•åä¸å†å…³å¿ƒå‚æ•°ã€‚

ğŸ”¶ `out` æ ‡ç­¾

å®¢æˆ·ç«¯å‚æ•°çš„å€¼ä¸ä¼šä¼ é€’ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å°†ä¼šæ”¶åˆ°ä¸€ä¸ªå€¼ä¸ºç©ºçš„å‚æ•°ï¼›å¦‚æœæœåŠ¡ç«¯æ›´æ”¹äº†æ­¤å‚æ•°çš„å€¼ï¼Œå˜åŒ–å°†ä¼šåŒæ­¥ç»™å®¢æˆ·ç«¯ã€‚

åœ¨å‰æ–‡â€œç¤ºä¾‹ä¸‰â€ä¸­ï¼Œå‡å¦‚æˆ‘ä»¬å®šä¹‰AIDLæ¥å£ `add(out List<String> list)` å¹¶é€šè¿‡å®¢æˆ·ç«¯è°ƒç”¨å®ƒï¼ŒæœåŠ¡ç«¯å°†ä¼šæ”¶åˆ°å†…å®¹ä¸ºç©ºçš„åˆ—è¡¨ã€‚å½“æœåŠ¡ç«¯å¯¹è¡¨é¡¹è¿›è¡Œå¢å‡ï¼ˆä¾‹å¦‚æ–°å¢ä¸€ä¸ªè¡¨é¡¹ `b` ï¼‰ä¸”RPCè¿‡ç¨‹ç»“æŸåï¼Œå®¢æˆ·ç«¯åˆ—è¡¨å†…å®¹ä¹Ÿå°†åŒæ­¥å˜æ›´ä¸º `[a, b]` ã€‚

`out` æ ‡ç­¾çš„é€‚ç”¨åœºæ™¯æ¯”è¾ƒå°‘ï¼Œä¾‹å¦‚ï¼šRPCç»“æœéœ€è¦ä½¿ç”¨å¤šç§æ•°æ®ç±»å‹è¡¨ç¤ºï¼Œä¸”æ¥å£æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œå®šä¹‰é¢å¤–çš„å›è°ƒæ¥å£æ¯”è¾ƒç¹çï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å‚æ•°è·å–RPCç»“æœã€‚

ğŸ”¶ `inout` æ ‡ç­¾

å®¢æˆ·ç«¯å‚æ•°çš„å€¼å¯ä»¥ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œå¹¶ä¸”æœåŠ¡ç«¯å¯¹å‚æ•°çš„ä¿®æ”¹ä¹Ÿä¼šåœ¨RPCç»“æŸååŒæ­¥ç»™å®¢æˆ·ç«¯ã€‚

åœ¨å‰æ–‡â€œç¤ºä¾‹ä¸‰â€ä¸­ï¼Œå‡å¦‚æˆ‘ä»¬å®šä¹‰AIDLæ¥å£ `add(inout List<String> list)` å¹¶é€šè¿‡å®¢æˆ·ç«¯è°ƒç”¨å®ƒï¼ŒæœåŠ¡ç«¯å°†ä¼šæ”¶åˆ°å†…å®¹ä¸º `[a]` çš„åˆ—è¡¨ï¼Œå½“æœåŠ¡ç«¯å¯¹è¡¨é¡¹è¿›è¡Œå¢å‡ä¸”RPCè¿‡ç¨‹ç»“æŸåï¼Œå®¢æˆ·ç«¯åˆ—è¡¨å†…å®¹ä¹Ÿå°†åŒæ­¥å˜æ›´ä¸º `[a, b]` ï¼Œæ­¤æ—¶RPCè¡Œä¸ºä¸æœ¬åœ°æ–¹æ³•è°ƒç”¨æ˜¯ä¸€è‡´çš„ï¼Œä½†æ€§èƒ½æœ€ä½ã€‚

`inout` æ ‡ç­¾çš„é€‚ç”¨åœºæ™¯éå¸¸ç½•è§ï¼Œä¾‹å¦‚ï¼šRPCç»“æœä»¥è¾“å…¥å‚æ•°ä¸ºåŸºç¡€è¿½åŠ å†…å®¹ï¼Œä¸ä¼šåˆ æ”¹å·²æœ‰çš„å†…å®¹ï¼Œæ­¤æ—¶åˆ©ç”¨æœåŠ¡ç«¯ç›´æ¥ä¿®æ”¹å˜é‡å¹¶åŒæ­¥ç»™å®¢æˆ·ç«¯æ›´ä¸ºåˆé€‚ï¼Œç›¸æ¯”é€šè¿‡è¿”å›å€¼è·å–ç»“æœå‡å°‘äº†ä¸´æ—¶å˜é‡ä¸å†—ä½™ä»£ç ã€‚

<br />

å…³äºæ•°æ®æ–¹å‘æ ‡ç­¾çš„æ›´å¤šé™åˆ¶æ¡ä»¶ä¸æ³¨æ„äº‹é¡¹è¯¦è§ä¸‹æ–‡å†…å®¹ï¼š

> ğŸš© æç¤º
>
> åŸºæœ¬æ•°æ®ç±»å‹å‚æ•°åªèƒ½è¢« `in` ä¿®é¥°ï¼Œå› ä¸ºå®ƒä»¬å­˜å‚¨çš„ä¸æ˜¯å†…å­˜åœ°å€å¼•ç”¨ï¼Œä¼ å‚åå†…å®¹æ— æ³•ä¸åŸå§‹å˜é‡ä¿æŒåŒæ­¥ã€‚

> ğŸš© æç¤º
>
> RPCéµå¾ªçº¿ç¨‹å°é—­åŸåˆ™ï¼Œè°ƒç”¨å¼€å§‹åå®¢æˆ·ç«¯å†ä¿®æ”¹ `in` ç±»å‹å‚æ•°ä¸ä¼šå½±å“æœåŠ¡ç«¯ï¼Œè°ƒç”¨ç»“æŸå‰å®¢æˆ·ç«¯ä¹Ÿè¯»å–ä¸åˆ°æœåŠ¡ç«¯å¯¹ `out` ç±»å‹å‚æ•°çš„ä»»ä½•ä¿®æ”¹ã€‚
>
> å…³äºâ€œçº¿ç¨‹å°é—­â€çš„ç›¸å…³æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š [ğŸ”— â€œçº¿ç¨‹å°é—­â€çš„ç›¸å…³æ¦‚å¿µ](https://www.cnblogs.com/binghe001/p/12808419.html) ã€‚

> ğŸš© æç¤º
>
> `out` æ ‡ç­¾åªå¯¹å½“å‰RPCè°ƒç”¨è¿‡ç¨‹ç”Ÿæ•ˆï¼Œè‹¥æœåŠ¡ç«¯æ”¶åˆ°è°ƒç”¨è¯·æ±‚åæ–°å»ºçº¿ç¨‹å†™å…¥å˜é‡ï¼Œå®¢æˆ·ç«¯ä¸ä¼šè¯»å–åˆ°è¯¥å€¼ï¼Œå› ä¸ºæ•°æ®åŒæ­¥åªåœ¨è°ƒç”¨ç»“æŸçš„ç¬é—´æ‰§è¡Œï¼Œæ­¤åæ–°çº¿ç¨‹å†…å¯¹å˜é‡æ‰€åšçš„ä¿®æ”¹ä¸ä¼šå†åŒæ­¥ç»™å®¢æˆ·ç«¯ã€‚

> ğŸš© æç¤º
>
> ä½¿ç”¨ `out` æˆ– `inout` æ ‡ç­¾ä¿®é¥°è‡ªå®šä¹‰ç±»å‹æ—¶ï¼Œå¿…é¡»ä¸ºè¯¥ç±»æ·»åŠ  `void readFromParcel(Parcel in)` æ–¹æ³•ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯ä»æœåŠ¡ç«¯è¯»å–æ•°æ®ï¼Œå¦åˆ™ç¼–è¯‘è¿‡ç¨‹ä¸­å°†ä¼šå‡ºç°é”™è¯¯ã€‚
>
> æ­¤å¤„ä»¥â€œç¤ºä¾‹äºŒâ€ä¸­çš„DownloadItemä¸ºä¾‹ï¼Œå®ƒçš„ `readFromParcel()` æ–¹æ³•åº”å½“å†™ä½œï¼š
>
> "DownloadItem.java":
>
> ```java
> public void readFromParcel(Parcel in) {
>     id = in.readInt();
>     url = in.readString();
>     percent = in.readFloat();
> }
> ```
>
> ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š
>
> "DownloadItemKT.kt":
>
> ```kotlin
> fun readFromParcel(parcel: Parcel) {
>     id = parcel.readInt()
>     url = parcel.readString() ?: ""
>     percent = parcel.readFloat()
> }
> ```
> &nbsp;


# çº¿ç¨‹è°ƒåº¦
AIDLè¿œç¨‹æ¥å£ä¸æœ¬åœ°æ–¹æ³•çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ï¼Œé»˜è®¤ä¸ºåŒæ­¥è°ƒç”¨ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ¥å£åï¼Œå®¢æˆ·ç«¯çº¿ç¨‹å°†ä¼šæŒç»­é˜»å¡ï¼Œç›´åˆ°æœåŠ¡ç«¯æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå®¢æˆ·ç«¯çº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œã€‚

å½“AIDLé˜»å¡å®¢æˆ·ç«¯çº¿ç¨‹æ—¶ï¼Œæ‰€é‡‡ç”¨çš„æ˜¯Linuxç³»ç»Ÿå‡½æ•° `wait_event_interruptible()` ï¼Œæ­¤æ—¶çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œä¸ä¼šå ç”¨CPUèµ„æºã€‚å®¢æˆ·ç«¯å¯èƒ½ä¼šä»UIçº¿ç¨‹å‘èµ·è°ƒç”¨ï¼Œé•¿æ—¶é—´é˜»å¡UIçº¿ç¨‹å°†ä¼šå¯¼è‡´å®¢æˆ·ç«¯å‡ºç°ANRï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦åœ¨å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯å¼€å¯å­çº¿ç¨‹å¤„ç†è€—æ—¶ä¸šåŠ¡ã€‚

å¦‚æœæˆ‘ä»¬åœ¨æœåŠ¡ç«¯å¼€å¯å­çº¿ç¨‹å¤„ç†ä¸šåŠ¡ï¼Œå°±æ— æ³•é€šè¿‡ `out` ç±»å‹å‚æ•°æˆ–è¿”å›å€¼å›ä¼ ç»“æœäº†ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨å›è°ƒæœºåˆ¶ã€‚

ğŸŸ¢ ç¤ºä¾‹å››ï¼šåœ¨AIDLä¸­å®ç°å›è°ƒæœºåˆ¶ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»¥å‰æ–‡â€œç¤ºä¾‹äºŒâ€ä¸ºåŸºç¡€ï¼Œå°†ä¸‹è½½æœåŠ¡æ”¹ä¸ºå¼‚æ­¥å®ç°ï¼Œå¹¶é€šè¿‡å›è°ƒæ–¹æ³•é€šçŸ¥å®¢æˆ·ç«¯è¿›åº¦å˜æ›´ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨AIDLç›®å½•ä¸­å®šä¹‰TaskCallbackå›è°ƒæ¥å£ã€‚

"TaskCallback.aidl":

```java
package net.bi4vmr.aidl.callback;

import net.bi4vmr.aidl.entity.DownloadItem;

interface TaskCallback {

    // è¿›åº¦æ”¹å˜äº‹ä»¶
    void onStateChanged(in DownloadItem item);
}
```

æ­¤å¤„çš„ `onStateChanged()` æ–¹æ³•ä½œä¸ºå›è°ƒæ–¹æ³•ï¼Œç”±å®¢æˆ·ç«¯æä¾›å®ç°ï¼ŒæœåŠ¡ç«¯åœ¨ä¸‹è½½è¿›åº¦æ›´æ–°æ—¶è¿›è¡Œè°ƒç”¨ï¼Œé€šçŸ¥å®¢æˆ·ç«¯è¿›åº¦å˜åŒ–ã€‚

é€šå¸¸å›è°ƒæ–¹æ³•ä¸­çš„å¼•ç”¨ç±»å‹å‚æ•°éƒ½ä¼šè¢« `in` ä¿®é¥°ï¼Œæ­¤åœºæ™¯ä¸­ç”±æœåŠ¡ç«¯è°ƒç”¨å®¢æˆ·ç«¯æä¾›çš„æ¥å£ï¼Œå‚æ•°ç”±æœåŠ¡ç«¯ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼ŒäºŒè€…èº«ä»½å‘ç”Ÿäº†äº’æ¢ã€‚

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨ä¸‹è½½æœåŠ¡çš„AIDLæ–‡ä»¶ä¸­ä½¿ç”¨TaskCallbackæ¥å£ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›æ³¨å†Œå›è°ƒçš„æ–¹æ³•ã€‚

"IDownloadService3.aidl":

```java
import net.bi4vmr.aidl.entity.DownloadItem;
import net.bi4vmr.aidl.callback.TaskCallback;

interface IDownloadService3 {

    // æ³¨å†ŒçŠ¶æ€å›è°ƒ
    void setTaskCallback(in TaskCallback cb);

    // æ·»åŠ ä»»åŠ¡å¹¶å¼€å§‹ä¸‹è½½
    void addTask(in DownloadItem task);
}
```

å›è°ƒæ¥å£æ˜¯ä¸€ç§å¼•ç”¨ç±»å‹ï¼Œå› æ­¤åœ¨å…¶ä»–AIDLæ–‡ä»¶ä¸­ä½¿ç”¨å‰éœ€è¦è¿›è¡Œå¯¼å…¥ï¼ŒåŒ…åä¸ºå›è°ƒæ¥å£AIDLæ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ã€‚

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬ç¼–å†™æœåŠ¡ç«¯ï¼Œå®ç°AIDLæ–‡ä»¶ä¸­çš„æ¥å£ã€‚

"DownloadService3.java":

```java
private static class ServiceImpl extends IDownloadService3.Stub {

    // å›è°ƒæ¥å£å®ç°ï¼Œç”¨äºå‘å®¢æˆ·ç«¯åé¦ˆç»“æœã€‚
    private TaskCallback callback;

    // å®¢æˆ·ç«¯æ³¨å†Œå›è°ƒæ¥å£
    @Override
    public void setTaskCallback(TaskCallback cb) {
        callback = cb;
    }

    // æ·»åŠ ä¸‹è½½ä»»åŠ¡
    @Override
    public void addTask(DownloadItem item) {
        Log.d(TAG, "AddTask.");

        // åˆ›å»ºæ–°çº¿ç¨‹æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
        new Thread(() -> {
            final float TOTAL = 100.0F;
            int length = 0;

            try {
                Log.d(TAG, "å¼€å§‹ä¸‹è½½:" + item.getUrl());
                while (length < TOTAL) {
                    length += 10;
                    // æ›´æ–°è¿›åº¦
                    item.setPercent((length / TOTAL) * 100);
                    // å¹¶é€šè¿‡å›è°ƒé€šçŸ¥å®¢æˆ·ç«¯
                    if (callback != null) {
                        callback.onStateChanged(item);
                    }
                    // ä¼‘çœ 1ç§’ï¼Œæ¨¡æ‹Ÿè€—æ—¶æ“ä½œã€‚
                    Thread.sleep(1000);
                }
                Log.d(TAG, "ä¸‹è½½å®Œæˆã€‚");
            } catch (InterruptedException e) {
                Log.w(TAG, "ä»»åŠ¡ç»ˆæ­¢ã€‚");
            } catch (RemoteException e) {
                Log.e(TAG, "å‘ç”Ÿè¿œç¨‹è°ƒç”¨é”™è¯¯ï¼");
            }
        }).start();
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"DownloadService3KT.kt":

```kotlin
private inner class DownloadImpl : IDownloadService3KT.Stub() {

    // å›è°ƒæ¥å£å®ç°ï¼Œç”¨äºå‘å®¢æˆ·ç«¯åé¦ˆç»“æœã€‚
    private var callback: TaskCallbackKT? = null

    // å®¢æˆ·ç«¯æ³¨å†Œå›è°ƒæ¥å£
    override fun setTaskCallback(cb: TaskCallbackKT) {
        Log.d(TAG, "SetTaskCallback.")
        callback = cb
    }

    // æ·»åŠ ä¸‹è½½ä»»åŠ¡
    override fun addTask(item: DownloadItemKT) {
        Log.d(TAG, "AddTask.")

        // åˆ›å»ºæ–°çº¿ç¨‹æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
        thread {
            val total = 100.0F
            var length = 0
            try {
                Log.i(TAG, "å¼€å§‹ä¸‹è½½:" + item.url)
                while (length < total) {
                    length += 10
                    // æ›´æ–°è¿›åº¦
                    item.percent = (length / total) * 100
                    // å¹¶é€šè¿‡å›è°ƒé€šçŸ¥å®¢æˆ·ç«¯
                    callback?.onStateChanged(item)
                    // ä¼‘çœ 1ç§’ï¼Œæ¨¡æ‹Ÿè€—æ—¶æ“ä½œã€‚
                    Thread.sleep(1000)
                }
                Log.i(TAG, "ä¸‹è½½å®Œæˆã€‚")
            } catch (e: InterruptedException) {
                Log.w(TAG, "ä»»åŠ¡ç»ˆæ­¢ã€‚")
            } catch (e: RemoteException) {
                Log.e(TAG, "å‘ç”Ÿè¿œç¨‹è°ƒç”¨é”™è¯¯ï¼")
            }
        }
    }
}
```

TaskCallbackä¼šè¢«Gradleç¼–è¯‘ä¸ºJavaæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ã€‚

ç¬¬å››æ­¥ï¼Œæˆ‘ä»¬ç¼–å†™å®¢æˆ·ç«¯ï¼Œæ³¨å†Œå›è°ƒç›‘å¬ä¸‹è½½è¿›åº¦å˜åŒ–ã€‚

"TestUIThreads.java":

```java
@Override
public void onServiceConnected(ComponentName name, IBinder service) {
    // è¿æ¥æˆåŠŸï¼Œè·å–Serviceå®ç°å¯¹è±¡ï¼Œæ­¤å¤„çœç•¥ç›¸å…³ä»£ç ã€‚

    // è®¾ç½®å›è°ƒä»¥ç›‘å¬æœåŠ¡ç«¯çš„äº‹ä»¶
    try {
        downloadService.setTaskCallback(new TaskCallback.Stub() {
            @Override
            public void onStateChanged(DownloadItem item) {
                Log.i(TAG, "OnStateChanged. Item:[" + item + "]");
            }
        });
    } catch (RemoteException e) {
        e.printStackTrace();
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"TestUIThreadsKT.kt":

```kotlin
override fun onServiceConnected(name: ComponentName, service: IBinder) {
    // è¿æ¥æˆåŠŸï¼Œè·å–Serviceå®ç°å¯¹è±¡ï¼Œæ­¤å¤„çœç•¥ç›¸å…³ä»£ç ã€‚

    // è®¾ç½®å›è°ƒä»¥ç›‘å¬æœåŠ¡ç«¯çš„äº‹ä»¶
    runCatching {
        requireNotNull(downloadService).setTaskCallback(object : TaskCallbackKT.Stub() {
            override fun onStateChanged(item: DownloadItemKT) {
                Log.i(TAG, "OnStateChanged. Item:[$item]")
            }
        })
    }.onFailure { it.printStackTrace() }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
11:36:55.811  2774  2774 I Client: --- æ·»åŠ ä»»åŠ¡ ---
11:36:55.812  3280  3328 D Server: AddTask.
11:36:55.812  3280  4482 I Server: å¼€å§‹ä¸‹è½½:https://test.net/1.txt
11:36:55.813  2774  2787 I Client: OnStateChanged. Item:[DownloadItem{id=0, url='https://test.net/1.txt', percent=10.0}]
11:36:56.813  2774  3129 I Client: OnStateChanged. Item:[DownloadItem{id=0, url='https://test.net/1.txt', percent=20.0}]

# æ­¤å¤„å·²çœç•¥éƒ¨åˆ†è¾“å‡ºå†…å®¹...

11:37:04.821  2774  3129 I Client: OnStateChanged. Item:[DownloadItem{id=0, url='https://test.net/1.txt', percent=100.0}]
11:37:05.822  3280  4482 I Server: ä¸‹è½½å®Œæˆã€‚
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

æœåŠ¡ç«¯å›è°ƒå®¢æˆ·ç«¯æ–¹æ³•æ—¶ï¼Œæ‰€ä½¿ç”¨çš„çº¿ç¨‹æ˜¯éšæœºåˆ†é…çš„ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æ›´æ–°ç•Œé¢ï¼Œå¿…é¡»æ˜ç¡®åœ°åˆ‡æ¢åˆ°UIçº¿ç¨‹å†æ‰§è¡Œæ“ä½œã€‚

AIDLæ¥å£ä¸­çš„æ–¹æ³•å¯ä»¥è¢« `oneway` å…³é”®å­—ä¿®é¥°ï¼Œè¿™ç§æ–¹æ³•å°†ä¼šæˆä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å‘èµ·è°ƒç”¨åç«‹åˆ»è¿”å›ï¼Œå…¶çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼ŒBinderé©±åŠ¨å°†ä½¿ç”¨è‡ªèº«çš„çº¿ç¨‹æ± åœ¨æœåŠ¡ç«¯æ‰§è¡Œä»»åŠ¡ã€‚ä¸€ä¸ªæ–¹æ³•è¢«è®¾ä¸º `oneway` åï¼Œå…¶å‚æ•°çš„æ ‡ç­¾åªèƒ½æ˜¯ `in` ï¼Œå¹¶ä¸”è¿”å›å€¼åªèƒ½æ˜¯ `void` ã€‚

`oneway` æ–¹æ³•å…·æœ‰é˜Ÿåˆ—åŠŸèƒ½ï¼ŒåŒä¸€ä¸ªBinderå¯¹è±¡åŒæ—¶åªèƒ½æ‰§è¡Œå…¶ä¸­çš„ä¸€ä¸ª `oneway` æ–¹æ³•ï¼Œå…¶ä»– `oneway` æ–¹æ³•å°†åœ¨å‰ä¸€ä¸ª `oneway` æ–¹æ³•æ‰§è¡Œå®Œæ¯•åå¾—åˆ°è°ƒåº¦ã€‚Binderé˜Ÿåˆ—ä¸­çš„æ–¹æ³•è™½ç„¶æ²¡æœ‰å¼€å§‹æ‰§è¡Œï¼Œä½†æ˜¯å·²ç»ç”³è¯·åˆ°äº†Bufferèµ„æºï¼Œå› æ­¤å¦‚æœæŸä¸ªæ¥å£å†…çš„å¼‚æ­¥æ–¹æ³•è°ƒç”¨é¢‘ç¹ä¸”è€—æ—¶ï¼Œå°†ä¼šå¯¼è‡´ç¼“å­˜æº¢å‡ºä¸è°ƒç”¨å¤±è´¥ï¼Œæ­¤ç±»æ–¹æ³•ä¸é€‚åˆä½¿ç”¨ `oneway` æ–¹å¼è¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œåº”å½“ç”±å®¢æˆ·ç«¯è‡ªè¡Œåˆ›å»ºå­çº¿ç¨‹å¤„ç†ã€‚

> âš ï¸ è­¦å‘Š
>
> `oneway` æ–¹æ³•åªå¯¹è¿œç¨‹è°ƒç”¨æœ‰æ•ˆï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œè¿™ç§æœ¬åœ°è°ƒç”¨ä»ç„¶æ˜¯åŒæ­¥çš„ï¼Œä¼šé˜»å¡å®¢æˆ·ç«¯çº¿ç¨‹ã€‚

ğŸ”µ ç¤ºä¾‹äº”ï¼šåœ¨AIDLä¸­ä½¿ç”¨ `oneway` å…³é”®å­—ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»¥å‰æ–‡â€œç¤ºä¾‹å››â€ä¸ºåŸºç¡€ï¼Œå°† `addTask()` æ–¹æ³•æ”¹ä¸º `oneway` æ–¹æ³•ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨AIDLæ–‡ä»¶ä¸­æ·»åŠ æ¥å£å®šä¹‰ï¼Œåœ¨æ–¹æ³•å‰åŠ ä¸Š `oneway` å…³é”®å­—ã€‚

"IDownloadService3.aidl":

```java
interface IDownloadService3 {

    // æ·»åŠ ä»»åŠ¡å¹¶å¼€å§‹ä¸‹è½½ï¼ˆAIDLå¼‚æ­¥æ–¹æ³•ï¼‰
    oneway void addTaskOneway(in DownloadItem task);
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬ç¼–å†™æœåŠ¡ç«¯ï¼Œå®ç°AIDLæ–‡ä»¶ä¸­çš„æ¥å£ã€‚

"DownloadService3.java":

```java
@Override
public void addTaskOneway(DownloadItem item) {
    Log.d(TAG, "AddTaskOneway.");

    final float TOTAL = 100.0F;
    int length = 0;

    try {
        Log.d(TAG, "å¼€å§‹ä¸‹è½½:" + item.getUrl());
        while (length < TOTAL) {
            length += 10;
            // è®¾ç½®è¿›åº¦å¹¶é€šè¿‡å›è°ƒé€šçŸ¥å®¢æˆ·ç«¯
            item.setPercent((length / TOTAL) * 100);
            callback.onStateChanged(item);
            // ä¼‘çœ 1ç§’ï¼Œæ¨¡æ‹Ÿè€—æ—¶æ“ä½œã€‚
            Thread.sleep(1000);
        }
        Log.d(TAG, "ä¸‹è½½å®Œæˆã€‚");
    } catch (InterruptedException e) {
        Log.w(TAG, "ä»»åŠ¡ç»ˆæ­¢ã€‚");
    } catch (RemoteException e) {
        Log.e(TAG, "å‘ç”Ÿè¿œç¨‹é”™è¯¯ï¼");
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"DownloadService3KT.kt":

```kotlin
override fun addTaskOneway(item: DownloadItemKT) {
    Log.d(TAG, "AddTaskOneway.")

    val total = 100.0F
    var length = 0
    try {
        Log.d(TAG, "å¼€å§‹ä¸‹è½½:" + item.url)
        while (length < total) {
            length += 10
            // æ›´æ–°è¿›åº¦
            item.percent = (length / total) * 100
            // å¹¶é€šè¿‡å›è°ƒé€šçŸ¥å®¢æˆ·ç«¯
            callback?.onStateChanged(item)
            // ä¼‘çœ 1ç§’ï¼Œæ¨¡æ‹Ÿè€—æ—¶æ“ä½œã€‚
            Thread.sleep(1000)
        }
        Log.d(TAG, "ä¸‹è½½å®Œæˆã€‚")
    } catch (e: InterruptedException) {
        Log.w(TAG, "ä»»åŠ¡ç»ˆæ­¢ã€‚")
    } catch (e: RemoteException) {
        Log.e(TAG, "å‘ç”Ÿè¿œç¨‹è°ƒç”¨é”™è¯¯ï¼")
    }
}
```

ä¸â€œç¤ºä¾‹å››â€ä¸­çš„ `addTask()` æ–¹æ³•ç›¸æ¯”ï¼Œæˆ‘ä»¬ç§»é™¤äº†å¼€å¯æ–°çº¿ç¨‹çš„è¯­å¥ï¼Œå› ä¸º `oneway` æ–¹æ³•ä¼šç”±Binderåˆ†é…æ–°çš„çº¿ç¨‹ï¼Œæ²¡å¿…è¦å†æ‰‹åŠ¨å¼€å¯æ–°çº¿ç¨‹ã€‚

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
11:45:22.048 13760 13760 I Client: --- æ·»åŠ ä»»åŠ¡ï¼ˆAIDLå¼‚æ­¥æ–¹æ³•ï¼‰ ---
11:45:22.049 15500 15516 D Server: AddTaskOneway.
11:45:22.049 15500 15516 D Server: å¼€å§‹ä¸‹è½½:https://test.net/1.txt
11:45:22.050 13760 13777 I Client: OnStateChanged. Item:[DownloadItem{id=0, url='https://test.net/1.txt', percent=10.0}]
11:45:23.051 13760 15591 I Client: OnStateChanged. Item:[DownloadItem{id=0, url='https://test.net/1.txt', percent=20.0}]

# æ­¤å¤„å·²çœç•¥éƒ¨åˆ†è¾“å‡ºå†…å®¹...

11:45:31.061 13760 15591 I Client: OnStateChanged. Item:[DownloadItem{id=0, url='https://test.net/1.txt', percent=100.0}]
11:45:32.061 15500 15516 D Server: ä¸‹è½½å®Œæˆã€‚
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

`13760` æ˜¯å®¢æˆ·ç«¯çš„UIçº¿ç¨‹ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®å‘èµ·ä»»åŠ¡åï¼ŒUIå¹¶æ²¡æœ‰å› çº¿ç¨‹è¢«é˜»å¡è€Œå¡ä½ï¼›æœåŠ¡ç«¯ä½¿ç”¨Binderé©±åŠ¨åˆ†é…çš„çº¿ç¨‹ `15516` æ‰§è¡Œæ“ä½œï¼Œå¹¶é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„å›è°ƒæ–¹æ³•é€šçŸ¥å®¢æˆ·ç«¯ä»»åŠ¡è¿›åº¦ã€‚


# å¼‚å¸¸å¤„ç†
å½“è¿œç¨‹è°ƒç”¨åœ¨æœåŠ¡ç«¯å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œåªæœ‰éƒ¨åˆ†ç±»å‹çš„å¼‚å¸¸èƒ½å¤Ÿä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä»¬å¦‚ä¸‹æ–‡åˆ—è¡¨æ‰€ç¤ºï¼š

- NullPointerException
- BadParcelableException
- IllegalArgumentException
- IllegalStateException
- SecurityException
- NetworkOnMainThreadException
- UnsupportedOperationException
- ServiceSpecificException

Binderé©±åŠ¨é€šè¿‡Parcelå®¹å™¨å‘å®¢æˆ·ç«¯ä¼ é€’è°ƒç”¨ç»“æœæ—¶ï¼Œæ•°æ®æ ¼å¼ä¸º `å¼‚å¸¸ä»£ç  + è¿”å›å†…å®¹` ï¼Œå¼‚å¸¸ä»£ç ä¸º `0` æ—¶è¡¨ç¤ºæ— é”™è¯¯å‘ç”Ÿï¼Œè¿”å›å†…å®¹å³ä¸ºè¿”å›å€¼ï¼›å¼‚å¸¸ä»£ç ä¸ºé `0` æ—¶è¡¨ç¤ºå‡ºç°å¼‚å¸¸ï¼Œå¦‚æœå¼‚å¸¸åœ¨å‰æ–‡åˆ—è¡¨ä¸­ï¼Œä¼šåœ¨å®¢æˆ·ç«¯æŠ›å‡ºï¼Œå¦‚æœå¼‚å¸¸ä¸åœ¨å‰æ–‡åˆ—è¡¨ä¸­ï¼Œåˆ™ä¼šå‘å®¢æˆ·ç«¯è¿”å›é»˜è®¤å€¼ã€‚

å½“è¿œç¨‹è°ƒç”¨å‡ºç°ä¸å¯ä¼ é€’å¼‚å¸¸æ—¶ï¼Œå¯¹äºåŸºæœ¬æ•°æ®ç±»å‹çš„è¿”å›å€¼ï¼Œå®¢æˆ·ç«¯å°†ä¼šè¯»åˆ°è¯¥ç±»å‹çš„é»˜è®¤å€¼ï¼›å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹ï¼Œå®¢æˆ·ç«¯å°†ä¼šè¯»åˆ°ç©ºå€¼ï¼›å¯¹äºé›†åˆï¼Œå®¢æˆ·ç«¯å°†ä¼šè¯»åˆ°å†…å®¹ä¸ºç©ºçš„é›†åˆã€‚ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ä¸­åº”å½“å¯¹è¿œç¨‹æ–¹æ³•çš„è¿”å›å€¼è¿›è¡Œåˆ¤æ–­ï¼Œé˜²æ­¢æ— æ•ˆå€¼æˆ–NPEè¿›è€Œå¯¼è‡´å…¶ä»–é—®é¢˜ã€‚

ğŸŸ£ ç¤ºä¾‹å…­ï¼šè§‚å¯ŸAIDLæ¥å£çš„é»˜è®¤å¼‚å¸¸è¡Œä¸ºã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ `int divide(int a, int b)` æ¥å£ï¼Œåœ¨æœåŠ¡ç«¯è¿”å› `a / b` çš„è®¡ç®—ç»“æœï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ä¼ å…¥ `100 / 0` ï¼Œè§‚å¯ŸRPCç»“æœã€‚

å½“æˆ‘ä»¬ä»å®¢æˆ·ç«¯è°ƒç”¨ `divide()` æ–¹æ³•æ—¶ï¼ŒAIDLä¸èƒ½ä¼ é€’ArithmeticExceptionï¼Œå› æ­¤Binderå°†ä¼šæ‰“å° `Uncaught remote exception!` æ—¥å¿—ï¼ŒåŒæ—¶å‘å®¢æˆ·ç«¯è¿”å›é»˜è®¤å€¼ã€‚

```text
# å®¢æˆ·ç«¯å¼€å§‹RPCè°ƒç”¨
16:25:32.160 13760 13760 I Client: --- è®¡ç®—é™¤æ³• ---

# æœåŠ¡ç«¯è¿›ç¨‹æŠ›å‡ºå¼‚å¸¸
16:25:32.162 15500 15516 I JavaBinder: *** Uncaught remote exception!  (Exceptions are not yet supported across processes.)
                                       java.lang.ArithmeticException: divide by zero
                                          at net.bi4vmr.study.exceptions.ExceptionTestService$ServiceImpl.divide(ExceptionTestService.java:32)
                                          at net.bi4vmr.aidl.IExceptions$Stub.onTransact(IExceptions.java:72)
                                          at android.os.Binder.execTransactInternal(Binder.java:1280)

# å®¢æˆ·ç«¯è¿›ç¨‹è¯»å–åˆ°äº†é»˜è®¤å€¼
16:25:32.164 13760 13760 I Client: è®¡ç®—ç»“æœï¼š0
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

å› ä¸º `divide()` æ–¹æ³•çš„è¿”å›å€¼æ˜¯ `int` ç±»å‹ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è¯»å–åˆ°çš„é»˜è®¤å€¼æ˜¯ `0` ã€‚

`100 / 0` è¿”å›å€¼ä¸º `0` æ˜¾ç¤ºæ˜¯ä¸åˆç†çš„ï¼Œå¯¹äºæ­¤ç±»éœ€è¦é€ä¼ å¼‚å¸¸ç»™å®¢æˆ·ç«¯çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡ç«¯æ•è·åŸå§‹å¼‚å¸¸ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºAIDLæ”¯æŒçš„å¼‚å¸¸ï¼Œå†ä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚

ğŸŸ¤ ç¤ºä¾‹ä¸ƒï¼šå°†ä»»æ„å¼‚å¸¸è½¬æ¢ä¸ºAIDLæ”¯æŒçš„å¼‚å¸¸ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸º `int divide(int a, int b)` æ¥å£æ·»åŠ å¼‚å¸¸æ•è·é€»è¾‘ï¼Œå¹¶å°†ArithmeticExceptionè½¬æ¢ä¸ºAIDLæ”¯æŒçš„IllegalArgumentExceptionå¼‚å¸¸ã€‚

"ExceptionTestService.java":

```java
@Override
public int divide2(int a, int b) {
    try {
        return a / b;
    } catch (ArithmeticException e) {
        // æ•è·AIDLä¸æ”¯æŒçš„å¼‚å¸¸ï¼Œå¹¶é‡æ–°æŠ›å‡ºIllegalArgumentExceptionã€‚
        throw new IllegalArgumentException("é™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼", e);
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"ExceptionTestServiceKT.kt":

```kotlin
override fun divide2(a: Int, b: Int): Int {
    try {
        return a / b
    } catch (e: Exception) {
        // æ•è·AIDLä¸æ”¯æŒçš„å¼‚å¸¸ï¼Œå¹¶é‡æ–°æŠ›å‡ºIllegalArgumentExceptionã€‚
        throw IllegalArgumentException("é™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼", e)
    }
}
```

æ­¤æ—¶ä»å®¢æˆ·ç«¯è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š

```text
16:37:11.324 8173 8173 E AndroidRuntime: FATAL EXCEPTION: main
                                         Process: net.bi4vmr.study, PID: 8173
                                         java.lang.IllegalArgumentException: é™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼
                                             at android.os.Parcel.createException(Parcel.java:2083)
                                             at android.os.Parcel.readException(Parcel.java:2039)
                                             at android.os.Parcel.readException(Parcel.java:1987)
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

å¼‚å¸¸é“¾ä¿¡æ¯æ— æ³•ä¼ é€’åˆ°å®¢æˆ·ç«¯ï¼Œä½†é¢å¤–ä¿¡æ¯â€œé™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼â€æ–‡æœ¬å¯ä»¥ä¼ é€’åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®æ­¤æ¶ˆæ¯è¿›ä¸€æ­¥é€‰æ‹©å¤„ç†æ–¹å¼ã€‚


# æ–‡ä»¶ä¼ è¾“
AIDLæ¥å£åªèƒ½ä¼ é€’ä¸è¶…è¿‡1Mçš„æ•°æ®ï¼Œå½“æˆ‘ä»¬éœ€è¦è·¨è¿›ç¨‹ä¼ è¾“å¤§äº1Mçš„æ–‡ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ParcelFileDescriptorã€‚

FileDescriptorï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥ä¸‹ç®€ç§°ä¸ºFDã€‚ï¼‰æ˜¯Linuxç³»ç»Ÿä¸­æŒ‡å‘ç›®æ ‡æ–‡ä»¶çš„æŒ‡é’ˆï¼Œæœ¬èº«æ˜¯ `int` ç±»å‹ï¼Œå› æ­¤å¯ä»¥æ–¹ä¾¿åœ°è·¨è¿›ç¨‹ä¼ è¾“ï¼›å½“ç¨‹åºAå°†FDä¼ é€’ç»™ç¨‹åºBåï¼Œç¨‹åºBå¯ä»¥é€šè¿‡FDæ„å»ºè¾“å…¥æˆ–è¾“å‡ºæµè¿›è€Œè¯»å†™ç›®æ ‡æ–‡ä»¶ï¼Œä»¥æ­¤å®ç°è·¨è¿›ç¨‹æ–‡ä»¶å…±äº«ã€‚

ParcelFileDescriptoræ˜¯Androidå¯¹FDçš„å°è£…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨AIDLæ¥å£ä¸­å°†å…¶ä½œä¸ºå‚æ•°æˆ–è¿”å›å€¼ï¼Œå®ç°åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´äº¤æ¢å¤§é‡æ•°æ®çš„éœ€æ±‚ã€‚

ğŸ”´ ç¤ºä¾‹å…«ï¼šä½¿ç”¨ParcelFileDescriptorä¸Šä¼ æ–‡ä»¶ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ParcelFileDescriptorï¼Œå®ç°AIDLå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¸Šä¼ æ–‡ä»¶çš„åŠŸèƒ½ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨AIDLæ–‡ä»¶ä¸­å®šä¹‰ä¸Šä¼ æ–‡ä»¶çš„æ¥å£ã€‚

"IFileService.aidl":

```java
interface IFileService {

    // å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¸Šä¼ æ–‡ä»¶
    void upload(in ParcelFileDescriptor pfd);
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯å®ç°AIDLæ¥å£ï¼Œæä¾›æ¥å£å¯¹åº”çš„èƒ½åŠ›ã€‚

"FileService.java":

```java
@Override
public void upload(ParcelFileDescriptor pfd) {
    // ä»PFDè·å–æ–‡ä»¶æè¿°ç¬¦
    FileDescriptor fd = pfd.getFileDescriptor();
    try (
            FileInputStream fis = new FileInputStream(fd)
    ) {
        // ä»è¾“å…¥æµè¯»å–æ•°æ®
        String content = IOUtil.readFile(fis);
        Log.d(TAG, "è·å–åˆ°å†…å®¹ï¼š" + content);
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        IOUtil.closeQuietly(fis);
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"FileServiceKT.kt":

```kotlin
override fun upload(pfd: ParcelFileDescriptor) {
    // ä»PFDè·å–æ–‡ä»¶æè¿°ç¬¦
    val fd = pfd.fileDescriptor
    runCatching {
        // ä»è¾“å…¥æµè¯»å–æ•°æ®
        FileInputStream(fd).use {
            val content = IOUtil.readFile(it)
            Log.d(TAG, "è·å–åˆ°å†…å®¹ï¼š$content")
        }
    }.onFailure { e ->
        e.printStackTrace()
    }
}
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ParcelFileDescriptorå®ä¾‹çš„ `getFileDescriptor()` æ–¹æ³•è·å–å…¶ä¸­çš„FDå®ä¾‹ï¼Œç„¶åæ„å»ºFileInputStreamè¯»å–å®¢æˆ·ç«¯çš„æ•°æ®ã€‚

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ç»‘å®šè¯¥æœåŠ¡ï¼Œå¹¶è°ƒç”¨AIDLæ¥å£ã€‚

"FileService.java":

```java
// åˆ›å»ºæµ‹è¯•æ–‡ä»¶
File textFile = new File(getApplicationContext().getFilesDir(), "text.txt");
IOUtil.writeFile(textFile, "Hello World!");

try (
        // è·å–æµ‹è¯•æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¨¡å¼ä¸ºåªè¯»ã€‚
        ParcelFileDescriptor pfd = ParcelFileDescriptor.open(textFile, ParcelFileDescriptor.MODE_READ_ONLY)
) {
    // é€šè¿‡è¿œç¨‹æœåŠ¡å°†æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œç”±æœåŠ¡ç«¯è¯»å–æ–‡ä»¶å†…å®¹ã€‚
    fileService.upload(pfd);
} catch (Exception e) {
    e.printStackTrace();
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"FileServiceKT.kt":

```kotlin
// åˆ›å»ºæµ‹è¯•æ–‡ä»¶
val textFile = File(applicationContext.filesDir, "text.txt")
IOUtil.writeFile(textFile, "Hello World!")

runCatching {
    ParcelFileDescriptor.open(textFile, ParcelFileDescriptor.MODE_READ_ONLY).use { pfd ->
        // é€šè¿‡è¿œç¨‹æœåŠ¡å°†æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œç”±æœåŠ¡ç«¯è¯»å–æ–‡ä»¶å†…å®¹ã€‚
        requireNotNull(testService).upload(pfd)
    }
}.onFailure { e ->
    e.printStackTrace()
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼ŒæœåŠ¡ç«¯åº”å½“èƒ½å¤Ÿè¯»å–åˆ°å®¢æˆ·ç«¯æµ‹è¯•æ–‡ä»¶çš„å†…å®¹ `Hello World!` ã€‚

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å®¢æˆ·ç«¯å¾…ä¸Šä¼ æ–‡ä»¶çš„FDä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œä½¿å…¶ä¸»åŠ¨è¯»å–æ•°æ®ï¼ŒæœåŠ¡ç«¯è¯»å–å®Œæ¯•æ—¶è‡ªåŠ¨å…³é—­PFDé‡Šæ”¾èµ„æºï¼Œè¿™ç§å®ç°æ–¹å¼æ¯”è¾ƒç®€æ´ï¼›å¦‚æœç”±æœåŠ¡ç«¯é€šè¿‡è¿”å›å€¼æˆ–å›è°ƒæ–¹æ³•æä¾›FDï¼Œå†ç”±å®¢æˆ·ç«¯å†™å…¥æ•°æ®ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–è®¾è®¡é€šçŸ¥æœåŠ¡ç«¯å†™å…¥å®Œæ¯•çš„æ¥å£ã€‚

ğŸŸ  ç¤ºä¾‹ä¹ï¼šä½¿ç”¨ParcelFileDescriptorä¸‹è½½æ–‡ä»¶ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ParcelFileDescriptorï¼Œå®ç°AIDLå®¢æˆ·ç«¯ä»æœåŠ¡ç«¯ä¸‹è½½æ–‡ä»¶çš„åŠŸèƒ½ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨AIDLæ–‡ä»¶ä¸­å®šä¹‰ä¸‹è½½æ–‡ä»¶çš„æ¥å£ã€‚

"IFileService.aidl":

```java
interface IFileService {

    // å®¢æˆ·ç«¯ä»æœåŠ¡ç«¯ä¸‹è½½æ–‡ä»¶
    void download(in ParcelFileDescriptor pfd);
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯å®ç°AIDLæ¥å£ï¼Œæä¾›æ¥å£å¯¹åº”çš„èƒ½åŠ›ã€‚

"FileService.java":

```java
@Override
public void download(ParcelFileDescriptor pfd) {
    // å°†ç›®æ ‡æ–‡ä»¶æ•°æ®å†™å…¥å®¢æˆ·ç«¯æä¾›çš„æ–‡ä»¶æè¿°ç¬¦æ‰€æŒ‡ä»£çš„æ–‡ä»¶
    try (
            FileOutputStream fos = new FileOutputStream(pfd.getFileDescriptor());
            BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(fos));
    ) {
        // å‘è¾“å‡ºæµå†™å…¥æ•°æ®
        writer.write("File on server");
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"FileServiceKT.kt":

```kotlin
override fun download(pfd: ParcelFileDescriptor) {
    // å°†ç›®æ ‡æ–‡ä»¶æ•°æ®å†™å…¥å®¢æˆ·ç«¯æä¾›çš„æ–‡ä»¶æè¿°ç¬¦æ‰€æŒ‡ä»£çš„æ–‡ä»¶
    val fd = pfd.fileDescriptor
    runCatching {
        // å‘è¾“å‡ºæµå†™å…¥æ•°æ®
        val fos = FileOutputStream(fd)
        BufferedWriter(OutputStreamWriter(fos)).use {
            it.write("File on server")
        }
    }.onFailure { e ->
        e.printStackTrace()
    }
}
```

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ç»‘å®šè¯¥æœåŠ¡ï¼Œå¹¶è°ƒç”¨AIDLæ¥å£ã€‚

"FileService.java":

```java
// å£°æ˜ç›®æ ‡æ–‡ä»¶
File file = new File(getApplicationContext().getFilesDir() + "/download.txt");

try (
        // è·å–æµ‹è¯•æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¨¡å¼ä¸ºåªå†™ä¸è‡ªåŠ¨åˆ›å»ºæ–‡ä»¶ã€‚
        ParcelFileDescriptor pfd = ParcelFileDescriptor.open(file, ParcelFileDescriptor.MODE_WRITE_ONLY | ParcelFileDescriptor.MODE_CREATE)
) {
    // å°†ç›®æ ‡æ–‡ä»¶çš„æè¿°ç¬¦ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œç”±æœåŠ¡ç«¯å†™å…¥æ•°æ®ã€‚
    fileService.download(pfd);

    // æœåŠ¡ç«¯å†™å…¥æ•°æ®å®Œæ¯•ï¼Œè¯»å–æ–‡ä»¶æ£€æŸ¥ç»“æœã€‚
    String content = IOUtil.readFile(file);
    Log.i(TAG, "æ–‡ä»¶å†…å®¹ï¼š" + content);
} catch (Exception e) {
    e.printStackTrace();
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"FileServiceKT.kt":

```kotlin
// å£°æ˜ç›®æ ‡æ–‡ä»¶
val file = File(applicationContext.filesDir.toString() + "/download.txt")

runCatching {
    ParcelFileDescriptor.open(file, ParcelFileDescriptor.MODE_WRITE_ONLY or ParcelFileDescriptor.MODE_CREATE)
        .use { pfd ->
            // å°†ç›®æ ‡æ–‡ä»¶çš„æè¿°ç¬¦ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œç”±æœåŠ¡ç«¯å†™å…¥æ•°æ®ã€‚
            requireNotNull(testService).download(pfd)

            // æœåŠ¡ç«¯å†™å…¥æ•°æ®å®Œæ¯•ï¼Œè¯»å–æ–‡ä»¶æ£€æŸ¥ç»“æœã€‚
            val content = IOUtil.readFile(file)
            Log.i(TAG, "æ–‡ä»¶å†…å®¹ï¼š$content")
        }
}.onFailure { e ->
    e.printStackTrace()
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼ŒæœåŠ¡ç«¯åº”å½“èƒ½å¤Ÿè¯»å–åˆ°å®¢æˆ·ç«¯æµ‹è¯•æ–‡ä»¶çš„å†…å®¹ `File on server` ã€‚

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å®¢æˆ·ç«¯çš„FDä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œä½¿å…¶ä¸»åŠ¨å†™å…¥æ•°æ®ï¼›å¯¹äºä¸‹è½½åŠŸèƒ½ï¼ŒæœåŠ¡ç«¯é€šå¸¸ä¸å…³å¿ƒå®¢æˆ·ç«¯æ˜¯å¦ä¸‹è½½å®Œæ¯•ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿”å›å€¼æˆ–å›è°ƒæ–¹æ³•æä¾›ç›®æ ‡æ–‡ä»¶åœ¨æœåŠ¡ç«¯çš„FDï¼Œå†ç”±å®¢æˆ·ç«¯è‡ªè¡Œè¯»å–æ•°æ®ã€‚

> ğŸš© æç¤º
>
> æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„PFDæ˜¯è”åŠ¨çš„ï¼Œæ•°æ®è¯»å†™å®Œæˆåï¼Œä»»æ„ä¸€æ–¹è°ƒç”¨ `close()` æ–¹æ³•é‡Šæ”¾èµ„æºå³å¯ï¼Œæ— éœ€é‡å¤è°ƒç”¨ã€‚


# ç–‘éš¾è§£ç­”
## ç´¢å¼•

<div align="center">

|       åºå·        |               æ‘˜è¦               |
| :---------------: | :------------------------------: |
| [æ¡ˆä¾‹ä¸€](#æ¡ˆä¾‹ä¸€) | é­…æ—æ‰‹æœºè·¨åº”ç”¨ç»‘å®šè¿œç¨‹æœåŠ¡å¤±è´¥ã€‚ |

</div>

## æ¡ˆä¾‹ä¸€
### é—®é¢˜æè¿°
å®éªŒç¯å¢ƒä¸ºé­…æ—16th Plusæ‰‹æœºï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºAä¸­é€šè¿‡Intentè®¾ç½®ç›®æ ‡æœåŠ¡çš„åŒ…åä¸Actionï¼Œå¹¶è°ƒç”¨ `bindService()` æ–¹æ³•ç»‘å®šåº”ç”¨ç¨‹åºBä¸­çš„æœåŠ¡ï¼Œä½† `bindService()` æ–¹æ³•è¿”å›å€¼ä¸º `false` ï¼Œä¸”æ— æ›´å¤šé”™è¯¯ä¿¡æ¯ã€‚

### é—®é¢˜åˆ†æ
ç›¸åŒçš„ä»£ç åœ¨éé­…æ—æ‰‹æœºä¸Šèƒ½å¤Ÿè¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬æ€€ç–‘æ˜¯é­…æ—ç³»ç»Ÿçš„ç‰¹æ€§å¯¼è‡´äº†é—®é¢˜ï¼Œè¿›è€Œé€šè¿‡æœç´¢å¼•æ“æŸ¥è¯¢åˆ°äº†ç›¸å…³æ–‡ç« ã€‚

### è§£å†³æ–¹æ¡ˆ
ç»è¿‡å®éªŒéªŒè¯ï¼Œä»¥ä¸‹æ–¹æ¡ˆæ˜¯æœ‰æ•ˆçš„ï¼š

é¦–å…ˆéœ€è¦ç¡®ä¿é€šè¿‡ComponentNameæŒ‡æ˜ç›®æ ‡æœåŠ¡ï¼Œé­…æ—æ‰‹æœºä¸æ”¯æŒé€šè¿‡ActionæŒ‡æ˜æœåŠ¡ï¼Œå…¶æ¬¡åœ¨è°ƒç”¨ `bindService()` æ–¹æ³•å‰éœ€è¦è°ƒç”¨ä¸€æ¬¡ `startService()` æ–¹æ³•ã€‚

```java
ComponentName cn = new ComponentName(
        "net.bi4vmr.study.system.service.aidlserver",
        "net.bi4vmr.study.file.FileService"
);
Intent intent = new Intent();
// æ˜ç¡®è®¾ç½®åŒ…åä¸æœåŠ¡ç±»å
intent.setComponent(cn);

// æ ¹æ®å“ç‰Œå®æ–½å…¼å®¹æ€§æªæ–½
if (Build.BRAND.contains("Meizu")) {
    // ç»‘å®šæœåŠ¡å‰å…ˆè°ƒç”¨ä¸€æ¬¡å¯åŠ¨æœåŠ¡çš„æ–¹æ³•
    startService(intent);
}

boolean result = bindService(intent, connection, Context.BIND_AUTO_CREATE);
```
