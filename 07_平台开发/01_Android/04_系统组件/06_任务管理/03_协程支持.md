# ç®€ä»‹
Androidæä¾›äº†ä¸€äº›Kotlinåç¨‹çš„æ‰©å±•èƒ½åŠ›ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¥½åœ°ä½¿ç”¨åç¨‹å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚

æˆ‘ä»¬é€šå¸¸ä¼šä¸ºAndroidå·¥ç¨‹å¼•å…¥ä»¥ä¸‹ç»„ä»¶ï¼š

"build.gradle":

```groovy
implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.1'
implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.5.1'
implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.5.1'
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"build.gradle.kts":

```kotlin
implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.1")
implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.5.1")
implementation("androidx.lifecycle:lifecycle-viewmodel-ktx:2.5.1")
```

ä¸Šè¿°ä»£ç å—ä¸­å„ä¸ªç»„ä»¶çš„ä½œç”¨è¯¦è§ä¸‹æ–‡åˆ—è¡¨ï¼š

- `kotlinx-coroutines-android` : æä¾›å¯¹è°ƒåº¦å™¨ `Dispatchers.Main` çš„æ”¯æŒï¼Œè¯¥è°ƒåº¦å™¨ä¼šä½¿ä»»åŠ¡åœ¨UIçº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ›´æ–°ç•Œé¢ã€‚
- `lifecycle-runtime-ktx` : æä¾›Activityæˆ–Fragmentçš„ç”Ÿå‘½å‘¨æœŸä½œç”¨åŸŸæ”¯æŒã€‚
- `lifecycle-viewmodel-ktx` : æä¾›ViewModelçš„ç”Ÿå‘½å‘¨æœŸä½œç”¨åŸŸæ”¯æŒã€‚


# LifeCycleä½œç”¨åŸŸ
éƒ¨åˆ†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸåº”å½“è·Ÿéšç•Œé¢ç»„ä»¶ï¼Œä¾‹å¦‚ï¼šæˆ‘ä»¬é€šè¿‡åç¨‹è¯·æ±‚ç½‘ç»œæ•°æ®ï¼Œå¹¶å°†å®ƒä»¬æ˜¾ç¤ºåˆ°ç•Œé¢ä¸Šã€‚å¦‚æœç•Œé¢è¢«å…³é—­æ—¶ï¼Œç½‘ç»œè¯·æ±‚è¿˜æ²¡æœ‰è¿”å›ï¼Œæˆ‘ä»¬åº”å½“å°†åç¨‹å–æ¶ˆï¼ŒåŠæ—¶é‡Šæ”¾èµ„æºå¹¶é˜²æ­¢å‡ºç°å¼‚å¸¸ã€‚

LifecycleOwnerçš„æ‰©å±•æ–¹æ³• `lifecycleScope()` æä¾›äº†ä¸€ä¸ªåç¨‹ä½œç”¨åŸŸï¼Œå½“LifecycleOwnerè¿›å…¥é”€æ¯çŠ¶æ€æ—¶ï¼Œé€šè¿‡è¯¥ä½œç”¨åŸŸå¯åŠ¨çš„åç¨‹éƒ½å°†è¢«å–æ¶ˆã€‚LifecycleOwnerçš„å®ç°ç±»åŒ…æ‹¬Activityå’ŒFragmentï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸Activityæˆ–Fragmentç»‘å®šã€‚

ğŸ”´ ç¤ºä¾‹ä¸€ï¼šLifeCycleä½œç”¨åŸŸåç¨‹ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Activityçš„åç¨‹ä½œç”¨åŸŸå¯åŠ¨åç¨‹ï¼Œå¹¶åœ¨åç¨‹ç»ˆæ­¢å‰å…³é—­Activityï¼Œè§‚å¯Ÿåç¨‹çš„çŠ¶æ€ã€‚

"TestUICoroutineKT.kt":

```kotlin
class TestUICoroutineKT : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        // å¯åŠ¨åç¨‹
        lifecycleScope.launch {
            try {
                Log.d(TAG, "Task start.")
                delay(5000L)
                Log.d(TAG, "Task end.")
            } catch (e: CancellationException) {
                Log.d(TAG, "Task was canceled!")
            }
        }

        // å…³é—­å½“å‰é¡µé¢
        Log.d(TAG, "Finish activity.")
        finish()
    }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
21:26:24.104  3634  3634 D TestUICoroutineKT: Task start.
21:26:24.106  3634  3634 D TestUICoroutineKT: Finish activity.
21:26:24.712  3634  3634 D TestUICoroutineKT: Task was canceled!
21:26:24.713  3634  3634 D TestUICoroutineKT: OnDestroy.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

é€šè¿‡ `lifecycleScope` å¼€å¯çš„åç¨‹é»˜è®¤åœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼›å½“æˆ‘ä»¬è°ƒç”¨æµ‹è¯•Activityçš„ `finish()` æ–¹æ³•åï¼Œä¸Activityå…³è”çš„åç¨‹è¢«ç»ˆæ­¢äº†ã€‚


# ViewModelä½œç”¨åŸŸ
ä¸ `lifecycleScope()` ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ViewModelä¸­ä½¿ç”¨ `viewModelScope` å¼€å¯åç¨‹ï¼Œè¿™äº›åç¨‹çš„ç”Ÿå‘½å‘¨æœŸå°†ä¸ViewModelå®ä¾‹ç»‘å®šã€‚

ğŸŸ  ç¤ºä¾‹äºŒï¼šViewModelä½œç”¨åŸŸåç¨‹ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ViewModelçš„åç¨‹ä½œç”¨åŸŸå¯åŠ¨åç¨‹ï¼Œå¹¶åœ¨åç¨‹ç»ˆæ­¢å‰å…³é—­ç›¸å…³Activityï¼Œè§‚å¯Ÿåç¨‹çš„çŠ¶æ€ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åˆ›å»ºMyViewModelç±»ï¼Œå¹¶åœ¨å…¶ä¸­å®ç°æµ‹è¯•æ–¹æ³• `task()` ï¼Œä½¿ç”¨ `viewModelScope()` æ–¹æ³•å¯åŠ¨åç¨‹ã€‚

"MyViewModel.kt":

```kotlin
class MyViewModel : ViewModel() {

    // æµ‹è¯•åç¨‹
    fun task() {
        viewModelScope.launch {
            try {
                Log.d(TAG, "Task start.")
                delay(5000L)
                Log.d(TAG, "Task end.")
            } catch (e: CancellationException) {
                Log.d(TAG, "Task was canceled!")
            }
        }
    }
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•Activityä¸­è·å–MyViewModelå®ä¾‹ï¼Œè°ƒç”¨ `task()` æ–¹æ³•å¯åŠ¨åç¨‹ï¼Œéšåç»ˆæ­¢æµ‹è¯•Activityã€‚

"TestUICoroutineKT.kt":

```kotlin
class TestUICoroutineKT : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        // è·å–å½“å‰Activityçš„MyViewModelå®ä¾‹
        val vm: MyViewModel = ViewModelProvider(this)[MyViewModel::class.java]
        // è°ƒç”¨VMå®ä¾‹ä¸­çš„æ–¹æ³•å¯åŠ¨åç¨‹
        vm.task()

        // å…³é—­å½“å‰é¡µé¢
        Log.d(TAG, "Finish activity.")
        finish()
    }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
21:47:53.531  3880  3880 D MyViewModel: Task start.
21:47:53.533  3880  3880 D TestUICoroutineKT: Finish activity.
21:47:54.230  3880  3880 D MyViewModel: Task was canceled!
21:47:54.230  3880  3880 D MyViewModel: OnCleared.
21:47:54.230  3880  3880 D TestUICoroutineKT: OnDestroy.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

é€šè¿‡ `viewModelScope()` æ–¹æ³•å¼€å¯çš„åç¨‹é»˜è®¤åœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼›å½“æˆ‘ä»¬è°ƒç”¨æµ‹è¯•Activityçš„ `finish()` æ–¹æ³•åï¼Œä¸Activityå…³è”çš„ViewModelè¢«é”€æ¯ï¼Œéšåå…¶ä¸­çš„åç¨‹ä¹Ÿè¢«ç»ˆæ­¢äº†ã€‚


# è¿›ç¨‹çº§åç¨‹
æœ‰äº›åç¨‹çš„ç”Ÿå‘½å‘¨æœŸéœ€è¦ä¸è¿›ç¨‹ç»‘å®šï¼Œä¾‹å¦‚ï¼šæ•°æ®åŒæ­¥ä»»åŠ¡ï¼Œç¼“å­˜æ¸…ç†ä»»åŠ¡ï¼›å³ä½¿ç¨‹åºçš„ç•Œé¢éƒ½è¢«å…³é—­ï¼Œè¿™äº›ä»»åŠ¡ä¹Ÿéœ€è¦ç»§ç»­æ‰§è¡Œã€‚

åœ¨æ—©æœŸçš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç å¯åŠ¨è¿›ç¨‹çº§åç¨‹ï¼š

"TestUICoroutineKT.kt":

```kotlin
// å¯åŠ¨è¿›ç¨‹çº§åç¨‹
GlobalScope.launch {
    task()
}
```

GlobalScopeæ²¡æœ‰æ˜ç¡®åœ°å…³è”åˆ°è°ƒåº¦å™¨ï¼Œå¯èƒ½æ— æ³•å……åˆ†åˆ©ç”¨CPUã€IOç­‰èµ„æºï¼Œå› æ­¤å·²è¢«åºŸå¼ƒã€‚

åœ¨è¾ƒæ–°çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ¨èè‡ªè¡Œåˆ›å»ºä½œç”¨åŸŸï¼Œå¹¶æŒ‡æ˜è°ƒåº¦å™¨ã€‚

ğŸŸ¡ ç¤ºä¾‹ä¸‰ï¼šè¿›ç¨‹çº§åç¨‹ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºå…³è”åˆ°è¿›ç¨‹çš„åç¨‹ã€‚

æˆ‘ä»¬å¯ä»¥ç¼–å†™GlobalTaskManagerå•ä¾‹ç±»ï¼Œç”¨äºç®¡ç†å…¨å±€åç¨‹ï¼Œå¹¶åœ¨Applicationå¤„æˆ–æ ¹æ®éœ€è¦è¿›è¡Œåˆå§‹åŒ–ã€‚

"GlobalTaskManager.kt":

```kotlin
object GlobalTaskManager {

    private val ioScope = CoroutineScope(Dispatchers.IO)

    fun init() {
        ioScope.launch { task() }
    }

    // æ­¤å¤„å·²çœç•¥éƒ¨åˆ†ä»£ç ...
}
```


# æµ‹è¯•å·¥å…·
æœ¬åœ°æµ‹è¯•ç¯å¢ƒé»˜è®¤æ²¡æœ‰é…ç½® `Dispatchers.Main` è°ƒåº¦å™¨ï¼Œå¦‚æœè¢«æµ‹ç»„ä»¶ä½¿ç”¨äº†è¯¥è°ƒåº¦å™¨ï¼Œåˆ™ä¼šå‡ºç°é”™è¯¯ï¼š

```text
java.lang.IllegalStateException: Module with the Main dispatcher had failed to initialize. For tests Dispatchers.setMain from kotlinx-coroutines-test module can be used
	at kotlinx.coroutines.internal.MissingMainCoroutineDispatcher.missing(MainDispatchers.kt:111)
	at kotlinx.coroutines.internal.MissingMainCoroutineDispatcher.isDispatchNeeded(MainDispatchers.kt:92)
```

ä¸ºäº†æµ‹è¯•åŒ…å«Mainè°ƒåº¦å™¨çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥æµ‹è¯•å·¥å…·å¹¶è¿›è¡Œä¸€äº›é…ç½®ã€‚

ğŸŸ¢ ç¤ºä¾‹å››ï¼šåœ¨æœ¬åœ°æµ‹è¯•ä¸­æ§åˆ¶Mainè°ƒåº¦å™¨ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶Mainè°ƒåº¦å™¨ä¸­çš„ä»»åŠ¡è¿›åº¦ï¼Œå®ç°æµ‹è¯•çº¿ç¨‹ä¸Mainè°ƒåº¦å™¨çš„åä½œã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå·¥ç¨‹å£°æ˜åç¨‹æµ‹è¯•å·¥å…·ä¾èµ–é¡¹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹æ–‡ä»£ç å—ä¸­çš„è¯­å¥å£°æ˜ä¾èµ–ï¼š

"build.gradle":

```groovy
dependencies {
    testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-test:1.8.1'
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"build.gradle.kts":

```kotlin
dependencies {
    testImplementation("org.jetbrains.kotlinx:kotlinx-coroutines-test:1.8.1")
}
```

ç¬¬äºŒæ­¥ï¼Œç¼–å†™æµ‹è¯•ä»£ç ã€‚

```kotlin
@Test
fun test_Main() = runTest {
    // åˆ›å»ºæµ‹è¯•è°ƒåº¦å™¨
    val mainDispatcher = StandardTestDispatcher()
    // å°†æµ‹è¯•è°ƒåº¦å™¨ä½œä¸ºMainè°ƒåº¦å™¨
    Dispatchers.setMain(mainDispatcher)

    // å¯åŠ¨ä¾èµ–Mainè°ƒåº¦å™¨çš„åç¨‹
    runInMainThread()

    // æ¨è¿›æµ‹è¯•è°ƒåº¦å™¨æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ï¼Œå¹¶æŒ‚èµ·æµ‹è¯•çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚
    mainDispatcher.scheduler.advanceUntilIdle()

    // æµ‹è¯•å®Œæ¯•åé‡ç½®Mainè°ƒåº¦å™¨
    Dispatchers.resetMain()
}

fun runInMainThread() {
    MainScope().launch {
        println("Main thread task start.")
        delay(5000L)
        println("Main thread task end.")
    }
}
```

åœ¨è°ƒç”¨è¢«æµ‹æ–¹æ³•å‰ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ `Dispatchers.setMain()` æ–¹æ³•å°†æµ‹è¯•è°ƒåº¦å™¨è®¾ç½®ä¸ºMainè°ƒåº¦å™¨ã€‚

å½“è¢«æµ‹æ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œå®ƒä¸æµ‹è¯•åç¨‹æ²¡æœ‰å…³è”ï¼Œå°†ä¼šè‡ªç”±æ‰§è¡Œã€‚ä¸ºäº†ä½¿æµ‹è¯•åç¨‹ç­‰å¾…Mainè°ƒåº¦å™¨æ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `mainDispatcher.scheduler.advanceUntilIdle()` ï¼Œè¿™ä¼šæ¨è¿›Mainè°ƒåº¦å™¨ä¸­çš„ä»»åŠ¡å¹¶æŒ‚èµ·æµ‹è¯•åç¨‹ï¼Œå½“è¯¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡æ–­è¨€ç­‰åˆ¤æ–­ä»»åŠ¡ç»“æœæ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚

å½“å‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `Dispatchers.resetMain()` æ–¹æ³•è§£é™¤æµ‹è¯•è°ƒåº¦å™¨ä¸MainScopeçš„å…³è”ï¼Œé˜²æ­¢å¹²æ‰°å…¶ä»–æµ‹è¯•ç”¨ä¾‹ã€‚
