<!-- TODO
# ç®€ä»‹

å¼‚æ­¥ä»»åŠ¡å·¥å…·ç®€ä»‹...


æœ¬ç« çš„ç¤ºä¾‹å·¥ç¨‹è¯¦è§ä»¥ä¸‹é“¾æ¥ï¼š

- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šæ¦‚è¿°](https://github.com/BI4VMR/Study-Android/tree/master/M04_System/C06_Concurrent/S01_Base)

-->

# Kotlinåç¨‹
## ç®€ä»‹
Androidæä¾›äº†ä¸€äº›Kotlinåç¨‹çš„æ‰©å±•èƒ½åŠ›ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¥½åœ°ä½¿ç”¨åç¨‹å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚

æˆ‘ä»¬é€šå¸¸ä¼šä¸ºAndroidå·¥ç¨‹å¼•å…¥ä»¥ä¸‹ç»„ä»¶ï¼š

"build.gradle":

```groovy
implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.1'
implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.5.1'
implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.5.1'
```

ä¸Šè¿°ä»£ç å—ä¸­å„ä¸ªç»„ä»¶çš„ä½œç”¨è¯¦è§ä¸‹æ–‡åˆ—è¡¨ï¼š

- `kotlinx-coroutines-android` : æä¾›å¯¹è°ƒåº¦å™¨ `Dispatchers.Main` çš„æ”¯æŒï¼Œè¯¥è°ƒåº¦å™¨ä¼šä½¿ä»»åŠ¡åœ¨UIçº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ›´æ–°ç•Œé¢ã€‚
- `lifecycle-runtime-ktx` : æä¾›ç”Ÿå‘½å‘¨æœŸè·ŸéšLifeCycleç»„ä»¶çš„åç¨‹æ”¯æŒã€‚
- `lifecycle-viewmodel-ktx` : æä¾›ç”Ÿå‘½å‘¨æœŸè·ŸéšViewModelç»„ä»¶çš„åç¨‹æ”¯æŒã€‚

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"build.gradle.kts":

```kotlin
implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.1")
implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.5.1")
implementation("androidx.lifecycle:lifecycle-viewmodel-ktx:2.5.1")
```

## LifeCycleåç¨‹
éƒ¨åˆ†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸåº”å½“è·Ÿéšç•Œé¢ç»„ä»¶ï¼Œä¾‹å¦‚ï¼šæˆ‘ä»¬é€šè¿‡åç¨‹è¯·æ±‚ç½‘ç»œæ•°æ®ï¼Œå¹¶å°†å®ƒä»¬æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šã€‚å½“ç•Œé¢è¢«å…³é—­æ—¶ï¼Œå¦‚æœç½‘ç»œè¯·æ±‚åç¨‹è¿˜æ²¡æœ‰ç»“æŸï¼Œæˆ‘ä»¬åº”å½“å°†å®ƒä»¬å–æ¶ˆï¼ŒåŠæ—¶é‡Šæ”¾èµ„æºã€‚

LifecycleOwnerçš„æ‰©å±•æ–¹æ³• `lifecycleScope()` æ˜¯ä¸€ä¸ªåç¨‹æ„å»ºå™¨ï¼Œå½“LifecycleOwnerè¿›å…¥é”€æ¯çŠ¶æ€æ—¶ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯åŠ¨çš„åç¨‹éƒ½å°†è¢«å–æ¶ˆã€‚LifecycleOwnerçš„å®ç°ç±»åŒ…æ‹¬Activityæˆ–Fragmentï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸Activityæˆ–Fragmentç»‘å®šã€‚

ğŸ”´ ç¤ºä¾‹ä¸€ï¼šåˆ›å»ºç”Ÿå‘½å‘¨æœŸä¸Activityç»‘å®šçš„åç¨‹ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºç”Ÿå‘½å‘¨æœŸä¸Activityç»‘å®šçš„åç¨‹ï¼Œç»ˆæ­¢Activityå¹¶è§‚å¯Ÿåç¨‹çš„çŠ¶æ€ã€‚

æˆ‘ä»¬åœ¨æµ‹è¯•Activityè¢«åˆ›å»ºæ—¶å¯åŠ¨åç¨‹ï¼Œå°†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸æµ‹è¯•Activityç»‘å®šï¼Œå¹¶åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹å‰å…³é—­Activityã€‚

"TestUICoroutineKT.kt":

```kotlin
class TestUICoroutineKT : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        // å¯åŠ¨åç¨‹
        lifecycleScope.launch {
            try {
                Log.d(TAG, "Task start.")
                delay(5000L)
                Log.d(TAG, "Task end.")
            } catch (e: CancellationException) {
                Log.d(TAG, "Task was canceled!")
            }
        }

        // å…³é—­å½“å‰é¡µé¢
        Log.d(TAG, "Finish activity.")
        finish()
    }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
21:26:24.104  3634  3634 D TestUICoroutineKT: Task start.
21:26:24.106  3634  3634 D TestUICoroutineKT: Finish activity.
21:26:24.712  3634  3634 D TestUICoroutineKT: Task was canceled!
21:26:24.713  3634  3634 D TestUICoroutineKT: OnDestroy.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

é€šè¿‡ `lifecycleScope()` æ–¹æ³•å¼€å¯çš„åç¨‹é»˜è®¤åœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼›å½“æˆ‘ä»¬è°ƒç”¨æµ‹è¯•Activityçš„ `finish()` æ–¹æ³•åï¼Œä¸Activityå…³è”çš„åç¨‹è¢«ç»ˆæ­¢äº†ã€‚

## ViewModelåç¨‹
ä¸ `lifecycleScope()` ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ViewModelä¸­ä½¿ç”¨ `viewModelScope()` æ–¹æ³•å¼€å¯åç¨‹ï¼Œè¿™äº›åç¨‹çš„ç”Ÿå‘½å‘¨æœŸå°†ä¸ViewModelå®ä¾‹ç»‘å®šã€‚

ğŸŸ  ç¤ºä¾‹äºŒï¼šåˆ›å»ºç”Ÿå‘½å‘¨æœŸä¸ViewModelç»‘å®šçš„åç¨‹ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºç”Ÿå‘½å‘¨æœŸä¸ViewModelç»‘å®šçš„åç¨‹ï¼Œç»ˆæ­¢ViewModelå¹¶è§‚å¯Ÿåç¨‹çš„çŠ¶æ€ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åˆ›å»ºMyViewModelç±»ï¼Œå¹¶åœ¨å…¶ä¸­å®ç°æµ‹è¯•æ–¹æ³• `task()` ï¼Œä½¿ç”¨ `viewModelScope()` æ–¹æ³•å¯åŠ¨åç¨‹ã€‚

"MyViewModel.kt":

```kotlin
class MyViewModel : ViewModel() {

    // æµ‹è¯•åç¨‹
    fun task() {
        viewModelScope.launch {
            try {
                Log.d(TAG, "Task start.")
                delay(5000L)
                Log.d(TAG, "Task end.")
            } catch (e: CancellationException) {
                Log.d(TAG, "Task was canceled!")
            }
        }
    }
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•Activityä¸­è·å–MyViewModelå®ä¾‹ï¼Œè°ƒç”¨ `task()` æ–¹æ³•å¯åŠ¨åç¨‹ï¼Œéšåç»ˆæ­¢æµ‹è¯•Activityã€‚

"TestUICoroutineKT.kt":

```kotlin
class TestUICoroutineKT : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        // è·å–å½“å‰Activityçš„MyViewModelå®ä¾‹
        val vm: MyViewModel = ViewModelProvider(this)[MyViewModel::class.java]
        // è°ƒç”¨VMå®ä¾‹ä¸­çš„æ–¹æ³•å¯åŠ¨åç¨‹
        vm.task()

        // å…³é—­å½“å‰é¡µé¢
        Log.d(TAG, "Finish activity.")
        finish()
    }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
21:47:53.531  3880  3880 D MyViewModel: Task start.
21:47:53.533  3880  3880 D TestUICoroutineKT: Finish activity.
21:47:54.230  3880  3880 D MyViewModel: Task was canceled!
21:47:54.230  3880  3880 D MyViewModel: OnCleared.
21:47:54.230  3880  3880 D TestUICoroutineKT: OnDestroy.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

é€šè¿‡ `viewModelScope()` æ–¹æ³•å¼€å¯çš„åç¨‹é»˜è®¤åœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼›å½“æˆ‘ä»¬è°ƒç”¨æµ‹è¯•Activityçš„ `finish()` æ–¹æ³•åï¼Œä¸Activityå…³è”çš„ViewModelè¢«é”€æ¯ï¼Œéšåå…¶ä¸­çš„åç¨‹ä¹Ÿè¢«ç»ˆæ­¢äº†ã€‚

## è¿›ç¨‹çº§åç¨‹
æœ‰äº›åç¨‹çš„ç”Ÿå‘½å‘¨æœŸéœ€è¦ä¸è¿›ç¨‹ç»‘å®šï¼Œä¾‹å¦‚ï¼šæ•°æ®åŒæ­¥ä»»åŠ¡ï¼Œç¼“å­˜æ¸…ç†ä»»åŠ¡ï¼›å³ä½¿ç¨‹åºçš„ç•Œé¢éƒ½è¢«å…³é—­ï¼Œè¿™äº›ä»»åŠ¡ä¹Ÿéœ€è¦ç»§ç»­æ‰§è¡Œã€‚

åœ¨æ—©æœŸçš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ä»£ç å¯åŠ¨è¿›ç¨‹çº§åç¨‹ï¼š

"TestUICoroutineKT.kt":

```kotlin
// å¯åŠ¨è¿›ç¨‹çº§åç¨‹
GlobalScope.launch {
    task()
}
```

é€šè¿‡è¿™ç§æ–¹å¼å¯åŠ¨çš„åç¨‹æ²¡æœ‰æ˜ç¡®åœ°å…³è”åˆ°è°ƒåº¦å™¨ï¼Œå¯èƒ½æ— æ³•å……åˆ†åˆ©ç”¨CPUã€IOç­‰èµ„æºï¼Œå› æ­¤å·²è¢«åºŸå¼ƒã€‚

åœ¨è¾ƒæ–°çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨Kotlinåç¨‹åº“æä¾›çš„CoroutineScopeå¯åŠ¨è¿›ç¨‹çº§åç¨‹ï¼Œå¹¶æŒ‡æ˜ä»»åŠ¡æ‰€éœ€çš„è°ƒåº¦å™¨ï¼š

"TestUICoroutineKT.kt":

```kotlin
// å¯åŠ¨è¿›ç¨‹çº§åç¨‹ï¼Œå¹¶æŒ‡å®šè°ƒåº¦å™¨ã€‚
CoroutineScope(Dispatchers.Default).launch {
    task()
}
```
