# ç®€ä»‹
ContentObserverç”¨äºè§‚å¯ŸURIå¯¹åº”çš„æ•°æ®é¡¹æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚é€šè¿‡è¯¥å·¥å…·ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ„ŸçŸ¥æ•°æ®å˜åŒ–å¹¶åšå‡ºå“åº”ï¼Œé¿å…äº†å®šæœŸè½®è¯¢æ•°æ®æ‰€é€ æˆçš„æ€§èƒ½æ¶ˆè€—ã€‚

æœ¬ç« ç¤ºä¾‹ä»£ç è¯¦è§ä»¥ä¸‹é“¾æ¥ï¼š

- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šç›‘å¬æ•°æ®å˜åŒ–](https://github.com/BI4VMR/Study-Android/tree/master/M04_System/C04_ContentProvider/S05_DataObserver)

# åŸºæœ¬åº”ç”¨
## æœåŠ¡ç«¯å®ç°
ContentResolverç±»çš„ `notifyChange(Uri uri, ContentObserver observer)` æ–¹æ³•ç”¨äºå‘å‡ºæ•°æ®å˜æ›´é€šçŸ¥ï¼Œå‚æ•° `uri` è¡¨ç¤ºéœ€è¦é€šçŸ¥çš„URIï¼›å‚æ•° `observer` é€šå¸¸å¡«å†™ç©ºå€¼å³å¯ã€‚æ¯å½“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯ä¸»åŠ¨è°ƒç”¨è¯¥æ–¹æ³•å‘å‡ºé€šçŸ¥äº‹ä»¶ã€‚

æ­¤å¤„æˆ‘ä»¬åœ¨æµ‹è¯•Activityä¸­ä½¿ç”¨æŒ‰é’®è§¦å‘äº‹ä»¶é€šçŸ¥ã€‚

"TestUIBase.java":

```java
final String URI_TEST = "content://net.bi4vmr.provider.testobserver/test";

getContentResolver().notifyChange(Uri.parse(URI_TEST), null);
```

## å®¢æˆ·ç«¯å®ç°
æ¥ç€æˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯æ³¨å†ŒContentObserverå®ç°ç›‘å¬ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šå¸¸åœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ­¤å¤„ä¸ºäº†ä¾¿äºæµ‹è¯•ï¼Œä»¥ä¸‹ä»£ç ä¹Ÿæ”¾ç½®åœ¨æœåŠ¡ç«¯çš„æµ‹è¯•Activityä¸­ã€‚

æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªDataObserverç±»ï¼Œç»§æ‰¿è‡ªContentObserverç±»ï¼Œå¹¶å®ç°å…¶ä¸­çš„ä¸€äº›æ–¹æ³•ï¼š

"TestUIBase.java":

```java
private class DataObserver extends ContentObserver {

    public DataObserver(Handler handler) {
        super(handler);
    }

    @Override
    public void onChange(boolean selfChange, @Nullable Uri uri) {
        super.onChange(selfChange, uri);
        binding.tvLog.append("DataObserver-OnChange. URI: " + uri);
        Log.i(TAG, "DataObserver-OnChange. URI: " + uri);
    }
}
```

ContentObserverç±»çš„æ„é€ æ–¹æ³• `ContentObserver(Handler handler)` å‚æ•° `handler` æŒ‡å®šäº†æ•°æ®å˜åŒ–äº‹ä»¶è§¦å‘åçš„å›è°ƒæ‰§è¡Œçº¿ç¨‹ã€‚

ContentObserverç±»çš„å›è°ƒæ–¹æ³• `onChange(boolean selfChange, Uri uri)` å°†åœ¨æœåŠ¡ç«¯å‘å‡ºäº‹ä»¶é€šçŸ¥æ—¶è¢«è§¦å‘ï¼Œå„ä¸ªå‚æ•°çš„å«ä¹‰è§ä¸‹æ–‡å†…å®¹ï¼š

- å‚æ•° `selfChange` : ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºé€šå¸¸ä¸ä½¿ç”¨ï¼Œå€¼å§‹ç»ˆä¸º"false"ã€‚
- å‚æ•° `uri` : è¡¨ç¤ºå‘ç”Ÿå˜åŒ–çš„æ•°æ®URIã€‚

ContentResolverç±»çš„ `registerContentObserver(Uri uri, boolean notifyForDescendants, ContentObserver observer)` æ–¹æ³•ç”¨äºæ³¨å†Œç›‘å¬å™¨ï¼Œå„ä¸ªå‚æ•°çš„å«ä¹‰è§ä¸‹æ–‡å†…å®¹ï¼š

- å‚æ•° `uri` : æŒ‡å®šéœ€è¦ç›‘å¬çš„URIã€‚
- å‚æ•° `notifyForDescendants` : æŒ‡å®šæ˜¯å¦æ¥æ”¶å…³è”æ•°æ®çš„å˜åŒ–é€šçŸ¥ã€‚å¦‚æœæˆ‘ä»¬æ³¨å†Œç›‘å¬ `content://net.bi4vmr.provider.testobserver/test` å¹¶å°† `notifyForDescendants` å±æ€§è®¾ä¸º"true"ï¼›æ­¤æ—¶å­è®°å½• `content://net.bi4vmr.provider.testobserver/test/1` å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¯¥ç›‘å¬å™¨ä¹Ÿä¼šè¢«è§¦å‘ã€‚
- å‚æ•° `observer` : ContentObserverå®ä¾‹ã€‚

æˆ‘ä»¬åœ¨æµ‹è¯•Activityä¸­æ³¨å†Œç›‘å¬å™¨ï¼Œç›‘å¬ `URI_TEST` æ•°æ®å˜åŒ–äº‹ä»¶ã€‚

"TestUIBase.java":

```java
final String URI_TEST = "content://net.bi4vmr.provider.testobserver/test";

// åˆå§‹åŒ–DataObserverï¼Œåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œå›è°ƒã€‚
DataObserver observer = new DataObserver(new Handler(Looper.getMainLooper()));

// æ³¨å†Œç›‘å¬å™¨
Context.getContentResolver()
    .registerContentObserver(Uri.parse(URI_TEST), false, observer);
```

æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨ä¸»çº¿ç¨‹çš„Handleræ„é€ DataObserverå®ä¾‹ï¼Œä½¿å›è°ƒåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¾¿äºæ›´æ–°ç•Œé¢ã€‚

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
21:29:41.617 14725 14725 I TestApp: DataObserver-OnChange. URI: content://net.bi4vmr.provider.testobserver/test
```

ä»ä¸Šè¿°è¾“å‡ºä¿¡æ¯å¯çŸ¥ï¼š

æœåŠ¡ç«¯å‘å‡ºäº‹ä»¶é€šçŸ¥åï¼Œå®¢æˆ·ç«¯ç›‘å¬å™¨çš„ `onChange()` å›è°ƒæ–¹æ³•è¢«è§¦å‘ï¼Œå¹¶ä¸”å‚æ•°æŒ‡æ˜äº†æ•°æ®çš„URIã€‚

å½“æˆ‘ä»¬ä¸å†éœ€è¦ä½¿ç”¨æŸä¸ªç›‘å¬å™¨æ—¶ï¼Œå¯ä»¥è°ƒç”¨ContentResolverå®ä¾‹çš„ `unregisterContentObserver(ContentObserver observer)` æ–¹æ³•ï¼Œä¼ å…¥ç›‘å¬å™¨å®ä¾‹ï¼Œè§£é™¤æ³¨å†Œå…³ç³»ã€‚

"TestUIBase.java":

```java
// æ³¨é”€ç›‘å¬å™¨
Context.getContentResolver()
    .unregisterContentObserver(observer);
```
