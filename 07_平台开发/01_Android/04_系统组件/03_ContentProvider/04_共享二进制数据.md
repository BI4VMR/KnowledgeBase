# ç®€ä»‹
å‰æ–‡ç« èŠ‚ä¸­æˆ‘ä»¬å®ç°äº†é€šè¿‡ContentProviderå…±äº«å…³ç³»å‹æ•°æ®çš„åŠŸèƒ½ï¼Œæœ¬æ–‡å°†æ¼”ç¤ºé€šè¿‡ContentProviderå…±äº«äºŒè¿›åˆ¶æ•°æ®ï¼ˆä¾‹å¦‚ï¼šæ–‡æœ¬æ–‡ä»¶ã€éŸ³è§†é¢‘æµç­‰ï¼‰çš„æ–¹æ³•ã€‚

æœ¬ç« ç¤ºä¾‹ä»£ç è¯¦è§ä»¥ä¸‹é“¾æ¥ï¼š

- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šå…±äº«äºŒè¿›åˆ¶æ•°æ®](https://github.com/BI4VMR/Study-Android/tree/master/M04_System/C04_ContentProvider/S04_BinaryData)

# å®éªŒç¯å¢ƒè¯´æ˜
æˆ‘ä»¬åœ¨æœåŠ¡ç«¯åˆ›å»ºä¸€ä¸ªShareFileProviderä»¥å®ç°æ–‡ä»¶å…±äº«åŠŸèƒ½ï¼Œå¹¶åœ¨åˆå§‹åŒ–æ—¶å£°æ˜ä¸¤ä¸ªURIï¼Œåˆ†åˆ«å¯¹åº”è¯»æ–‡ä»¶ã€å†™æ–‡ä»¶çš„åŠŸèƒ½ã€‚

"ShareFileProvider.java":

```java
@Override
protected void onCreate(Bundle savedInstanceState) {
    final String AUTHORITY = "net.bi4vmr.provider.sharefile";
    // æ–‡ä»¶è¯»å–æµ‹è¯•ï¼ˆçº¯æ–‡æœ¬ï¼‰
    uriMatcher.addURI(AUTHORITY, "textfile", 101);
    // æ–‡ä»¶å†™å…¥æµ‹è¯•ï¼ˆJSONæ–‡æœ¬ï¼‰
    uriMatcher.addURI(AUTHORITY, "configfile", 102);

    /*
     * åˆ›å»ºæ–‡æœ¬æ–‡ä»¶"text.txt"å¹¶å†™å…¥ä¸€äº›å†…å®¹ã€‚
     *
     * æ­¤å¤„çœç•¥ç›¸å…³ä»£ç ...
     */

    return true;
}
```

URI `content://net.bi4vmr.provider.sharefile/textfile` å¯¹åº”æ™®é€šæ–‡æœ¬æ–‡ä»¶ `text.txt` ï¼ŒæœåŠ¡ç«¯é¢„å…ˆå†™å…¥ä¸‹æ–‡æ‰€ç¤ºçš„å†…å®¹ï¼Œä»¥ä¾›å®¢æˆ·ç«¯è¿›è¡Œè¯»å–æµ‹è¯•ã€‚

"text.txt":

```text
GNU is not unix
WINE is not an emulator
æˆ‘èƒ½åä¸‹ç»ç’ƒè€Œä¸ä¼¤èº«ä½“ã€‚
```

URI `content://net.bi4vmr.provider.sharefile/configfile` å¯¹åº”JSONé…ç½®æ–‡ä»¶ `config.json` ï¼ŒæœåŠ¡ç«¯ä¸å¿…é¢„å…ˆåˆ›å»ºï¼Œå†…å®¹ç”±å®¢æˆ·ç«¯å†™å…¥ã€‚

# å£°æ˜æ•°æ®ç±»å‹
## æœåŠ¡ç«¯å®ç°
è¾“å…¥æµæˆ–è¾“å‡ºæµä¸­åªæœ‰äºŒè¿›åˆ¶æ•°æ®å†…å®¹ï¼Œä¸åŒ…å«å…ƒæ•°æ®ï¼›å› æ­¤å®¢æˆ·ç«¯æ— æ³•å¾—çŸ¥å…·ä½“çš„æ•°æ®ç±»å‹ï¼Œä¸ä¾¿äºåç»­å¤„ç†ã€‚ä¾‹å¦‚ï¼šå®¢æˆ·ç«¯éœ€è¦å°†äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨ä¸ºæ–‡ä»¶ï¼Œä½†æ— æ³•ç¡®å®šå®ƒæ˜¯éŸ³é¢‘è¿˜æ˜¯è§†é¢‘ï¼Œä¿å­˜æ—¶å°±æ— ä»é€‰æ‹©æ­£ç¡®çš„æ‰©å±•åã€‚

æˆ‘ä»¬å¯ä»¥é‡å†™ContentProviderçš„ `String getType(Uri uri)` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°ä¸ºå®¢æˆ·ç«¯æ‰€è¯·æ±‚çš„èµ„æºURIï¼Œè¿”å›å€¼ä¸ºèµ„æºçš„MIMEç±»å‹ã€‚å®¢æˆ·ç«¯åœ¨æ“ä½œæ•°æ®æµä¹‹å‰å¯ä»¥å…ˆè°ƒç”¨æ­¤æ–¹æ³•æŸ¥è¯¢æ•°æ®ç±»å‹ï¼Œå†åšå‡ºç›¸åº”çš„åŠ¨ä½œã€‚

"ShareFileProvider.java":

```java
@Nullable
@Override
public String getType(@NonNull Uri uri) {
    String mime = null;

    int code = uriMatcher.match(uri);
    switch (code) {
        /* "textfile"è¯·æ±‚ï¼Œå¯¹åº”çº¯æ–‡æœ¬æ–‡ä»¶ã€‚ */
        case 101:
            mime = "text/plain";
            break;
        /* "configfile"è¯·æ±‚ï¼Œå¯¹åº”JSONé…ç½®æ–‡ä»¶ã€‚ */
        case 102:
            mime = "application/json";
            break;
    }

    return mime;
}
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­ï¼ŒURI `content://net.bi4vmr.provider.sharefile/textfile` å¯¹åº”çš„èµ„æºä¸ºçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬è¿”å›çš„MIMEç±»å‹ä¸º"text/plain"ï¼›URI `content://net.bi4vmr.provider.sharefile/configfile` å¯¹åº”çš„èµ„æºä¸ºJSONé…ç½®æ–‡ä»¶ï¼Œå› æ­¤MIMEç±»å‹ä¸º"application/json"ã€‚

è¯¥æ–¹æ³•å¿…é¡»è¢«é‡å†™ï¼Œä½†å†…éƒ¨é€»è¾‘æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸å®¢æˆ·ç«¯é€šè¿‡æ¥å£æ–‡æ¡£ç­‰å…¶ä»–æ–¹å¼çº¦å®šäº†æ•°æ®æ ¼å¼ï¼Œæ­¤å¤„å¯ä»¥ç›´æ¥è¿”å›ç©ºå€¼ã€‚

## å®¢æˆ·ç«¯å®ç°
å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨ContentResolverçš„ `String getType(Uri uri)` æ–¹æ³•å¹¶ä¼ å…¥èµ„æºURIï¼ŒæŸ¥è¯¢èµ„æºçš„æ•°æ®ç±»å‹ã€‚

"TestUIBase.java":

```java
Uri uri = Uri.parse("content://net.bi4vmr.provider.sharefile/textfile");
ContentResolver contentResolver = getContentResolver();
String mime = contentResolver.getType(uri);
Log.i(TAG, "'text'æ–‡ä»¶çš„ç±»å‹ï¼š" + mime);
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­ï¼Œèµ„æº"textfile"çš„MIMEç±»å‹ä¸º"text/plain"ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¾¿å¯å¾—çŸ¥è¯¥æ•°æ®æµä¸ºçº¯æ–‡æœ¬ï¼Œä¿å­˜æ–‡ä»¶æ—¶åº”å½“æ·»åŠ åç¼€".txt"ã€‚

# æ–‡ä»¶è¯»å–åŠŸèƒ½
## æœåŠ¡ç«¯å®ç°
æœåŠ¡ç«¯å¹¶ä¸å…³å¿ƒå®¢æˆ·ç«¯æ‰§è¡Œçš„åŠ¨ä½œæ˜¯è¯»å–è¿˜æ˜¯å†™å…¥ï¼Œå®ƒåªè´Ÿè´£æä¾›æ–‡ä»¶çš„å¥æŸ„ï¼ˆåœ¨Linuxä¸­ä¹Ÿè¢«ç§°ä¸ºæ–‡ä»¶æè¿°ç¬¦ï¼‰ç»™å®¢æˆ·ç«¯ï¼Œå…·ä½“çš„åŠ¨ä½œç”±å®¢æˆ·ç«¯å†³å®šã€‚å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œæ‰“å¼€èµ„æºçš„è¾“å…¥æµå³è¡¨ç¤ºä»æœåŠ¡ç«¯è¯»å–æ•°æ®ï¼›æ‰“å¼€èµ„æºçš„è¾“å‡ºæµåˆ™è¡¨ç¤ºå†™å…¥æ•°æ®åˆ°æœåŠ¡ç«¯ã€‚

å½“å®¢æˆ·ç«¯æ‰“å¼€èµ„æºçš„è¾“å…¥æµæˆ–è¾“å‡ºæµæ—¶ï¼ŒContentProviderçš„ `openFile()` å›è°ƒæ–¹æ³•å°†ä¼šè§¦å‘ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é‡å†™è¯¥æ–¹æ³•ï¼Œå®ç°åˆ›å»ºæ–‡ä»¶å¥æŸ„çš„ç›¸å…³é€»è¾‘ã€‚

"ShareFileProvider.java":

```java
@Nullable
@Override
public ParcelFileDescriptor openFile(@NonNull Uri uri, @NonNull String mode) throws FileNotFoundException {
    ParcelFileDescriptor parcelFileDescriptor = null;

    int code = uriMatcher.match(uri);
    switch (code) {
        /* "textfile"è¯»å–è¯·æ±‚ï¼Œå¯¹åº”çº¯æ–‡æœ¬æ–‡ä»¶ã€‚ */
        case 101: {
            Log.i(TAG, "åŒ¹é…åˆ°textfileè¯·æ±‚ã€‚");
            try {
                // åˆ¤æ–­æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                File textFile = new File(getContext().getFilesDir(), "text.txt");
                if (textFile.exists()) {
                    // æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¿”å›å®ƒçš„æ–‡ä»¶æè¿°ç¬¦ç»™å®¢æˆ·ç«¯ï¼Œæ¨¡å¼ä¸ºåªè¯»ã€‚
                    parcelFileDescriptor =
                            ParcelFileDescriptor.open(textFile, ParcelFileDescriptor.MODE_READ_ONLY);
                } else {
                    Log.w(TAG, "File not found.");
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        break;
        /* "configfile"å†™å…¥è¯·æ±‚ï¼Œå¯¹åº”JSONé…ç½®æ–‡ä»¶ã€‚ */
        case 102: {
            /* è¿”å›æ–‡ä»¶"config.json"çš„æè¿°ç¬¦ï¼Œæ­¤å¤„çœç•¥ç›¸å…³ä»£ç ... */
        }
        break;
    }

    return parcelFileDescriptor;
}
```

è¯¥å›è°ƒæ–¹æ³•å„ä¸ªå‚æ•°çš„è¯¦æƒ…è§ä¸‹æ–‡å†…å®¹ï¼š

- å‚æ•° `uri` : è¡¨ç¤ºå®¢æˆ·ç«¯æŸ¥è¯¢çš„èµ„æºåœ°å€ã€‚æˆ‘ä»¬é¦–å…ˆä½¿ç”¨UriMatcherè¿›è¡Œè§£æï¼Œè¯†åˆ«å‡ºå…·ä½“çš„è¯·æ±‚ã€‚
- å‚æ•° `mode` : è¡¨ç¤ºæƒé™ä¸æ“ä½œæ¨¡å¼ï¼Œæ„é€ æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€ä¼ å®¢æˆ·ç«¯æŒ‡å®šçš„å‚æ•°ï¼›ä¸ºäº†å®‰å…¨èµ·è§ï¼Œåœ¨æœ¬ç¤ºä¾‹ä¸­ä¸é‡‡ç”¨å®¢æˆ·ç«¯ä¼ é€’çš„å‚æ•°ï¼Œè€Œæ˜¯é™å®š"text.txt"æ–‡ä»¶çš„æƒé™ä¸ºåªè¯»ã€‚

è¿”å›å€¼ParcelFileDescriptoræ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“å®ƒè¢«Binderé©±åŠ¨è·¨è¿›ç¨‹ä¼ é€’ç»™å®¢æˆ·ç«¯åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è®¿é—®ç›®æ ‡æ–‡ä»¶äº†ã€‚

ParcelFileDescriptorå®ä¾‹å¯ä»¥é€šè¿‡ParcelFileDescriptorç±»çš„é™æ€æ–¹æ³• `open(File file, int mode)` æ„é€ ï¼Œç¬¬ä¸€ä¸ªå‚æ•° `file` ä¸ºç›®æ ‡æ–‡ä»¶çš„Fileå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•° `mode` ä¸ºæƒé™ä¸æ“ä½œæ¨¡å¼ã€‚

æƒé™ä¸æ“ä½œæ¨¡å¼å¯ä»¥åŒæ—¶è®¾ç½®å¤šä¸ªæœ‰æ•ˆå€¼ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨æˆ–è¿ç®—ç¬¦å·è¿›è¡Œè¿æ¥ï¼Œå¸¸ç”¨çš„å€¼åŠå…¶å«ä¹‰å¯å‚è§ä¸‹æ–‡åˆ—è¡¨ï¼š

<div align="center">

|      æ ‡å¿—ä½       |              å«ä¹‰              |
| :---------------: | :----------------------------: |
| `MODE_READ_ONLY`  |              åªè¯»              |
| `MODE_WRITE_ONLY` |              åªå†™              |
| `MODE_READ_WRITE` |              è¯»å†™              |
|   `MODE_CREATE`   |   è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºã€‚   |
|   `MODE_APPEND`   |  åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å†™å…¥æ–°çš„å†…å®¹ã€‚  |
|  `MODE_TRUNCATE`  | æ¸…ç©ºæ—§çš„å†…å®¹ï¼Œå†å†™å…¥æ–°çš„å†…å®¹ã€‚ |

</div>

## å®¢æˆ·ç«¯å®ç°
å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨ContentResolverå®ä¾‹çš„ `InputStream openInputStream(Uri uri)` æ–¹æ³•å¹¶ä¼ å…¥èµ„æºURIï¼Œè·å–æ–‡ä»¶çš„è¾“å…¥æµï¼Œç„¶åä»æœåŠ¡ç«¯è¯»å–æ•°æ®ã€‚

"TestUIBase.java":

```java
// æ–‡æœ¬æ–‡ä»¶çš„URI
Uri uri = Uri.parse("content://net.bi4vmr.study.provider2/textfile");

ContentResolver contentResolver = getContentResolver();
InputStream is;
InputStreamReader reader = null;
StringBuilder stringBuffer = new StringBuilder();
try {
    // æ‰“å¼€è¾“å…¥æµ
    is = contentResolver.openInputStream(uri);
    // æœåŠ¡ç«¯å¯èƒ½è¿”å›ç©ºå€¼ï¼Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚
    if (is == null) {
        tvLog.append("æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚\n");
        Log.w(TAG, "æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚");
        return;
    }

    reader = new InputStreamReader(is);
    char[] buffer = new char[8];
    // å¾ªç¯è¯»å–æ–‡ä»¶å†…å®¹
    while (true) {
        int count = reader.read(buffer);
        if (count == -1) {
            break;
        }
        String data = new String(buffer, 0, count);
        stringBuffer.append(data);
    }
} catch (Exception e) {
    e.printStackTrace();
} finally {
    CloseUtils.closeIOQuietly(reader);
}

Log.i(TAG, "æ–‡ä»¶å†…å®¹:" + stringBuffer);
```

æ­¤æ—¶è¿è¡Œå®¢æˆ·ç«¯ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
12:21:08.683 30829 30853 I TestApp-Server-ShareFileProvider: OpenFile. URI:content://net.bi4vmr.study.provider2/textfile
12:21:08.683 30829 30853 I TestApp-Server-ShareFileProvider: åŒ¹é…åˆ°textfileè¯·æ±‚ã€‚
12:21:08.692 30914 30914 I TestApp-Client-TestUIBase: æ–‡ä»¶å†…å®¹:GNU is not unix
12:21:08.692 30914 30914 I TestApp-Client-TestUIBase: WINE is not an emulator
12:21:08.692 30914 30914 I TestApp-Client-TestUIBase: æˆ‘èƒ½åä¸‹ç»ç’ƒè€Œä¸ä¼¤èº«ä½“ã€‚
```

# æ–‡ä»¶å†™å…¥åŠŸèƒ½
## æœåŠ¡ç«¯å®ç°
å†™å…¥æ–‡ä»¶çš„åŠŸèƒ½ä¸è¯»å–æ–‡ä»¶æ˜¯ç±»ä¼¼çš„ï¼ŒæœåŠ¡ç«¯åªéœ€è¿”å›ç›®æ ‡æ–‡ä»¶çš„æè¿°ç¬¦ç»™å®¢æˆ·ç«¯å³å¯ã€‚

"ShareFileProvider.java":

```java
try {
    File jsonFile = new File(getContext().getFilesDir(), "config.json");
    // è¿”å›å®ƒçš„æ–‡ä»¶æè¿°ç¬¦ç»™å®¢æˆ·ç«¯ï¼Œæ¨¡å¼ä¸ºåªå†™ã€è‡ªåŠ¨åˆ›å»ºã€‚
    int fdMode = ParcelFileDescriptor.MODE_WRITE_ONLY | ParcelFileDescriptor.MODE_CREATE;
    parcelFileDescriptor = ParcelFileDescriptor.open(jsonFile, fdMode);
} catch (Exception e) {
    e.printStackTrace();
}
```

## å®¢æˆ·ç«¯å®ç°
å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨ContentResolverå®ä¾‹çš„ `OutputStream openOutputStream(Uri uri)` æ–¹æ³•å¹¶ä¼ å…¥èµ„æºURIï¼Œè·å–æ–‡ä»¶çš„è¾“å‡ºæµï¼Œç„¶åå‘æœåŠ¡ç«¯å†™å…¥æ•°æ®ã€‚

"TestUIBase.java":

```java
// å¾…å†™å…¥çš„æ•°æ®
final String jsonData = "{ \"number\" : 100 }";
// é…ç½®æ–‡ä»¶çš„URI
Uri uri = Uri.parse("content://net.bi4vmr.study.provider2/configfile");

ContentResolver contentResolver = getContentResolver();
OutputStream os;
OutputStreamWriter writer = null;
try {
    // æ‰“å¼€è¾“å‡ºæµ
    os = contentResolver.openOutputStream(uri);
    // æœåŠ¡ç«¯å¯èƒ½è¿”å›ç©ºå€¼ï¼Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚
    if (os == null) {
        Log.w(TAG, "æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚");
        return;
    }

    // è¾“å‡ºæµå°±ç»ªï¼Œå¼€å§‹å†™å…¥æ–‡æœ¬ã€‚
    writer = new OutputStreamWriter(os);
    writer.write(jsonData);
    Log.i(TAG, "æ–‡ä»¶å†™å…¥å·²å®Œæˆï¼Œè¯·adb pullæ£€æŸ¥ã€‚");
} catch (Exception e) {
    e.printStackTrace();
} finally {
    CloseUtils.closeIOQuietly(writer);
}
```

æ­¤æ—¶è¿è¡Œå®¢æˆ·ç«¯ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æœåŠ¡ç«¯ç¨‹åºçš„æ–‡ä»¶ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° `config.json` æ–‡ä»¶çš„å†…å®¹ä¸å®¢æˆ·ç«¯ `jsonData` å˜é‡çš„å†…å®¹ä¸€è‡´ï¼Œè¯´æ˜å†™å…¥æ“ä½œæˆåŠŸã€‚
