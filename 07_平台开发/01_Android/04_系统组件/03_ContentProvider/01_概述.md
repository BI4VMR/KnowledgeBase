# ç®€ä»‹
ContentProvideræä¾›äº†å½¢å¼ç»Ÿä¸€çš„æ¥å£ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºä¹‹é—´ç›¸äº’å…±äº«æ•°æ®ï¼Œä¾‹å¦‚ï¼šè”ç³»äººä¿¡æ¯ã€éŸ³ä¹ä¿¡æ¯ã€å¤šåª’ä½“æ–‡ä»¶ç­‰ã€‚

ContentProviderä½œä¸ºæœåŠ¡ç«¯ï¼Œä½¿ç”¨URIè¡¨æ˜è‡ªå·±çš„èº«ä»½ï¼›ContentResolverä½œä¸ºå®¢æˆ·ç«¯ï¼Œèƒ½å¤Ÿè°ƒç”¨å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ¥å£å¯¹æœåŠ¡ç«¯çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿˜å¯ä»¥æ³¨å†ŒContentObserveræ¥ç›‘å¬æ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚

æœ¬ç« çš„ç¤ºä¾‹å·¥ç¨‹è¯¦è§ä»¥ä¸‹é“¾æ¥ï¼š

- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šæ¦‚è¿°](https://github.com/BI4VMR/Study-Android/tree/master/M04_System/C04_ContentProvider/S01_Base)

# ç†è®ºåŸºç¡€
# URI
ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦(Uniform Resource Identifier, URI)æ˜¯ç”¨æ¥å…¨å±€è¡¨ç¤ºæŸä¸ªèµ„æºçš„åœ°å€ï¼Œå®ƒæ˜¯URLçš„è¶…é›†ã€‚

ç³»ç»Ÿæä¾›äº†ä¸€äº›å†…ç½®çš„URIç”¨äºè®¿é—®è”ç³»äººç­‰ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¼–å†™æ–°çš„URIæ¥æè¿°è‡ªå®šä¹‰æ•°æ®ã€‚

URIçš„è¯­æ³•å¦‚ä¸‹æ–‡ä»£ç å—æ‰€ç¤ºï¼š

```text
# è¯­æ³•
<ä¸»é¢˜åç§°>://<æˆæƒè®°å½•>/<å®ä½“åç§°>/[è®°å½•åç§°]?[æŸ¥è¯¢å‚æ•°]

# ç¤ºä¾‹ï¼šè”ç³»äººAlice
content://com.android.contacts/contacts/Alice
```

ä¸Šæ–‡ä»£ç å—ä¸­çš„å„ä¸ªéƒ¨åˆ†å«ä¹‰è¯¦è§ä¸‹æ–‡å†…å®¹ï¼š

ğŸ”· ä¸»é¢˜(Scheme)

åè®®ç±»å‹ã€‚

å¸¸è§çš„å–å€¼æœ‰"http"ã€"file"ç­‰ï¼Œåœ¨ContentProviderä¸­ä¸»é¢˜å›ºå®šä¸º"content"ã€‚

ğŸ”· æˆæƒè®°å½•(Authority)

æœåŠ¡æä¾›è€…ã€‚

å¸¸è§çš„å–å€¼æœ‰ä¸»æœºåã€IPåœ°å€ç­‰ï¼Œåœ¨ContentProviderä¸­ä¸ºåº”ç”¨ç¨‹åºçš„åŒ…åã€‚

ğŸ”· å®ä½“åç§°

è¡¨ç¤ºå¾…æŸ¥è¯¢çš„å®ä½“ï¼Œä¸å®é™…æ•°æ®ç±»å‹æ— å…³ï¼Œå…·ä½“å«ä¹‰ç”±æœåŠ¡ç«¯å®šä¹‰ã€‚

ğŸ”· è®°å½•åç§°

è¡¨ç¤ºè®°å½•åç§°ï¼Œå¯¹åº”å…·ä½“çš„æ•°æ®é¡¹ã€‚

ğŸ”· æŸ¥è¯¢å‚æ•°

è¡¨ç¤ºæŸ¥è¯¢å‚æ•°ï¼Œç±»ä¼¼äºHTTPçš„æŸ¥è¯¢å‚æ•°ã€‚

<br />

URIä¸­å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œå…¶ä¸­æ˜Ÿå·( `*` )è¡¨ç¤ºä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œäº•å·( `#` )è¡¨ç¤ºä»»æ„é•¿åº¦çš„æ•°å­—å­—ç¬¦ä¸²ã€‚

åœ¨Android SDKä¸­ï¼ŒURIä½¿ç”¨ `android.net.Uri` ç±»è¡¨ç¤ºï¼ˆä¸ `java.net.URI` æ˜¯ä¸åŒçš„ç±»ï¼‰ï¼Œå®ƒçš„å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹æ–‡ä»£ç å—æ‰€ç¤ºï¼š


ğŸ”´ ç¤ºä¾‹ä¸€ï¼šUriç±»çš„åŸºæœ¬åº”ç”¨ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è·å–Uriå¯¹è±¡ï¼Œå¹¶è§£æURIä¸­çš„å„ä¸ªç»„æˆéƒ¨åˆ†ã€‚

"TestUIURI.java":

```java
String input = "content://net.bi4vmr.study.provider/user?name=admin";

// è½¬æ¢URIæ–‡æœ¬ä¸ºUriå¯¹è±¡
Uri uri = Uri.parse(input);
// è·å–åè®®
Log.i(TAG, "Scheme:[" + uri.getScheme() + "]");
// è·å–æˆæƒè®°å½•
Log.i(TAG, "Authority:[" + uri.getAuthority() + "]");
// è·å–è¯·æ±‚è·¯å¾„
Log.i(TAG, "Path:[" + uri.getPath() + "]");
// è·å–æŸ¥è¯¢å‚æ•°
Log.i(TAG, "Query:[" + uri.getQuery() + "]");
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

```kotlin
val input = "content://net.bi4vmr.study.provider/user?name=admin"

// è½¬æ¢URIæ–‡æœ¬ä¸ºUriå¯¹è±¡
val uri = Uri.parse(input)
// è·å–åè®®
Log.i(TAG, "Scheme:[${uri.scheme}]")
// è·å–æˆæƒè®°å½•
Log.i(TAG, "Authority:[${uri.authority}]")
// è·å–è¯·æ±‚è·¯å¾„
Log.i(TAG, "Path:[${uri.path}]")
// è·å–æŸ¥è¯¢å‚æ•°
Log.i(TAG, "Query:[${uri.query}]")
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
17:23:01.691 23867 23867 I TestApp: Scheme:[content]
17:23:01.692 23867 23867 I TestApp: Authority:[net.bi4vmr.study.provider]
17:23:01.693 23867 23867 I TestApp: Path:[/user]
17:23:01.694 23867 23867 I TestApp: Query:[name=admin]
```

å¦‚æœä¼ å…¥çš„URIç¼ºå°‘æŸä¸ªéƒ¨åˆ†ï¼Œå¯¹åº”çš„æ–¹æ³•å°†ä¼šè¿”å›ç©ºå€¼ã€‚

# UriMatcher
UriMatcheræ˜¯ä¸€ç§URIåŒ¹é…å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆé…ç½®å¤šç»„URIä¸æ•°å­—ç¼–ç çš„æ˜ å°„å…³ç³»ï¼Œåœ¨ContentProvideræ”¶åˆ°æŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œå°†URIè½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­—ç¼–ç ï¼Œä»¥ä¾¿åŒºåˆ†ä¸åŒçš„è¯·æ±‚ï¼Œå¹¶åšå‡ºè¿›ä¸€æ­¥å¤„ç†ã€‚

```java
// åˆ›å»ºUriMatcherå¯¹è±¡
UriMatcher matcher = new UriMatcher(UriMatcher.NO_MATCH);
// æ·»åŠ åŒ¹é…æ¡ç›®
matcher.addURI("net.bi4vmr.study.provider", "student", 101);
matcher.addURI("net.bi4vmr.study.provider", "course", 102);
```

åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `addURI()` æ–¹æ³•æ³¨å†Œæ˜ å°„å…³ç³»ï¼Œè¯¥æ–¹æ³•çš„å‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºæˆæƒè®°å½•å’Œå®ä½“åç§°ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯æ•°å­—ç¼–ç ã€‚

å½“æˆ‘ä»¬æ”¶åˆ°å®¢æˆ·ç«¯çš„æŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œå¯ä»¥è°ƒç”¨ `match()` æ–¹æ³•å¹¶ä¼ å…¥è¯·æ±‚URIï¼ŒUriMatcherå°†ä¼šè¿”å›å¯¹åº”çš„æ•°å­—ç¼–ç ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ•°å­—ç¼–ç åŒºåˆ†ä¸åŒçš„åŠ¨ä½œã€‚

```java
/*
 * åŒ¹é…å¤–éƒ¨ä¼ å…¥çš„URI
 * æ­¤å¤„ä¼ å…¥å›ºå®šçš„å­—ç¬¦ä¸²ä½œä¸ºç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶å¯ä»¥ä¼ å…¥åŠ¨æ€çš„å‚æ•°ã€‚
 */
Uri uri = Uri.parse("content://net.bi4vmr.study.provider/student?name=admin");
int code = matcher.match(uri);
switch (code) {
    case 101:
        Log.i(TAG, "åŒ¹é…åˆ°studentè¯·æ±‚ã€‚");
        break;
    case 102:
        Log.i(TAG, "åŒ¹é…åˆ°courseè¯·æ±‚ã€‚");
        break;
    default:
        Log.w(TAG, "æœªçŸ¥è·¯å¾„ã€‚ code:[" + code + "]");
        break;
}
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­ï¼Œæ­¤URIå°†ä¼šåŒ¹é…åˆ°"student"é¡¹ï¼Œå¹¶è¿”å›æ•°å­—ç¼–ç "101"ã€‚

# MIME
MIMEæ˜¯ä¸€å¥—é€šç”¨çš„æ•°æ®ç±»å‹æè¿°è§„èŒƒï¼Œæ­¤å¤„çœç•¥å…·ä½“æè¿°ï¼Œè¯¦è§ç›¸å…³ç« èŠ‚ï¼š [ğŸ§­ ç½‘ç»œæŠ€æœ¯ - MIME](../../../../02_é€šä¿¡æŠ€æœ¯/01_ç½‘ç»œæŠ€æœ¯/07_åº”ç”¨å±‚/02_ç½‘é¡µæµè§ˆ/01_HTTP.md#mime) ã€‚

å¯¹äºContentProviderä¸­çš„å…³ç³»å‹æ•°æ®ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªæ¦‚ç•¥ç±»å‹è¡¨ç¤ºï¼š

- `vnd.android.cursor.item` : è¿”å›ç»“æœä¸ºå•æ¡è®°å½•ã€‚
- `vnd.android.cursor.dir` : è¿”å›ç»“æœä¸ºå¤šæ¡è®°å½•ã€‚

è¯¦ç»†ç±»å‹å›ºå®šä»¥"vnd"å¼€å¤´ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥è‡ªè¡Œå®šä¹‰ã€‚

ä»¥å­¦ç”Ÿä¿¡æ¯è¡¨Studentä¸ºä¾‹ï¼š

å½“æˆ‘ä»¬æŸ¥è¯¢ `content://net.bi4vmr.study.provider/student/*` æ—¶ï¼Œè¿”å›å†…å®¹ä¸ºå¤šæ¡ï¼Œæ­¤æ—¶MIMEåº”å½“ä¸º `vnd.android.cursor.dir/vnd.mpapp.student` ã€‚

å½“æˆ‘ä»¬æŸ¥è¯¢ `content://net.bi4vmr.study.provider/student/1` æ—¶ï¼Œè¿”å›å†…å®¹ä¸ºå•æ¡ï¼Œæ­¤æ—¶MIMEåº”å½“ä¸º `vnd.android.cursor.item/vnd.mpapp.student` ã€‚

å¯¹äºContentProviderä¸­çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæˆ‘ä»¬åº”å½“æŒ‰ç…§RFCè§„èŒƒè¿›è¡Œè¡¨ç¤ºã€‚
