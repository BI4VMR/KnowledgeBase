# ç®€ä»‹
æœ¬ç« å†…å®¹æ¦‚ç•¥åœ°ä»‹ç»äº†Androidå¼€å‘ä¸­çš„ä¸»è¦æµ‹è¯•æ–¹å¼ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ­å»ºåŠä½¿ç”¨Androidæµ‹è¯•ç¯å¢ƒã€‚

æœ¬ç« çš„ç¤ºä¾‹å·¥ç¨‹è¯¦è§ä»¥ä¸‹é“¾æ¥ï¼š

- [ğŸ”— ç¤ºä¾‹å·¥ç¨‹ï¼šAndroidæµ‹è¯•å·¥å…·](https://github.com/BI4VMR/Study-Android/tree/master/M02_Tool/C03_Test/S01_Base)


# æœ¬åœ°æµ‹è¯•
## ç®€ä»‹
Androidå·¥ç¨‹ä¸æ ‡å‡†çš„Maven Javaå·¥ç¨‹ç»“æ„ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `<æ¨¡å—æ ¹ç›®å½•>/src/test/java/` ç­‰ç›®å½•ä¸‹æ”¾ç½®æµ‹è¯•ä»£ç ï¼Œè¿™ç§æµ‹è¯•ä»£ç è¿è¡Œåœ¨PCç«¯çš„JVMä¸Šï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶ç§°ä¸ºâ€œæœ¬åœ°æµ‹è¯•â€ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯æ‰§è¡Œé€Ÿåº¦è¾ƒå¿«ï¼Œæ— éœ€Androidè®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨ï¼›ç¼ºç‚¹åˆ™æ˜¯æ— æ³•ç›´æ¥æµ‹è¯•åŒ…å«Android SDKæ¥å£è°ƒç”¨çš„ä»£ç ã€‚

æœ¬åœ°æµ‹è¯•ç¯å¢ƒçš„æ­å»ºæ–¹å¼å¯å‚è€ƒç›¸å…³ç« èŠ‚ï¼š [ğŸ§­ JUnit - åŸºæœ¬åº”ç”¨](../../../../06_ç¼–ç¨‹è¯­è¨€/03_Java/04_å®ç”¨å·¥å…·/04_æµ‹è¯•å·¥å…·/02_JUnit.md#åŸºæœ¬åº”ç”¨) ã€‚

> ğŸš© æç¤º
>
> Robolectricæ¡†æ¶èƒ½å¤Ÿåœ¨PCç«¯çš„JVMä¸Šæ¨¡æ‹ŸAndroidè¿è¡Œç¯å¢ƒï¼Œå¯¹äºä¸åŒ…å«å¤æ‚UIäº¤äº’çš„ä¸šåŠ¡ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¯¥å·¥å…·æ‰§è¡Œæœ¬åœ°æµ‹è¯•ï¼Œè¯¦æƒ…å¯å‚è€ƒç›¸å…³ç« èŠ‚ï¼š [ğŸ§­ Robolectric - ç®€ä»‹](02_Robolectric.md#ç®€ä»‹) ã€‚

## é€šè¿‡IDEè¿è¡Œæµ‹è¯•
å½“æˆ‘ä»¬ç¼–å†™ä»£ç æ—¶ï¼Œå¯ä»¥é€šè¿‡Android Studioè¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š

<div align="center">

![é€šè¿‡IDEè¿è¡Œæµ‹è¯•ç”¨ä¾‹](./Assets_æ¦‚è¿°/æœ¬åœ°æµ‹è¯•_é€šè¿‡IDEè¿è¡Œæµ‹è¯•ç”¨ä¾‹.jpg)

</div>

ç‚¹å‡»æµ‹è¯•ç±»å‰çš„åŒç®­å¤´å¹¶åœ¨å¼¹å‡ºèœå•ä¸­é€‰æ‹© `Run ...` é€‰é¡¹ï¼Œå¯ä»¥è¿è¡Œå½“å‰æµ‹è¯•ç±»ä¸­çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼›ç‚¹å‡»æµ‹è¯•æ–¹æ³•å‰çš„ç®­å¤´å¹¶åœ¨èœå•ä¸­é€‰æ‹© `Run ...` é€‰é¡¹ï¼Œå¯ä»¥è¿è¡Œå½“å‰æµ‹è¯•æ–¹æ³•ã€‚

## é€šè¿‡å‘½ä»¤è¡Œè¿è¡Œæµ‹è¯•
æˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¹¶ç”ŸæˆæŠ¥å‘Šï¼Œè¿™åœ¨CI/CDç­‰ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ï¼š

```text
# æ‰§è¡Œæ‰€æœ‰æ¨¡å—çš„æœ¬åœ°æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew test

# æ‰§è¡Œç‰¹å®šæ¨¡å—çš„æœ¬åœ°æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew <æ¨¡å—åç§°>:test

# æ‰§è¡Œç‰¹å®šæ¨¡å—çš„æœ¬åœ°æµ‹è¯•ï¼Œå¹¶æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ã€‚
[bi4vmr@Fedora Project]$ ./gradlew <æ¨¡å—åç§°>:test -i

# æ‰§è¡Œç‰¹å®šæ¨¡å—çš„ç‰¹å®šæœ¬åœ°æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew <æ¨¡å—åç§°>:test --tests "<æµ‹è¯•ç±»åç§°>"

# æ‰§è¡Œç‰¹å®šæ¨¡å—çš„ç‰¹å®šæœ¬åœ°æµ‹è¯•æ–¹æ³•
[bi4vmr@Fedora Project]$ ./gradlew <æ¨¡å—åç§°>:test --tests "<æµ‹è¯•ç±»åç§°>.<æµ‹è¯•æ–¹æ³•åç§°>"


# æ‰§è¡ŒDebug Variantçš„æœ¬åœ°æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew testDebugUnitTest

# æ‰§è¡ŒRelease Variantçš„æœ¬åœ°æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew testReleaseUnitTest

# æ‰§è¡Œç‰¹å®šVariantçš„æœ¬åœ°æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew test<Variantåç§°>UnitTest
```

`test` å‘½ä»¤ä¼šä¾æ¬¡æ‰§è¡Œæ‰€æœ‰Build Variantçš„æœ¬åœ°æµ‹è¯•ï¼Œè¿è¡Œé€Ÿåº¦è¾ƒæ…¢ï¼Œé€šå¸¸æˆ‘ä»¬é€‰æ‹© `testDebugUnitTest` å‘½ä»¤æ‰§è¡ŒDebug Variantçš„æµ‹è¯•ç”¨ä¾‹å³å¯ã€‚


# ä»ªå™¨åŒ–æµ‹è¯•
## ç®€ä»‹
ä»ªå™¨åŒ–æµ‹è¯•å°†ä¼šç”ŸæˆAPKï¼Œéœ€è¦åœ¨ç‰©ç†è®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨ä¸­è¿è¡Œï¼Œå› æ­¤èƒ½å¤Ÿæµ‹è¯•åŒ…å«Android SDKæ¥å£çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ `<æ¨¡å—æ ¹ç›®å½•>/src/androidTest/java/` ç­‰ç›®å½•ä¸‹æ”¾ç½®æµ‹è¯•ä»£ç ã€‚

## ç¯å¢ƒæ­å»º
é€šè¿‡Android Studioåˆ›å»ºçš„åˆå§‹å·¥ç¨‹å·²ç»åŒ…å«äº†ä»ªå™¨åŒ–æµ‹è¯•ç¯å¢ƒï¼Œæˆ‘ä»¬ä¸å¿…æ‰‹åŠ¨æ·»åŠ é…ç½®ã€‚

ä¸‹æ–‡ç¤ºä¾‹é’ˆå¯¹æ²¡æœ‰ä»ªå™¨åŒ–æµ‹è¯•ç¯å¢ƒçš„å·¥ç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”±æ­¤äº†è§£ä¸ä»ªå™¨åŒ–æµ‹è¯•æœ‰å…³çš„å¿…å¤‡é…ç½®é¡¹ã€‚

ğŸ”´ ç¤ºä¾‹ä¸€ï¼šæ„å»ºä»ªå™¨åŒ–æµ‹è¯•ç¯å¢ƒã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºå·¥ç¨‹æ·»åŠ ä»ªå™¨åŒ–æµ‹è¯•æ”¯æŒã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨æ¨¡å—çš„Gradleé…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»ªå™¨åŒ–æµ‹è¯•ç›¸å…³é…ç½®ã€‚

"build.gradle":

```groovy
android {
    defaultConfig {
        // æŒ‡å®šä»ªå™¨åŒ–æµ‹è¯•è¿è¡Œç¯å¢ƒ
        testInstrumentationRunner = 'androidx.test.runner.AndroidJUnitRunner'
    }
}

dependencies {
    /* ä»ªå™¨åŒ–æµ‹è¯•ä¾èµ–é¡¹ */
    // JUnit4
    androidTestImplementation 'junit:junit:4.13.2'
    // AndroidX Test JUnitæ‰©å±•
    androidTestImplementation 'androidx.test.ext:junit:1.2.1'
    // AndroidX Test Espressoè¿è¡Œç¯å¢ƒ
    androidTestImplementation  'androidx.test.espresso:espresso-core:3.6.1'
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"build.gradle.kts":

```kotlin
android {
    defaultConfig {
        // æŒ‡å®šä»ªå™¨åŒ–æµ‹è¯•è¿è¡Œç¯å¢ƒ
        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }
}

dependencies {
    /* ä»ªå™¨åŒ–æµ‹è¯•ä¾èµ–é¡¹ */
    // JUnit4
    androidTestImplementation("junit:junit:4.13.2")
    // AndroidX Test JUnitæ‰©å±•
    androidTestImplementation("androidx.test.ext:junit:1.2.1")
    // AndroidX Test Espressoè¿è¡Œç¯å¢ƒ
    androidTestImplementation("androidx.test.espresso:espresso-core:3.6.1")
}
```

`androidTestImplementation` åªå¯¹ä»ªå™¨åŒ–æµ‹è¯•ç”Ÿæ•ˆï¼Œä¸ä¼šè‡ªåŠ¨å¤ç”¨é€šè¿‡ `testImplementation` å£°æ˜çš„ä¾èµ–é¡¹ã€‚

> ğŸš© æç¤º
>
> Androidä»ªå™¨åŒ–æµ‹è¯•å·¥å…·ç›®å‰ä»…æ”¯æŒä¸JUnit4é›†æˆï¼Œè¯·å‹¿å°†å…¶æ›´æ”¹ä¸ºJUnit5æˆ–å…¶ä»–æµ‹è¯•æ¡†æ¶ï¼Œä»¥å…é‡åˆ°å…¼å®¹æ€§é—®é¢˜ã€‚

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨ä»ªå™¨åŒ–æµ‹è¯•ä»£ç ç›®å½•ä¸­åˆ›å»ºæµ‹è¯•ç±»ã€‚

"TestInstrument.java":

```java
@RunWith(AndroidJUnit4.class)
public class TestInstrument {

    @Test
    public void useAppContext() {
        // è·å–ä»ªå™¨åŒ–æµ‹è¯•ç¯å¢ƒä¸‹çš„Context
        Context appContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
        // è®¿é—®Androidèµ„æº
        String appName = appContext.getString(R.string.app_name);
        Log.d("Test", "åº”ç”¨åç§°ï¼š" + appName);
    }
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"TestInstrumentKT.kt":

```kotlin
@RunWith(AndroidJUnit4::class)
class TestInstrumentKT {

    @Test
    fun useAppContext() {
        // è·å–ä»ªå™¨åŒ–æµ‹è¯•ç¯å¢ƒä¸‹çš„Context
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        // è®¿é—®Androidèµ„æº
        val appName: String = appContext.getString(R.string.app_name)
        Log.d("Test", "åº”ç”¨åç§°ï¼š$appName")
    }
}
```

å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æµ‹è¯•ä»£ç ä¸­ä½¿ç”¨Applicationæˆ–Contextï¼Œéœ€è¦åœ¨æµ‹è¯•ç±»ä¸Šæ·»åŠ  `@RunWith(AndroidJUnit4.class)` æ³¨è§£ï¼Œç„¶åé€šè¿‡InstrumentationRegistryè¿›è¡Œè°ƒç”¨ã€‚

## é€šè¿‡IDEè¿è¡Œæµ‹è¯•
å½“æˆ‘ä»¬ç¼–å†™ä»£ç æ—¶ï¼Œå¯ä»¥é€šè¿‡Android Studioè¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š

<div align="center">

![é€šè¿‡IDEè¿è¡Œæµ‹è¯•ç”¨ä¾‹](./Assets_æ¦‚è¿°/ä»ªå™¨åŒ–æµ‹è¯•_é€šè¿‡IDEè¿è¡Œæµ‹è¯•ç”¨ä¾‹.jpg)

</div>

ç‚¹å‡»æµ‹è¯•ç±»å‰çš„åŒç®­å¤´å¹¶åœ¨å¼¹å‡ºèœå•ä¸­é€‰æ‹© `Run ...` é€‰é¡¹ï¼Œå¯ä»¥è¿è¡Œå½“å‰æµ‹è¯•ç±»ä¸­çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼›ç‚¹å‡»æµ‹è¯•æ–¹æ³•å‰çš„ç®­å¤´å¹¶åœ¨èœå•ä¸­é€‰æ‹© `Run ...` é€‰é¡¹ï¼Œå¯ä»¥è¿è¡Œå½“å‰æµ‹è¯•æ–¹æ³•ã€‚

## åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ
æˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¹¶ç”ŸæˆæŠ¥å‘Šï¼Œè¿™åœ¨CI/CDç­‰ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ï¼š

```text
# æ‰§è¡Œæ‰€æœ‰æ¨¡å—çš„ä»ªå™¨åŒ–æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew connectedAndroidTest

# æ‰§è¡Œç‰¹å®šæ¨¡å—çš„ä»ªå™¨åŒ–æµ‹è¯•
[bi4vmr@Fedora Project]$ ./gradlew <æ¨¡å—åç§°>:connectedAndroidTest
```


# å®ç”¨æŠ€å·§
## æŒ‡å®šä»ªå™¨åŒ–æµ‹è¯•ç­¾å
åœ¨å¼€å‘ç³»ç»Ÿåº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸è°ƒç”¨è¦æ±‚ç³»ç»Ÿç­¾åé‰´æƒçš„APIï¼Œé»˜è®¤æƒ…å†µä¸‹ä»ªå™¨åŒ–æµ‹è¯•å°†ä½¿ç”¨Debug Variantçš„ç­¾åé…ç½®åˆ›å»ºæµ‹è¯•APKï¼Œå› æ­¤æˆ‘ä»¬ä¸ºDebug Varianté…ç½®ç›®æ ‡è®¾å¤‡è®¤å¯çš„ç­¾åå³å¯ã€‚

"build.gradle.kts":

```kotlin
android {
    signingConfigs {
        create("AOSP") {
            storeFile = file("AOSP.keystore")
            storePassword = "AOSPSystem"
            keyAlias = "AOSPSystem"
            keyPassword = "AOSPSystem"
        }
    }

    buildTypes {
        getByName("debug") {
            signingConfig = signingConfigs.getByName("AOSP")
        }
    }

    // æŒ‡å®šä»ªå™¨åŒ–æµ‹è¯•æ‰€ä½¿ç”¨çš„Build Variant
    testBuildType = "debug"
}
```

`testBuildType = <Build Variantåç§°>` é…ç½®é¡¹å¯ä»¥æŒ‡å®šä»ªå™¨åŒ–æµ‹è¯•æ‰€ä½¿ç”¨çš„Build Variantï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œé…ç½®é¡¹çš„é»˜è®¤å€¼å³ä¸º `debug` ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœç•¥è¯¥é…ç½®é¡¹ï¼›å¦‚æœæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨å…¶ä»–Build Variantï¼Œåˆ™å¿…é¡»æ˜ç¡®åœ°è¿›è¡Œé…ç½®ã€‚
