# 默认配置文件
当我们使用Android Studio创建一个新的工程后，将会生成名为"app"的子模块，以及一些Gradle配置文件，它们的目录结构如下：

```text
NewProject
├── app
│   └── build.gradle
├── build.gradle
└── settings.gradle
```

工程根目录下的 `settings.gradle` 配置文件包含全局属性、子模块声明、仓库声明等信息。

"settings.gradle":

```groovy
// 构建工具的依赖配置
pluginManagement {
    // 声明Gradle插件仓库
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

// 所有模块的依赖配置
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    // 声明Maven组件仓库
    repositories {
        google()
        mavenCentral()
    }
}

/* 工程结构声明 */
// 主工程名称
rootProject.name = "RootProject"

// 子模块"app"
include ':app'
```

该配置文件中的 `pluginManagement{}` 与 `dependencyResolutionManagement{}` 小节用于配置Gradle插件与依赖组件仓库信息，详见相关章节： [🧭 Gradle - 仓库管理](../../../../04_应用软件/07_编程工具/02_构建工具/02_Gradle/02_基础用法.md#仓库管理) 。

该配置文件中的剩余部分用于配置项目结构，声明各个子模块，详见相关章节： [🧭 Gradle - 模块管理](../../../../04_应用软件/07_编程工具/02_构建工具/02_Gradle/02_基础用法.md#模块管理) 。

工程根目录下的 `build.gradle` 配置文件包含Gradle插件声明。

"build.gradle":

```groovy
plugins {
    // 声明Gradle插件：Android应用程序
    id 'com.android.application' version '7.4.2' apply false
    // 声明Gradle插件：Android库
    id 'com.android.library' version '7.4.2' apply false
    // 声明Gradle插件：Android的Kotlin语言支持
    id 'org.jetbrains.kotlin.android' version '1.8.0' apply false
}
```

Android相关的Gradle插件都不是Gradle的官方插件，因此我们声明它们时需要指明版本。由于主工程无需放置Android源代码，此处添加了 `apply false` 属性，使插件不对主工程生效。

Android Gradle插件(Android Gradle Plugin, AGP)使Gradle具有生成Android产物的能力，包括编译Java源码、打包资源文件、配置版本信息等。

AGP的版本需要与Gradle版本相匹配，相关信息可在该网页中查询： [🔗 AGP版本说明](https://developer.android.google.cn/studio/releases/gradle-plugin#updating-gradle) 。

上述配置文件出现的Gradle插件介绍详见下文：

🔷 `com.android.application`

该AGP的作用是生成Android应用程序，应用该插件的模块构建产物为APK文件，可以被安装到设备中并运行。

🔷 `com.android.library`

该AGP的作用是生成Android库组件，应用该插件的模块构建产物为AAR文件，这种模块只能作为应用程序模块或其他库组件模块的依赖项，提供可复用的能力，无法在设备中安装与运行。

🔷 `org.jetbrains.kotlin.android`

该插件够使Android模块支持Kotlin语言。

对于只使用Java语言的模块，我们不必声明该项。

<br />

"app"模块的 `build.gradle` 配置文件包含构建应用程序的具体配置。

"build.gradle":

```groovy
/* 当前模块启用的Gradle插件 */
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

/* Android相关配置 */
android {
    namespace 'net.bi4vmr.helloworld'
    compileSdk 33

    // 默认配置
    defaultConfig {
        applicationId "net.bi4vmr.helloworld"
        minSdk 26
        targetSdk 33
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    // 构建类型
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    // Java编译配置
    compileOptions {
        // 指定源码版本
        sourceCompatibility JavaVersion.VERSION_1_8
        // 指定编译生成的字节码版本
        targetCompatibility JavaVersion.VERSION_1_8
    }

    // Kotlin编译配置
    kotlinOptions {
        // 指定编译生成的字节码版本
        jvmTarget = '1.8'
    }
}

/* 依赖组件声明 */
dependencies {
    implementation 'androidx.core:core-ktx:1.7.0'
    implementation 'androidx.appcompat:appcompat:1.4.1'
}
```

该配置文件中的 `plugins{}` 小节用于声明当前模块启用的Gradle插件，此处声明了 `com.android.application` 插件，因此编译产物为应用程序。此处还声明了 `org.jetbrains.kotlin.android` 插件，因此我们可以在模块中编写Kotlin代码。

该配置文件中的 `android{}` 小节用于声明与Android有关的配置，包括包名、SDK版本、测试工具、混淆配置等，各功能组件详见后文章节描述。

该配置文件中的 `dependencies{}` 小节用于声明当前模块所依赖的外部组件，详见相关章节： [🧭 Gradle - 依赖管理](../../../../04_应用软件/07_编程工具/02_构建工具/02_Gradle/03_依赖管理.md) 。

# Build Types
## 简介
Build Types用于区分构建产物的用途，每个类型可以配置不同的签名与调试参数，以满足不同场景的需求，例如：开发版本、测试版本、用户版本。

每个模块初始时拥有"debug"和"release"两个类型，其中"debug"类型面向开发者，默认允许进行调试、禁用代码混淆；"release"类型面向最终用户，默认不可进行调试、启用代码混淆。

## 基本应用
Build Types需要在当前模块 `build.gradle` 配置文件的 `android{}` 小节中声明，除了两个初始类型，我们还可以声明更多的类型，并配置每个类型的属性。

"build.gradle":

```groovy
android {

    buildTypes {
        // 默认类型"release"
        release {
            // 配置属性：禁止Debug
            debuggable = false
        }

        // 默认类型"debug"
        debug {
            // 配置属性：允许Debug
            debuggable = true
        }

        // 自定义类型"dev"
        dev {
            // 配置属性：允许Debug
            debuggable = true
        }
    }
}
```

配置文件编写完毕后，我们在Android Studio中执行一次Gradle Sync动作，即可在Build Variant面板中查看新增的自定义类型。

<div align="center">

![BuildTypes的基本应用](./Assets_基础用法/BuildTypes_BuildTypes的基本应用.jpg)

</div>

Build Variant面板中展示了每个模块当前所使用的构建类型，当我们通过"Build"菜单编译"app"模块后，可以在 `app/build/outputs/apk/debug/` 目录中找到对应的构建产物。

每当模块编译成功时，Gradle会在模块的 `build/outputs/apk/` 目录下生成一个与构建类型同名的目录，其中包括构建产物（APK或AAR文件）和构建信息（JSON格式的文件）。

```text
[root@Fedora RootProject]# tree ./app/build/outputs/apk/
./app/build/outputs/apk/
├── debug
│   ├── app-debug.apk
│   └── output-metadata.json
├── dev
│   ├── app-dev.apk
│   └── output-metadata.json
└── release
    ├── app-release.apk
    └── output-metadata.json
```

除了通过图形化工具执行编译外，我们还可以使用命令行操作，上述3个构建类型对应的Gradle编译命令如下文代码块所示。

```text
# 编译"app"模块，指定构建类型为"release"。
[root@Fedora RootProject]# ./gradlew app:assembleRelease

# 编译"app"模块，指定构建类型为"debug"。
[root@Fedora RootProject]# ./gradlew app:assembleDebug

# 编译"app"模块，指定构建类型为"dev"。
[root@Fedora RootProject]# ./gradlew app:assembleDev
```

构建类型对应的Task名称采用驼峰命名法，"assemble"为固定前缀，随后为构建类型名称。

## 属性
<!-- TODO -->

# 版本变更
## 索引

<div align="center">

|       序号        |    版本    |                          摘要                          |
| :---------------: | :--------: | :----------------------------------------------------: |
| [变更一](#变更一) | AGP v7.3.1 | Package Name声明语句从Manifest文件移动至Gradle配置文件 |

</div>

## 变更一
### 摘要
自从AGP v7.3.1开始，Package Name声明语句从Manifest文件移动至Gradle配置文件。

### 详情
在早期版本中，Manifest文件根标签含有Package Name声明语句 `package="<Package Name>"` ，它决定了Manifest文件的配置前缀与R文件所在路径。

"AndroidManifest.xml":

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="net.bi4vmr.study">

    <!-- 此处省略其他配置... -->
</manifest>
```

自从AGP v7.3.1开始，Package Name声明语句从Manifest文件移动至Gradle配置文件，对应的方法为 `namespace()` 。

"build.gradle":

```groovy
android {
    namespace "net.bi4vmr.study"

    /* 此处省略其他代码... */
}
```

### 兼容方案
较新版本的AGP仍然可以识别Manifest文件中的Package Name声明语句，可以保持现状。
