# Maven Publish
## 简介
<!--
Maven Publish插件是Gradle构建系统中的一个插件，它的主要作用是简化并将项目构建的成果（如JAR、AAR文件或其他工件）发布到Maven仓库的过程。这包括但不限于本地Maven仓库、公司内部的私有仓库或公共的远程仓库，如Maven Central。
-->

## 基本应用
在下文示例中，我们为一个Java Library模块配置Maven Publish插件，使其能够将编译产生的JAR包发布至Maven仓库。

"build.gradle.kts":

```kotlin
plugins {
    id("java-library")
    // 引入Maven Publish插件
    id("maven-publish")
}

// Maven Publish插件配置
publishing {
    // 发布目标仓库配置
    repositories {
        // 添加远端Maven仓库
        maven {
            setUrl("<仓库地址>")
            credentials {
                username = "<用户名称>"
                password = "<登录口令>"
            }
        }

        // 添加本地Maven仓库
        mavenLocal()
    }

    // 发布参数配置
    publications {
        // 创建名为"maven"的发布配置
        create<MavenPublication>("maven") {
            // 产物的基本信息
            groupId = "<GroupID>"
            artifactId = "<ArtifactID>"
            version = "<版本号>"

            // 发布程序包
            from(components.getByName("java"))

            // POM信息
            pom {
                url.set("<工程对应的网站>")
                // 打包格式
                packaging = "jar"
                developers {
                    developer {
                        name.set("<开发者名称>")
                        email.set("<开发者邮箱>")
                    }
                }
            }
        }
    }
}
```

Maven Publish插件的主要配置项都在 `publishing {}` 小节中书写，其中 `repositories {}` 小节用于配置发布目标仓库，语法与组件依赖仓库配置完全相同，详见相关章节： [🧭 依赖管理 - 仓库配置](./03_依赖管理.md#仓库配置) 。 `publications {}` 小节用于配置发布参数，控制需要发布的产物和POM信息等。

此处的 `groupId` 、 `artifactId` 、`version` 分别为当前模块的Group名称、Artifact名称和版本号，均为必填项； `from(components.getByName("java"))` 语句指明需要发布Java代码编译后产生的JAR包； `pom {}` 小节则声明了POM文件信息，其中 `packaging` 属性需要与 `from(components.getByName("java"))` 语句的产物类型保持一致。

此时我们执行

```text
[bi4vmr@nj_yigangzhan BaseLib-Java]$ ./gradlew publish
BUILD SUCCESSFUL in 1s
12 actionable tasks: 11 executed, 1 up-to-date
```

## 发布源码包

"build.gradle.kts":

```kotlin
// 发布源码包的任务
val sourceJar by tasks.creating(Jar::class) {
    // 为源码包添加后缀与程序包作区分
    archiveClassifier.set("source")
    // 将"src"目录下的源码文件打包
    from(sourceSets.getByName("main").java.srcDirs)
}

publishing {
    publications {
        // 创建名为"maven"的发布配置
        create<MavenPublication>("maven") {
            // 此处省略其他配置项 ...

            // 发布程序包
            from(components.getByName("java"))
            // 发布源码包
            artifact(sourceJar)
        }
    }
}
```


## 发布POM



"build.gradle.kts":

```kotlin
publishing {
    // 此处省略发布仓库配置 ...

    publications {
        create<MavenPublication>("maven") {
            // 此处省略其他配置项 ...

            pom.withXml {
                val dependenciesNode = asNode().appendNode("dependencies")
                // 获取当前模块的所有"implementation"节点
                configurations.getByName("implementation").allDependencies.forEach { dependency ->
                    val group: String? = dependency.group
                    val artifact: String = dependency.name
                    val version: String? = dependency.version
                    println("Parse dependency item. Group:[$group] Artifact:[$artifact] Version:[$version]")

                    // 向POM中添加依赖项，并跳过组名与版本号为空的项。
                    if (group != null && version != null) {
                        val dependencyNode = dependenciesNode.appendNode("dependency")
                        dependencyNode.appendNode("groupId", group)
                        dependencyNode.appendNode("artifactId", artifact)
                        dependencyNode.appendNode("version", version)
                        dependencyNode.appendNode("scope", "compile")
                    }
                }
            }
        }
    }
}
```


