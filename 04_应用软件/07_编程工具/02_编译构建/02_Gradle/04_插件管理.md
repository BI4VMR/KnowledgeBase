# Maven Publish
## 简介
Maven Publish是Gradle的一个插件，它的功能是将模块编译产生的JAR或AAR文件上传至Maven仓库，以便被其他工程引用。

## 基本应用
在下文示例中，我们为一个Java Library模块配置Maven Publish插件，使其能够将编译产生的JAR包发布至Maven仓库。

"build.gradle.kts":

```kotlin
plugins {
    id("java-library")
    // 引入Maven Publish插件
    id("maven-publish")
}

// Maven Publish插件配置
publishing {
    // 发布目标仓库配置
    repositories {
        // 添加远端Maven仓库
        maven {
            setUrl("<仓库地址>")
            credentials {
                username = "<用户名称>"
                password = "<登录口令>"
            }
        }

        // 添加本地Maven仓库
        mavenLocal()
    }

    // 发布参数配置
    publications {
        // 创建名为"maven"的发布配置
        create<MavenPublication>("maven") {
            // 产物的基本信息
            groupId = "<GroupID>"
            artifactId = "<ArtifactID>"
            version = "<版本号>"

            // 发布程序包
            from(components.getByName("java"))

            // POM信息
            pom {
                url.set("<工程对应的网站>")
                // 打包格式
                packaging = "jar"
                developers {
                    developer {
                        name.set("<开发者名称>")
                        email.set("<开发者邮箱>")
                    }
                }
            }
        }
    }
}
```

Maven Publish插件的主要配置项都在 `publishing {}` 小节中，其中 `repositories {}` 小节用于配置目标仓库信息，语法与组件依赖仓库配置完全相同，详见相关章节： [🧭 依赖管理 - 仓库配置](./03_依赖管理.md#仓库配置) 。 `publications {}` 小节用于配置发布参数，控制需要发布的产物和生成的POM信息。

此处的 `groupId` 、 `artifactId` 、`version` 分别为当前模块的Group名称、Artifact名称和版本号，均为必填项； `from(components.getByName("java"))` 语句指明了需要发布Java代码编译后产生的JAR包； `pom {}` 小节则声明了POM信息，其中 `packaging` 属性需要与 `from(components.getByName("java"))` 语句的产物类型保持一致，其他属性则可根据实际需要选择性地填写。

此时我们可以在终端中执行 `gradle publish` 命令，Gradle将会开始编译任务，并在编译成功后将产生的JAR包上传到目标仓库中。

```text
[root@Fedora Project]# ./gradlew publish
BUILD SUCCESSFUL in 1s
12 actionable tasks: 11 executed, 1 up-to-date
```

## 发布源码包
在前文示例中，Maven Publish插件只会上传当前模块的字节码（JAR包）及组件依赖信息（包含在POM文件中），使用者在IDE中无法查看源码及注释。

对于开源项目，我们可以为Maven Publish插件添加一些配置项，在发布程序包的同时也发布源码包，方便使用者查看源码与注释。

"build.gradle.kts":

```kotlin
// 发布源码包的任务
val sourceJar by tasks.creating(Jar::class) {
    // 为源码包添加后缀与程序包作区分
    archiveClassifier.set("source")
    // 将"src"目录下的源码文件打包
    from(sourceSets.getByName("main").java.srcDirs)
}

publishing {
    publications {
        // 创建名为"maven"的发布配置
        create<MavenPublication>("maven") {
            // 此处省略其他配置项 ...

            // 发布源码包
            artifact(sourceJar)
        }
    }
}
```

在上述示例代码中，我们创建了名为 `sourceJar` 的任务以生成源码包，然后在 `publishing {}` 小节中通过 `artifact()` 方法应用该任务，将源码包也作为一个产物发布至仓库。

## 发布POM包
有些模块中不包含任何程序代码，只有POM文件，这种模块的作用是聚合多个依赖项，使用者只需依赖该模块，就会间接依赖其他组件。

由于没有程序代码，我们也不需要在发布配置中书写 `from(components.getByName("java"))` 语句，此时插件不会自动在POM文件中生成 `<dependencies/>` 节点，因此我们需要新增一些逻辑代码，遍历Gradle的依赖组件，将其转为XML格式并写入POM文件。

"build.gradle.kts":

```kotlin
dependencies {
    implementation("<组件依赖项1>")
    implementation("<组件依赖项2>")
    implementation("<组件依赖项N>")
}

publishing {
    publications {
        create<MavenPublication>("maven") {
            // 此处省略其他配置项 ...

            pom.withXml {
                val dependenciesNode = asNode().appendNode("dependencies")
                // 获取当前模块的所有"implementation"节点
                configurations.getByName("implementation").allDependencies.forEach { dependency ->
                    val group: String? = dependency.group
                    val artifact: String = dependency.name
                    val version: String? = dependency.version
                    println("Parse dependency item. Group:[$group] Artifact:[$artifact] Version:[$version]")

                    // 向POM中添加依赖项，并跳过组名与版本号为空的项。
                    if (group != null && version != null) {
                        val dependencyNode = dependenciesNode.appendNode("dependency")
                        dependencyNode.appendNode("groupId", group)
                        dependencyNode.appendNode("artifactId", artifact)
                        dependencyNode.appendNode("version", version)
                        dependencyNode.appendNode("scope", "compile")
                    }
                }
            }
        }
    }
}
```
