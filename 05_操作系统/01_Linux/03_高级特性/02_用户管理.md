# 概述
Linux是一个多用户、多任务操作系统，因此用户管理与权限控制十分重要。

系统安装完毕时，只有管理员账户拥有完整的控制权，普通用户需要向管理员申请一个账户，并通过该账户登入系统，才能调用计算机中的各项资源。

# 理论基础
## 用户ID
用户ID也称为"UID"，取值为0的用户是系统管理员，系统服务用户ID范围为 `[1, 999]` ，自定义用户使用1000及以上的数值，原则上用户的ID不可重复。

系统通过UID是否为0识别管理员身份，默认只有"root"用户具有管理员权限，如果我们创建一个用户，并将其UID设为0，该用户也将成为管理员。

## 用户组
多个用户的集合称为用户组，每个用户必须有一个主要组，但还可以加入若干个附加组，以便灵活地实施权限控制。

用户组也具有ID属性，称为"GID"，系统内置用户组ID范围为 `[1, 999]`，自定义用户组使用1000及以上的数值，原则上用户组的ID不可重复。

# 配置文件
## 用户信息
该文件记录了用户的基本信息，路径为： `/etc/passwd` 。

```text
# =====用户信息文件示例=====
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
```

此文件以冒号为分隔符，每一段依次表示：用户名、口令占位符("x"符号)、UID、主要组ID、描述、主目录、默认Shell。

口令占位符是历史遗留产物，曾经用于存储用户的登录口令，现代Linux不再明文存储用户口令，而是将其消息摘要字符串存储在 `/etc/shadow` 文件中，以提升安全性。

默认Shell表示用户登录后所调用的Shell程序，对于不需要登录的系统服务用户，我们可以设为 `/sbin/nologin` ，禁止其从终端登录。

## 用户组信息
该文件记录了用户组的基本信息，路径为： `/etc/group` 。

```text
# ----- 用户组信息文件示例 -----
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
```

此文件以冒号为分隔符，每一段依次表示：用户组名称、口令占位符、GID、用户列表。

用户组的口令加密后存储在 `/etc/gshadow` 文件中，用户临时切换主要组、非管理员向组内添加用户时需要输入该口令。

用户列表为空并不一定说明该组没有用户，若该组只有一个与组同名的用户，此处也将为空。

# 用户管理命令
管理员对用户的操作通常包括查询、新增、修改、删除。

## 查询用户信息
执行 `id {用户名}` 命令可以查看用户的UID、GID、用户名称和组名称信息，不指定用户名则默认查询当前用户的信息。

🔴 示例一

查询用户"root"的相关信息。

```text
[root@Fedora ~]# id root
uid=0(root) gid=0(root) groups=0(root)
```

## 添加用户
`useradd` 命令用于创建新用户，语法为： `useradd {选项} <用户名称>` 。

默认情况下该命令将自动生成同名主目录、创建同名用户组、指定Shell为"/bin/bash"。通过命令选项可以改变默认行为，该命令的常用选项如下文所示：

🔷 `-m`

创建主目录。

该选项的默认路径为 `/home/<用户名>` 。

🔷 `-d  <路径>`

指定主目录。

若目标路径不存在，则会自动进行创建。

🔷 `-g <用户组>`

指定主要用户组。

🔷 `-G <用户组I, 用户组II...>`

指定附加用户组。

🔷 `-s <Shell程序路径>`

指定默认Shell。

🔷 `-c <文本>`

设置注释信息。

🔷 `-u <UID>`

指定UID。

🔷 `-o`

不检查ID唯一性，需配合"-u"选项使用。

🔷 `-k <模板目录路径>`

指定主目录的模板。

🟠 示例二

创建用户"test1"，并为其指定附加组"wheel"和"games"。

```text
# 新建用户"test1"
[root@Fedora ~]# useradd -G wheel,games test1

# 查看用户信息
[root@Fedora ~]# cat /etc/passwd | grep "test1"
test1:x:1000:1000::/home/test1:/bin/bash

# 查看用户组信息
[root@Fedora ~]# cat /etc/group | grep "test1"      
wheel:x:10:test1
games:x:20:test1
test1:x:1000:
```

## 删除用户
`userdel` 命令用于删除不再需要的用户，语法为： `userdel {选项} [用户名称]` 。该命令默认不会移除用户的主目录，若需要将主目录一并移除，请添加"-r"选项。

删除用户时，若存在同名用户组，且组内无其它用户，该组也会被同步移除。

## 修改用户属性
`usermod` 命令用于修改用户的属性，语法为： `usermod {选项} [用户名称]` 。

该命令大部分选项与 `useradd` 一致，使用这些选项即可更新相应的属性。

除此之外，它还支持一些其它选项：

🔶 `-a`

向附加用户组追加内容。

该选项需要与"-G"选项配合使用，详见后文示例。

🔶 `-l <新用户名>`

修改用户名称。

🔶 `-L`

锁定用户，使其不能登录到系统。对于长期不使用的用户，我们可以将其锁定，提高系统安全性。

🔶 `-U`

解锁用户。

🟡 示例三

将用户"test1"加入用户组"ftp"。

```text
# 为用户"test1"添加辅助组"ftp"
[root@Fedora ~]# usermod -a -G ftp test1

# 查看用户组信息
[root@Fedora ~]# cat /etc/group | grep "test1"      
ftp:x:3:test1
wheel:x:10:test1
games:x:20:test1
test1:x:1000:
```

不使用"-a"选项时，"-G"选项将会替换原本的辅助组列表；添加"-a"选项时，"-G"选项的值将会追加到用户原本的辅助组列表中。

## 切换用户身份
用户登录后，可以使用 `su` 命令直接切换身份。"su"是"Switch User"的缩写，执行 `su - {用户名}` 命令，并输入目标用户的密码，即可切换至目标用户。省略用户名时，默认切换至"root"用户，需要输入"root"用户的密码；从"root"用户切换至其它用户时，则不必输入密码。

"su"后的"-"表示加载新用户的环境变量与配置，若省略该符号，仅切换用户身份，而不加载其环境与配置。

## 修改登录口令
用户的登录口令由 `passwd` 命令管理，直接执行该命令可以修改当前用户的密码，需要输入一遍旧密码与两遍新密码；而管理员可以使用 `passwd {用户名}` 强制修改其它用户的密码，无需输入它们的旧密码。

🟢 示例四

使用普通用户"test1"登录，并修改自身的登录口令。

```text
[test1@Fedora ~]$ passwd
Changing password for user test1.
Changing password for test1.
(current) UNIX password: 
New password: 
Retype new password: 
passwd: all authentication tokens updated successfully.
```

为了安全起见，用户输入的口令不会在终端上回显，输入完毕后按"Enter"键进行提交。

# 用户组管理
管理员对用户组的操作通常包括查询、新增、修改、删除。

## 添加用户组
`groupadd` 命令可以创建新的用户组，用法与 `useradd` 相似。

默认情况下GID自增，添加"-g"选项可以指定一个GID。

## 删除用户组
`groupdel` 命令可以删除用户组，仅当一个用户组不是任何用户的主要组时，允许将其删除。用户组被删除后，附加组关系将被直接清除。

## 修改用户组属性
`groupmod` 命令可以修改用户组的属性，常用选项为"-g"和"-n"，前者用于修改GID，后者用于修改组名称。

## 口令管理
`gpasswd` 命令用于管理用户组口令，用法与 `passwd` 相似。

该命令使用 `-a <用户名>` 选项可以将用户加入指定的组，与 `usermod -a -G <用户组>` 效果相同。

## 切换用户组
`newgrp` 命令可以临时切换当前用户的主要组属性，需要输入用户组口令进行确认。

# 主目录模板
管理员创建新用户后，它们的主目录并不为空，而是存在一些初始文件，这些文件来自于 `/etc/skel` 目录。 `skel` 目录是用户主目录的模板，通过配置该目录的内容，我们可以设置新用户的初始文件。管理员创建用户时，系统将会复制模板目录中的文件到其主目录，并将所有者与所属组变更为新用户。

默认情况下，创建新用户时系统将以 `/etc/skel` 为模板，在 `useradd` 命令中添加 "-k <模板目录>" 选项可临时使用指定目录作为模板；修改 `useradd` 命令的配置文件则可以永久变更模板。相关操作可参考下文：

```text
# 通过选项临时指定模板目录
[root@Fedora ~]# useradd -m -k /etc/myskel/ user1

# 通过配置文件永久改变模板目录
[root@Fedora ~]# nano /etc/default/useradd
# 增加或修改以下配置
SKEL=/etc/myskel
```
