# ç®€ä»‹
`kotlinx-coroutines-test` æ¨¡å—æä¾›äº†ä¸€äº›å®žç”¨çš„åç¨‹æµ‹è¯•å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹Gradleé…ç½®å°†å…¶å¼•å…¥åˆ°å·¥ç¨‹ä¸­ï¼Œç„¶åŽæŒ‰éœ€é€‰ç”¨ç›¸å…³å·¥å…·ã€‚

```groovy
dependencies {
    testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-test:1.8.1'
}
```

ä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥ä½¿ç”¨Kotlinè¯­è¨€ç¼–å†™ï¼š

"build.gradle.kts":

```kotlin
dependencies {
    testImplementation("org.jetbrains.kotlinx:kotlinx-coroutines-test:1.8.1")
}
```


# åŸºæœ¬åº”ç”¨
ä¸ºäº†æ‰§è¡Œè¢«æµ‹å¯¹è±¡çš„æŒ‚èµ·å‡½æ•°ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨æµ‹è¯•ä»£ç ä¸­æž„å»ºä¸€ä¸ªåç¨‹çŽ¯å¢ƒï¼›ç”±äºŽæµ‹è¯•çº¿ç¨‹ä¸Žä¸šåŠ¡åç¨‹æ˜¯åˆ†åˆ«è¿è¡Œçš„ï¼Œæˆ‘ä»¬è¿˜è¦ç¡®ä¿æµ‹è¯•çº¿ç¨‹ç­‰å¾…åç¨‹è¿è¡Œå®Œæ¯•åŽå†é€€å‡ºã€‚

`runBlocking {}` æ–¹æ³•ç¬¦åˆä¸Šè¿°çš„ä¸¤é¡¹è¦æ±‚ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿæä¾›åç¨‹çŽ¯å¢ƒï¼Œå¹¶ä¸”é˜»å¡žæµ‹è¯•çº¿ç¨‹ç›´åˆ°å†…éƒ¨çš„è¯­å¥å—æ‰§è¡Œå®Œæ¯•ã€‚ `kotlinx-coroutines-test` æ¨¡å—æä¾›äº† `runTest {}` æ–¹æ³•ï¼Œå®ƒçš„è¡Œä¸ºä¸Ž `runBlocking {}` æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œå¹¶ä¸”æ–°å¢žäº†ä¸€äº›é€‚åˆåœ¨æµ‹è¯•çŽ¯å¢ƒä¸­ä½¿ç”¨çš„ç‰¹æ€§ã€‚

`runTest {}` æ˜¯TestScopeçš„æ‰©å±•æ–¹æ³•ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªTestScopeå®žä¾‹ä½œä¸ºåç¨‹çŽ¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ­¤å¤„è°ƒç”¨æŒ‚èµ·å‡½æ•°ã€‚TestScopeå°†ä¼šè·³è¿‡æŒ‚èµ·å‡½æ•°ä¸­çš„ `delay()` å»¶æ—¶ï¼Œä»¥å‡å°‘æµ‹è¯•ç”¨ä¾‹çš„è¿è¡Œæ—¶é•¿ã€‚

ðŸ”´ ç¤ºä¾‹ä¸€ï¼šæµ‹è¯•æŒ‚èµ·å‡½æ•°ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `runTest()` æ–¹æ³•åˆ›å»ºTestScopeï¼Œå¹¶åœ¨è¯¥ä½œç”¨åŸŸå†…è°ƒç”¨æŒ‚èµ·å‡½æ•°ã€‚

```kotlin
/* è¢«æµ‹æ–¹æ³• */
suspend fun task() {
    println("Task start. Time:[${getTime()}]")
    delay(60_000L)
    println("Task end. Time:[${getTime()}]")
}


/* æµ‹è¯•ä»£ç  */
@Test
fun test_Base() = runTest {
    task()
    println("Test end.")
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æŽ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task start. Time:[09:56:25.048]
Task end. Time:[09:56:25.054]
Test end.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

æˆ‘ä»¬åœ¨æŒ‚èµ·å‡½æ•°ä¸­è®¾ç½®äº†ä¸€åˆ†é’Ÿçš„å»¶æ—¶ï¼Œä½†å®žé™…ä¸Šè¯¥æ–¹æ³•è€—æ—¶ä¸º6æ¯«ç§’ï¼Œæ²¡æœ‰çœŸçš„ç­‰å¾…ä¸€åˆ†é’Ÿã€‚


# æŽ§åˆ¶åç¨‹è¿›åº¦
TestScopeæä¾›äº†ä¸¤ä¸ªå˜é‡ä»¥ä¾¿æˆ‘ä»¬æŽ§åˆ¶åç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

- `testScheduler` : æµ‹è¯•è°ƒåº¦å™¨ã€‚è¯¥è°ƒåº¦å™¨å¯ä»¥æŽ§åˆ¶åç¨‹çš„æ‰§è¡Œè¿›åº¦ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºæµ‹è¯•ä½œç”¨åŸŸå¹¶æ³¨å…¥åˆ°è¢«æµ‹å®žä¾‹ä¸­ï¼Œç„¶åŽåœ¨é€‚å½“çš„æ—¶æœºæŽ¨è¿›ä»»åŠ¡è¿›åº¦ï¼Œç¡®ä¿ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæ¯•å†æ£€æŸ¥ç»“æžœã€‚
- `backgroundScope` : åŽå°ä»»åŠ¡ä½œç”¨åŸŸã€‚è¯¥ä½œç”¨åŸŸä¸­çš„åç¨‹åªä¼šé™é»˜æ‰§è¡Œï¼Œä¸å—TestScopeæŽ¨è¿›ä»»åŠ¡è¯·æ±‚çš„å½±å“ï¼Œé‡åˆ°é”™è¯¯ä¹Ÿä¸ä¼šé˜»æ–­æµ‹è¯•ï¼Œå…¶ä¸­çš„åç¨‹å°†åœ¨æµ‹è¯•ç”¨ä¾‹ç»“æŸåŽè‡ªåŠ¨å–æ¶ˆã€‚å¦‚æžœè¢«æµ‹å¯¹è±¡ä¸­çš„éƒ¨åˆ†åç¨‹ä¸å½±å“æµ‹è¯•ç»“æžœï¼Œå¯ä»¥é€šè¿‡è¯¥ä½œç”¨åŸŸæ‰§è¡Œã€‚

TestScopeçš„ `advanceUntilIdle()` æˆ– `advanceTimeBy(ms: Long)` æ–¹æ³•éƒ½å¯ä»¥æŒ‚èµ·æµ‹è¯•åç¨‹å¹¶æŽ¨è¿›ä¸šåŠ¡åç¨‹ä»»åŠ¡è¿›åº¦ï¼Œå‰è€…å°†ä¼šæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ç›´åˆ°å®Œæˆï¼ŒåŽè€…åªä¼šæŽ¨è¿›æŒ‡å®šçš„ `delay()` æ—¶é•¿ã€‚

ðŸŸ  ç¤ºä¾‹äºŒï¼šé€šè¿‡TestScheduleræŽ§åˆ¶åç¨‹è¿›åº¦ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨TestScheduleræŽ§åˆ¶è¢«æµ‹åç¨‹çš„æ‰§è¡Œè¿›åº¦ï¼Œç¡®ä¿æµ‹è¯•åç¨‹ç­‰å¾…è¢«æµ‹åç¨‹æ‰§è¡Œå®Œæ¯•ã€‚

ç¬¬ä¸€æ­¥ï¼Œç¼–å†™ä¸šåŠ¡ä»£ç ã€‚

"DataManager.kt":

```kotlin
class DataManager(
    dispatcher: CoroutineDispatcher = Dispatchers.IO
) {
    private val scope = CoroutineScope(dispatcher)

    var freeSpace: Int = 0
        private set

    fun clearCache() {
        scope.launch {
            // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ...
            delay(1000L)

            // æ¸…ç†å®Œæ¯•ï¼Œå¢žåŠ å¯ç”¨ç©ºé—´ã€‚
            freeSpace = 100
            println("Clean completed in coroutine task.")
        }
    }
}
```

DataManagerçš„ `freeSpace` å±žæ€§ç”¨äºŽæŒ‡ç¤ºå½“å‰å¯ç”¨çš„ç¼“å­˜ç©ºé—´ï¼Œä¸šåŠ¡æ–¹æ³• `clearCache()` å°†åœ¨åç¨‹ä¸­æ¸…ç†ç¼“å­˜ï¼Œå¹¶äºŽä»»åŠ¡å®Œæˆæ—¶æ›´æ–° `freeSpace` å±žæ€§ã€‚

ç¬¬äºŒæ­¥ï¼Œç¼–å†™æµ‹è¯•ä»£ç ã€‚

"TestTools.kt":

```kotlin
@Test
fun test_TestScheduler() = runTest {
    // ä½¿ç”¨TestScopeæä¾›çš„Schedulerï¼Œåˆ›å»ºæµ‹è¯•è°ƒåº¦å™¨ã€‚
    val dispatcher = StandardTestDispatcher(testScheduler)

    // å°†æµ‹è¯•è°ƒåº¦å™¨æ³¨å…¥åˆ°å¾…æµ‹ç»„ä»¶ï¼Œå¹¶æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ã€‚
    val manager = DataManager(dispatcher)
    println("Free space is ${manager.freeSpace} before clean.")
    manager.clearCache()

    // æµ‹è¯•åç¨‹ç­‰å¾…ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæˆ
    advanceUntilIdle()

    // ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæ¯•åŽå†æ–­è¨€ç»“æžœ
    println("Free space is ${manager.freeSpace} after clean.")
    Assert.assertTrue(manager.freeSpace > 10)
}
```

æˆ‘ä»¬é¦–å…ˆé€šè¿‡TestScopeæä¾›çš„TestScheduleråˆ›å»ºDispatcherï¼Œç„¶åŽå°†å…¶æ³¨å…¥åˆ°è¢«æµ‹å¯¹è±¡ä¸­ï¼Œä½¿è¢«æµ‹å¯¹è±¡çš„åç¨‹å¯ä»¥è¢«TestScheduleræŽ§åˆ¶ã€‚

å½“æˆ‘ä»¬è°ƒç”¨ `clearCache()` æ–¹æ³•å¼€å¯ä¸šåŠ¡åç¨‹åŽï¼Œåˆåœ¨æµ‹è¯•åç¨‹ä¸­è°ƒç”¨äº† `advanceUntilIdle()` æ–¹æ³•ï¼Œæ­¤æ—¶æµ‹è¯•åç¨‹å°†æŒ‚èµ·å¹¶ç­‰å¾…ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæ¯•ï¼›å½“ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæ¯•åŽï¼Œæµ‹è¯•åç¨‹ä»ŽæŒ‚èµ·çŠ¶æ€æ¢å¤å¹¶æ‰§è¡Œæ–­è¨€ã€‚

æˆ‘ä»¬é¦–å…ˆç§»é™¤ `advanceUntilIdle()` è¯­å¥ï¼Œè¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æŽ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Free space is 0 before clean.
Free space is 0 after clean.
Clean completed in coroutine task.

java.lang.AssertionError
	at org.junit.Assert.fail(Assert.java:87)
```

ç”±äºŽæµ‹è¯•åç¨‹å¹¶æœªç­‰å¾…è¢«æµ‹æ–¹æ³• `clearCache()` ä¸­çš„ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå› æ­¤å…¶è¯»å–åˆ°çš„ `freeSpace` å˜é‡ä»ä¸ºåˆå§‹å€¼ `0` ï¼Œç»“æžœä¸Žé¢„æœŸä¸ç¬¦ã€‚

ç„¶åŽæˆ‘ä»¬æ·»åŠ  `advanceUntilIdle()` è¯­å¥ï¼Œå†æ¬¡è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æŽ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Free space is 0 before clean.
Clean completed in coroutine task.
Free space is 100 after clean.
```

æ­¤æ—¶æµ‹è¯•åç¨‹ä¸­çš„æ–­è¨€è¯­å¥åœ¨ `clearCache()` åç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åŽè¯»å– `freeSpace` å˜é‡å¹¶è¿›è¡Œæ–­è¨€ï¼Œç»“æžœç¬¦åˆé¢„æœŸã€‚

---

> ðŸš© æç¤º
>
> åªæœ‰å…³è”åˆ°TestSchedulerçš„åç¨‹æ‰ä¼šå—åˆ° `advanceUntilIdle()` ç­‰æ–¹æ³•æŽ§åˆ¶ï¼Œå› æ­¤è¦æ±‚è¢«æµ‹ä»£ç æŒ‰ç…§å‰æ–‡ç« èŠ‚ [ðŸ§­ åç¨‹çŽ¯å¢ƒ - ç¼–ç é£Žæ ¼](./03_åç¨‹çŽ¯å¢ƒ.md#ç¼–ç é£Žæ ¼) ä¸­çš„æŽ¨èå†™æ³•è¿›è¡Œç»„ç»‡ï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨æµ‹è¯•çŽ¯å¢ƒä¸­æ³¨å…¥æµ‹è¯•è°ƒåº¦å™¨ã€‚
>
> è‹¥è¢«æµ‹ä»£ç ç›´æŽ¥å¼•ç”¨å†…ç½®è°ƒåº¦å™¨åˆ›å»ºåç¨‹çŽ¯å¢ƒï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡ `advanceUntilIdle()` æŽ§åˆ¶å…¶ä»»åŠ¡è¿›åº¦ï¼Œæ­¤æ—¶åªèƒ½é¢„ä¼°ä»»åŠ¡è€—æ—¶å¹¶ä½¿æµ‹è¯•çº¿ç¨‹ä¼‘çœ æ›´ä¹…çš„æ—¶é•¿æ¥å®žçŽ°ç­‰å¾…ã€‚
>
> ```kotlin
> /* ä¸šåŠ¡ä»£ç  */
> fun foo() {
>     CoroutineScope(Dispatchers.IO).launch {
>         // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ...
>         delay(1000L)
>     }
> }
> 
> 
> /* æµ‹è¯•ä»£ç  */
> @Test
> fun test() {
>     foo()
> 
>     // æµ‹è¯•çº¿ç¨‹ä¼‘çœ æ¯”ä¸šåŠ¡åç¨‹ç•¥é•¿çš„ä¸€æ®µæ—¶é—´ï¼Œç­‰å¾…ä¸šåŠ¡åç¨‹æ‰§è¡Œå®Œæ¯•ã€‚
>     Thread.sleep(1100L)
> 
>     // æ­¤æ—¶å¯ä»¥æ‰§è¡Œæ–­è¨€ç­‰æ“ä½œ
> }
> ```
>
