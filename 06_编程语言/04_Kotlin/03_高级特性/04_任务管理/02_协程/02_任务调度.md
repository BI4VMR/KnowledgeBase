# ä¸²è¡Œä»»åŠ¡
åç¨‹ä½“ä¸æ™®é€šæ–¹æ³•ç±»ä¼¼ï¼Œå…¶ä¸­çš„è¯­å¥å°†ä¼šæŒ‰ç…§ç¼–å†™é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå½“æŸæ¡è¯­å¥æŒ‚èµ·æ—¶ï¼Œåç¨‹ä½“ä¹Ÿä¼šè¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œå½“è¯¥è¯­å¥ä»æŒ‚èµ·çŠ¶æ€æ¢å¤åï¼Œåç¨‹ä½“å†ç»§ç»­æ‰§è¡Œåä¸€æ¡è¯­å¥ï¼Œç›´åˆ°æ‰€æœ‰è¯­å¥å‡è¢«æ‰§è¡Œå®Œæ¯•ã€‚

ğŸ”´ ç¤ºä¾‹ä¸€ï¼šä¸²è¡Œä»»åŠ¡ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåç¨‹ç¯å¢ƒï¼Œå¹¶è§‚å¯Ÿå…¶ä¸­è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å®šä¹‰æŒ‚èµ·å‡½æ•° `task(String name, long time)` ï¼Œè¯¥å‡½æ•°ä¼šä½¿è°ƒç”¨å®ƒçš„åç¨‹æŒ‚èµ· `time` æ¯«ç§’ï¼Œå¹¶åœ¨æŒ‚èµ·å‰åå‘æ§åˆ¶å°è¾“å‡ºä¸€äº›ä¿¡æ¯ã€‚

"TestCooperation.kt":

```kotlin
suspend fun task(name: String, time: Long) {
    println("Task $name start. Thread:[${getThread()}] Time:[${getTime()}]")
    delay(time)
    println("Task $name end. Thread:[${getThread()}] Time:[${getTime()}]")
}
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåç¨‹ç¯å¢ƒï¼Œè°ƒç”¨ä¸¤æ¬¡æŒ‚èµ·å‡½æ•° `task()` ï¼Œå¹¶è§‚å¯Ÿæ‰§è¡Œé¡ºåºã€‚

"TestCooperation.kt":

```kotlin
CoroutineScope(Dispatchers.Default).launch {
    // å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
    task("A", 2000)
    // ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡ã€‚
    task("B", 2000)
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task A start. Thread:[DefaultDispatcher-worker-1] Time:[21:55:18.351]
Task A end. Thread:[DefaultDispatcher-worker-1] Time:[21:55:20.392]
Task B start. Thread:[DefaultDispatcher-worker-1] Time:[21:55:20.392]
Task B end. Thread:[DefaultDispatcher-worker-1] Time:[21:55:22.397]
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

TaskAé¦–å…ˆè¢«æ‰§è¡Œï¼Œå½“TaskAæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè°ƒåº¦å™¨ç»§ç»­æ‰§è¡ŒTaskBï¼Œä¸¤ä¸ªä»»åŠ¡æ˜¯ä¸²è¡Œå…³ç³»ã€‚

---

å¯¹äºå¤šä¸ªå…·æœ‰ä¸²è¡Œå…³ç³»çš„å¼‚æ­¥ä»»åŠ¡ï¼Œåç¨‹ä»£ç ç›¸æ¯”æ¥å£å›è°ƒä»£ç ç¼©è¿›å±‚æ¬¡æ›´å°‘ã€æ›´åŠ ç®€æ´ã€‚

ğŸŸ  ç¤ºä¾‹äºŒï¼šåç¨‹ä¸æ¥å£å›è°ƒä»£ç é£æ ¼å¯¹æ¯”ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»¥å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿä¸ºä¾‹ï¼Œé€šè¿‡ä¼ªä»£ç æ¯”è¾ƒåç¨‹ä¸æ¥å£å›è°ƒä¸¤ç§ç¼–ç é£æ ¼ã€‚

å‡è®¾æˆ‘ä»¬å·²çŸ¥å­¦ç”ŸIDï¼Œéœ€è¦å…ˆé€šè¿‡â€œæŸ¥è¯¢å­¦ç”Ÿè¯¦æƒ…â€å¼‚æ­¥æ¥å£è·å–å­¦ç”Ÿä¿¡æ¯ï¼Œå†ä»å­¦ç”Ÿä¿¡æ¯ä¸­åŒæ­¥è·å–ç­çº§IDï¼Œæœ€åé€šè¿‡â€œæŸ¥è¯¢ç­çº§è¯¦æƒ…â€å¼‚æ­¥æ¥å£è·å–ç­çº§è¯¦æƒ…ã€‚

ä¸‹æ–‡ä»£ç å—å±•ç¤ºäº†æ¥å£å›è°ƒé£æ ¼çš„ä¼ªä»£ç ï¼š

```kotlin
val studentID: Long = 1

// é¦–å…ˆæ ¹æ®IDæŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯
queryStudent(studentID, object : OnResult() {
    override fun onSuccess(student: Student) {
        // è·å–ç­çº§ID
        val classID: Long = student.classID
        // ç„¶åæ ¹æ®ç­çº§IDæŸ¥è¯¢ç­çº§ä¿¡æ¯
        queryClass(classID, object : OnResult() {
            override fun onSuccess(classInfo: ClassInfo) {
                // æ˜¾ç¤ºç­çº§ä¿¡æ¯
                println(classInfo)
            }
        })
    }
})
```

ä¸‹æ–‡ä»£ç å—åˆ™å±•ç¤ºäº†åç¨‹é£æ ¼çš„ä¼ªä»£ç ï¼š

```kotlin
val studentID: Long = 1

CoroutineScope(Dispatchers.Default).launch {
    // é¦–å…ˆæ ¹æ®IDæŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯
    val student: Student = queryStudent(studentID)
    // è·å–ç­çº§ID
    val classID: Long = student.classID
    // ç„¶åæ ¹æ®ç­çº§IDæŸ¥è¯¢ç­çº§ä¿¡æ¯
    val classInfo: ClassInfo = queryClass(classID)
    // æ˜¾ç¤ºç­çº§ä¿¡æ¯
    println(classInfo)
}
```


# å¹¶è¡Œä»»åŠ¡
åç¨‹å¯ä»¥æ‹¥æœ‰æ ‘çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬å°†é€šè¿‡CoroutineScopeåˆ›å»ºçš„åç¨‹ä»»åŠ¡ç§°ä¸ºâ€œé¡¶çº§åç¨‹â€ï¼›åœ¨é¡¶çº§åç¨‹ä¸­é€šè¿‡åç¨‹æ„å»ºå™¨èƒ½å¤Ÿå¼€å¯æ–°çš„ä»»åŠ¡ï¼Œè¿™äº›å­ä»»åŠ¡ä¹Ÿè¢«ç§°ä¸ºâ€œå­åç¨‹â€ï¼Œå¦‚æœè°ƒåº¦å™¨æ‹¥æœ‰è¶³å¤Ÿçš„ç©ºé—²å·¥ä½œçº¿ç¨‹ï¼Œå¤šä¸ªå­ä»»åŠ¡å°†ä¼šåŒæ­¥æ¨è¿›ï¼Œé»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰ä¾èµ–å…³ç³»ã€‚

åç¨‹çš„æ ‘çŠ¶ç»“æ„æœ‰åˆ©äºåæ˜ ä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼Œæ›´å¥½åœ°ç®¡ç†ä»»åŠ¡ä¸èµ„æºï¼Œè¯¦è§ç›¸å…³ç« èŠ‚ï¼š [ğŸ§­ ç»“æ„åŒ–å¹¶å‘](03_åç¨‹ç¯å¢ƒ.md#ç»“æ„åŒ–å¹¶å‘) ï¼Œç›®å‰æˆ‘ä»¬ä»…éœ€äº†è§£å¦‚ä½•åœ¨åç¨‹ä»»åŠ¡ä¸­å®ç°å¹¶å‘å³å¯ã€‚

ğŸŸ¡ ç¤ºä¾‹ä¸‰ï¼šå¹¶è¡Œä»»åŠ¡ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåç¨‹ç¯å¢ƒï¼Œå¹¶é€šè¿‡åç¨‹æ„å»ºå™¨ `launch()` æ–¹æ³•å¼€å¯ä¸¤ä¸ªå¹¶è¡Œä»»åŠ¡ã€‚

"TestCooperation.kt":

```kotlin
CoroutineScope(Dispatchers.Default).launch {
    // åˆ›å»ºåç¨‹æ‰§è¡Œä»»åŠ¡A
    launch { task("A", 2000) }
    // åˆ›å»ºåç¨‹æ‰§è¡Œä»»åŠ¡B
    launch { task("B", 2000) }
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task A start. Thread:[DefaultDispatcher-worker-2] Time:[17:36:44.620]
Task B start. Thread:[DefaultDispatcher-worker-3] Time:[17:36:44.620]
Task A end. Thread:[DefaultDispatcher-worker-2] Time:[17:36:46.656]
Task B end. Thread:[DefaultDispatcher-worker-3] Time:[17:36:46.656]
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

TaskAä¸TaskBåŒæ—¶å¯åŠ¨ã€åŒæ—¶è¿è¡Œå®Œæ¯•ï¼Œå®ƒä»¬åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„å·¥ä½œçº¿ç¨‹è¿è¡Œï¼ŒäºŒè€…æ˜¯å¹¶è¡Œæ¨è¿›çš„ï¼Œæ²¡æœ‰ç›¸äº’ç­‰å¾…ã€‚


# ç­‰å¾…ä»»åŠ¡å®Œæˆ
ä¸çº¿ç¨‹ç±»ä¼¼ï¼Œåç¨‹ä¹Ÿæä¾›äº† `join()` æ–¹æ³•ï¼Œå½“æˆ‘ä»¬åœ¨ä»»åŠ¡Aä¸­è°ƒç”¨ä»»åŠ¡Bçš„ `join()` æ–¹æ³•åï¼Œä»»åŠ¡Aå°†ä¼šæŒ‚èµ·ï¼Œç›´åˆ°ä»»åŠ¡Bæ‰§è¡Œå®Œæ¯•å†æ¢å¤è¿è¡Œã€‚

ğŸŸ¢ ç¤ºä¾‹å››ï¼šç­‰å¾…ä»»åŠ¡å®Œæˆã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºåç¨‹ç¯å¢ƒï¼Œå¼€å¯ä¸€ä¸ªå­åç¨‹ï¼Œç„¶åä½¿é¡¶çº§åç¨‹ç­‰å¾…å­åç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†ç»§ç»­è¿è¡Œã€‚

"TestCooperation.kt":

```kotlin
CoroutineScope(Dispatchers.Default).launch {
    println("Task Root start.")
    // ä½¿ç”¨ `launch()` æ–¹æ³•å¼€å¯å­ä»»åŠ¡ã€‚
    val job: Job = launch { task("A", 2000) }

    // åœ¨é¡¶çº§åç¨‹ä¸­è°ƒç”¨å­ä»»åŠ¡çš„ `join()` æ–¹æ³•ï¼Œç­‰å¾…å­ä»»åŠ¡ç»“æŸå†ç»§ç»­è¿è¡Œã€‚
    job.join()
    println("Task Root end.")
}
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task Root start.
Task A start. Time:[11:36:22.576]
Task A end. Time:[11:36:24.597]
Task Root end.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

å½“é¡¶çº§åç¨‹TaskRootè°ƒç”¨å­åç¨‹TaskAçš„ `join()` æ–¹æ³•åï¼ŒTaskRootè¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼›ç›´åˆ°å­åç¨‹è¿è¡Œå®Œæ¯•ï¼Œé¡¶çº§åç¨‹æ‰æ¢å¤è¿è¡Œå¹¶è¾“å‡º `Task Root end.` æ¶ˆæ¯ã€‚


# è·å–ä»»åŠ¡ç»“æœ
æœ‰æ—¶æˆ‘ä»¬ä¸ä»…éœ€è¦ç­‰å¾…æŸä¸ªä»»åŠ¡å®Œæˆï¼Œè¿˜éœ€è¦è·å–è¯¥ä»»åŠ¡çš„ç»“æœï¼Œå¹¶åœ¨åç»­æ“ä½œä¸­ä½¿ç”¨è¯¥ç»“æœï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨åç¨‹æ„å»ºå™¨ `async()` ã€‚

ğŸ”µ ç¤ºä¾‹äº”ï¼šè·å–ä»»åŠ¡ç»“æœã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºåç¨‹ç¯å¢ƒï¼Œå¼€å¯ä¸€ä¸ªå­åç¨‹ï¼Œç„¶åä½¿é¡¶çº§åç¨‹ç­‰å¾…å­åç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶è·å–å­åç¨‹çš„ç»“æœã€‚

"TestCooperation.kt":

```kotlin
CoroutineScope(Dispatchers.Default).launch {
    println("Task Root start.")
    // ä½¿ç”¨ `async()` æ–¹æ³•å¼€å¯ä»»åŠ¡ï¼Œå¹¶å£°æ˜å˜é‡ä¿å­˜ä»»åŠ¡å¯¹è±¡ï¼Œä»¥ä¾¿åç»­è·å–è¿”å›å€¼ã€‚
    val job: Deferred<Int> = async {
        task("A", 2000)
        // åç¨‹ä½“æ˜¯ä¸€ä¸ªLambdaè¡¨è¾¾å¼ï¼Œæœ€åä¸€æ¡è¯­å¥çš„å€¼å³ä»»åŠ¡çš„è¿”å›å€¼ã€‚
        114514
    }
    // å¼‚æ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¹¶æ¥æ”¶è¿”å›å€¼ã€‚
    val result: Int = job.await()
    println("Task Root end, task A result is $result.")
}
```

`async()` æ–¹æ³•æ˜¯ä¸€ä¸ªåç¨‹æ„å»ºå™¨ï¼Œå…¶è¿”å›å€¼ç±»å‹æ˜¯ `Deferred<T>` ï¼Œå®ƒæ˜¯Jobçš„å­ç±»ï¼Œæ³›å‹ `T` ä¸åç¨‹ä½“çš„è¿”å›å€¼ç±»å‹ä¸€è‡´ï¼Œè¡¨ç¤ºä»»åŠ¡çš„ç»“æœï¼› `Deferred<T>` è¿˜æ–°å¢äº† `await(): T` æ–¹æ³•ä»¥ä¾¿æˆ‘ä»¬è·å–ä»»åŠ¡ç»“æœï¼Œå½“æˆ‘ä»¬è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œå¦‚æœå­åç¨‹TaskAå°šæœªå®Œæˆï¼Œé¡¶çº§åç¨‹TaskRootå°±ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°TaskAå®Œæˆå¹¶è¿”å›ç»“æœï¼›å¦‚æœæˆ‘ä»¬è°ƒç”¨è¯¥æ–¹æ³•æ—¶TaskAå·²ç»å®Œæˆï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œä¸ä¼šå¯¼è‡´è°ƒç”¨è€…è¢«æŒ‚èµ·ã€‚

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task Root start.
Task A start. Time:[17:36:44.620]
Task A end. Time:[17:36:46.656]
Task Root end, task A result is 114514.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

é¡¶çº§åç¨‹TaskRootè°ƒç”¨å­åç¨‹TaskAçš„ `await()` æ–¹æ³•åï¼Œè¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç›´åˆ°TaskAæ‰§è¡Œå®Œæ¯•è¿”å›ç»“æœï¼Œæ‰æ¢å¤è¿è¡Œå¹¶è¾“å‡º `Task Root end` æ¶ˆæ¯ä¸å­ä»»åŠ¡çš„ç»“æœã€‚


# åˆå¹¶ä»»åŠ¡ç»“æœ
ç°æœ‰ä¸€ä¸ªæ–°é—»é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦è¯·æ±‚â€œçƒ­ç‚¹äº‹ä»¶â€ä¸â€œå¹¿å‘Šæ¨èâ€ä¸¤ä¸ªç½‘ç»œæ¥å£çš„æ•°æ®ï¼Œæœ€ç»ˆç»„åˆä¸ºå•ä¸ªæ•°æ®æºå¹¶æ›´æ–°æ–°é—»åˆ—è¡¨ã€‚ä¸€ä¸ªè¾ƒä¸ºç›´è§‚çš„å®ç°æ–¹æ³•æ˜¯ï¼šé¦–å…ˆè¯·æ±‚â€œçƒ­ç‚¹äº‹ä»¶â€æ•°æ®ï¼Œå½“è¯¥è¯·æ±‚çš„å›è°ƒè§¦å‘åå†è¯·æ±‚â€œå¹¿å‘Šæ¨èâ€æ•°æ®ï¼Œç­‰åˆ°è¯¥è¯·æ±‚å›è°ƒè§¦å‘æ—¶åˆå¹¶äºŒè€…çš„ç»“æœã€‚è¿™ç§æ–¹æ³•ç¡®å®èƒ½å¤Ÿå®ç°åŠŸèƒ½ï¼Œä½†å¼•å…¥äº†ä¸å¿…è¦çš„æ—¶å»¶ï¼Œå‡è®¾æ¯ä¸ªè¯·æ±‚ç”¨æ—¶2ç§’ï¼Œæ€»è®¡éœ€è¦4ç§’æ‰èƒ½å®Œæˆä»»åŠ¡ã€‚

ç”±äºä¸¤ä¸ªç½‘ç»œè¯·æ±‚æ˜¯ç‹¬ç«‹çš„ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `async()` æ–¹æ³•å¼€å¯å­åç¨‹åˆ†åˆ«è¿›è¡Œè¯·æ±‚ï¼Œç„¶ååœ¨çˆ¶åç¨‹ä¸­è°ƒç”¨å®ƒä»¬çš„ `await()` æ–¹æ³•ç­‰å¾…ç»“æœè¿”å›ã€‚è¿™ç§æ–¹å¼èƒ½å¤Ÿå°†æ€»è€—æ—¶ä»4ç§’å‡å°‘åˆ°2ç§’ï¼Œæé«˜äº†ç¨‹åºçš„å¹¶è¡Œåº¦ï¼Œæœ‰åˆ©äºæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

ğŸŸ£ ç¤ºä¾‹å…­ï¼šåˆå¹¶ä»»åŠ¡ç»“æœï¼ˆæ–¹å¼ä¸€ï¼‰ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `async()` æ–¹æ³•å¼€å¯ä¸¤ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œå¹¶ä½¿é¡¶çº§åç¨‹ç­‰å¾…å®ƒä»¬å®Œæˆï¼Œæœ€ååˆå¹¶äºŒè€…çš„ç»“æœã€‚

"TestCooperation.kt":

```kotlin
// æµ‹è¯•æ–¹æ³•ï¼šå»¶æ—¶ç‰¹å®šç§’æ•°ï¼Œå¹¶ä»¥è¯¥ç§’æ•°ä¸ºè¿”å›å€¼ã€‚
suspend fun task(name: String, time: Long): Long {
    println("Task $name start. Thread:[${getThread()}] Time:[${getTime()}]")
    delay(time)
    println("Task $name end. Thread:[${getThread()}] Time:[${getTime()}]")
    return time
}

CoroutineScope(Dispatchers.Default).launch {
    // ä½¿ç”¨"async()"æ–¹æ³•å¼€å¯ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡
    val job1: Deferred<Long> = async { task("1", 2000) }
    val job2: Deferred<Long> = async { task("2", 3000) }

    // ä½¿å½“å‰ä»»åŠ¡ç­‰å¾…ä¸Šè¿°ä¸¤ä¸ªä»»åŠ¡ç»“æŸï¼Œå¹¶é€šè¿‡å˜é‡æ¥æ”¶è¿è¡Œç»“æœã€‚
    val result1 = job1.await()
    val result2 = job2.await()

    println("All task is end, summary is ${result1 + result2}.")
}
```

`task()` æ–¹æ³•å°†ä¼šå»¶æ—¶å‚æ•° `time` æŒ‡å®šçš„æ—¶é•¿ï¼Œå¹¶å°†è¯¥æ•°å€¼ä½œä¸ºè¿”å›å€¼ã€‚æˆ‘ä»¬é€šè¿‡ `async()` æ–¹æ³•åˆ†åˆ«å¼€å¯ä¸¤ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„ `await()` æ–¹æ³•ç­‰å¾…ä»»åŠ¡å®Œæˆå¹¶æ¥æ”¶è¿”å›å€¼ã€‚

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task 1 start. Thread:[DefaultDispatcher-worker-2] Time:[15:21:55.989]
Task 2 start. Thread:[DefaultDispatcher-worker-3] Time:[15:21:55.989]
Task 1 end. Thread:[DefaultDispatcher-worker-3] Time:[15:21:58.026]
Task 2 end. Thread:[DefaultDispatcher-worker-3] Time:[15:21:59.024]
All task is end, summary is 5000.
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

Task1å’ŒTask2åœ¨åŒä¸€æ—¶åˆ»å¼€å§‹è¿è¡Œï¼Œæ²¡æœ‰ç›¸äº’ç­‰å¾…ï¼›å½“Task1å’ŒTask2éƒ½è¿è¡Œå®Œæ¯•åï¼Œé¡¶çº§åç¨‹ä»æš‚åœä¸­æ¢å¤ï¼Œå¹¶è·å–åˆ°ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœã€‚

---

å¦‚æœæˆ‘ä»¬éœ€è¦å¹¶å‘æ‰§è¡Œä¸€ç»„ç»“æœç±»å‹ç›¸åŒçš„ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå¯ä»¥ä½¿ç”¨åç¨‹ä»»åŠ¡æä¾›çš„ `awaitAll()` æ–¹æ³•ç»Ÿä¸€ç®¡ç†ã€‚

ğŸŸ¤ ç¤ºä¾‹ä¸ƒï¼šåˆå¹¶ä»»åŠ¡ç»“æœï¼ˆæ–¹å¼äºŒï¼‰ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¼€å¯5ä¸ªå…·æœ‰éšæœºæ‰§è¡Œæ—¶é•¿çš„å¹¶è¡Œä»»åŠ¡ï¼Œå¹¶ä½¿é¡¶çº§åç¨‹ç­‰å¾…å®ƒä»¬å®Œæˆï¼Œæœ€ç»ˆå‘æ§åˆ¶å°è¾“å‡ºå®ƒä»¬çš„ç»“æœã€‚

"TestCooperation.kt":

```kotlin
// æµ‹è¯•æ–¹æ³•ï¼šéšæœºå»¶æ—¶è‹¥å¹²ç§’
suspend fun task(name: String): Int {
    println("Task $name start. Thread:[${getThread()}] Time:[${getTime()}]")
    // éšæœºå»¶æ—¶1-5ç§’
    val time: Int = (Random.nextInt(5) + 1)
    delay(time * 1000L)
    println("Task $name end. Thread:[${getThread()}] Time:[${getTime()}]")
    return time
}

CoroutineScope(Dispatchers.Default).launch {
    // åˆ›å»ºé›†åˆä¿å­˜Deferredå¯¹è±¡
    val jobs: MutableList<Deferred<Int>> = mutableListOf()
    // å¾ªç¯å¼€å¯å¤šä¸ªä»»åŠ¡
    for (i in 1..5) {
        // å¯åŠ¨ä»»åŠ¡ï¼Œå¹¶å°†Deferredå¯¹è±¡ä¿å­˜è‡³é›†åˆã€‚
        jobs.add(async { task("$i") })
    }

    // è°ƒç”¨ `awaitAll()` æ–¹æ³•ï¼Œç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚
    val results: List<Int> = awaitAll(*jobs.toTypedArray())
    println("All task is end, results is ${results}.")
}
```

æˆ‘ä»¬ä½¿ç”¨ `async()` æ–¹æ³•å¼€å¯5ä¸ª `task()` ä»»åŠ¡ï¼Œå¹¶å°†å®ƒä»¬çš„ `Deferred<Int>` å¯¹è±¡ä¿å­˜åœ¨é›†åˆä¸­ã€‚

`awaitAll(vararg deferreds: Deferred<T>)` æ–¹æ³•çš„å”¯ä¸€å‚æ•° `deferreds` å³éœ€è¦ç­‰å¾…çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨ `*jobs.toTypedArray()` å…ˆå°†é›†åˆè½¬ä¸ºæ•°ç»„ï¼Œå†å±•å¼€ä¸ºå¯å˜å‚æ•°å®Œæˆä¼ å‚ã€‚

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Task 5 start. Thread:[DefaultDispatcher-worker-6] Time:[16:59:51.866]
Task 2 start. Thread:[DefaultDispatcher-worker-3] Time:[16:59:51.866]
Task 1 start. Thread:[DefaultDispatcher-worker-2] Time:[16:59:51.866]
Task 3 start. Thread:[DefaultDispatcher-worker-4] Time:[16:59:51.866]
Task 4 start. Thread:[DefaultDispatcher-worker-5] Time:[16:59:51.866]
Task 1 end. Thread:[DefaultDispatcher-worker-5] Time:[16:59:53.919]
Task 5 end. Thread:[DefaultDispatcher-worker-5] Time:[16:59:54.917]
Task 4 end. Thread:[DefaultDispatcher-worker-5] Time:[16:59:55.917]
Task 3 end. Thread:[DefaultDispatcher-worker-5] Time:[16:59:56.917]
Task 2 end. Thread:[DefaultDispatcher-worker-4] Time:[16:59:56.917]
All task is end, results is [2, 5, 5, 4, 3].
```

æ ¹æ®ä¸Šè¿°è¾“å‡ºå†…å®¹å¯çŸ¥ï¼š

æ‰€æœ‰å­ä»»åŠ¡åŒæ—¶å¹¶å‘æ‰§è¡Œï¼Œå½“å®ƒä»¬éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œé¡¶å±‚åç¨‹æ¢å¤è¿è¡Œï¼Œå¹¶è¾“å‡ºäº†æ¯ä¸ªä»»åŠ¡è¿”å›çš„ç»“æœã€‚


# é˜»å¡å½“å‰çº¿ç¨‹
CoroutineScopeçš„ `launch()` å’Œ `async()` æ–¹æ³•ç±»ä¼¼ï¼Œéƒ½å¯ä»¥æä¾›åç¨‹ç¯å¢ƒå¹¶å¼€å¯åç¨‹ä»»åŠ¡ï¼Œä½†å®ƒä»¬ä¸ä¼šé˜»å¡è°ƒç”¨è€…çº¿ç¨‹ï¼› `runBlocking()` æ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹æ„å»ºå™¨ï¼Œå®ƒä¸ä¾èµ–CoroutineScopeå¯¹è±¡ï¼Œå¹¶ä¸”ä¼šé˜»å¡è°ƒç”¨è€…çº¿ç¨‹ï¼Œç›´åˆ°åç¨‹ä»»åŠ¡è¿è¡Œå®Œæ¯•ã€‚

ğŸ”´ ç¤ºä¾‹å…«ï¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `runBlocking()` æ–¹æ³•æä¾›åç¨‹ç¯å¢ƒï¼Œå¹¶é˜»å¡æµ‹è¯•ä»£ç çº¿ç¨‹ï¼Œç›´åˆ°åç¨‹ä»»åŠ¡å®Œæˆå†å”¤é†’çº¿ç¨‹ã€‚

"TestCooperation.kt":

```kotlin
println("Thread start. Info:[${getThread()}]")

// åˆ›å»ºåç¨‹ç¯å¢ƒï¼Œå¹¶é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰è¯­å¥æ‰§è¡Œå®Œæ¯•ã€‚
runBlocking {
    println("Coroutine task start. Time:[${getTime()}]")
    delay(2000)
    println("Coroutine task end. Time:[${getTime()}]")
}

println("Thread end. Info:[${getThread()}]")
```

æ­¤æ—¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

```text
Thread start. Info:[main]
Task start. Time:[16:01:19.338]
Task end. Time:[16:01:21.343]
Thread end. Info:[main]
```

---

åœ¨å‰æ–‡ç¤ºä¾‹ä¸­ï¼Œä¸ºäº†é˜²æ­¢ä¸»çº¿ç¨‹åœ¨åç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å‰é€€å‡ºï¼Œæˆ‘ä»¬éœ€è¦è®©ä¸»çº¿ç¨‹ä¼‘çœ å›ºå®šçš„æ—¶é•¿ï¼›å®é™…åº”ç”¨æ—¶æˆ‘ä»¬é€šå¸¸æ— æ³•é¢„ä¼°å¼‚æ­¥ä»»åŠ¡çš„å…·ä½“è€—æ—¶ï¼Œå› æ­¤ä½¿ç”¨ `runBlocking()` æ–¹æ³•æ›´ä¸ºåˆé€‚ã€‚

ä»¥å‰æ–‡â€œç¤ºä¾‹ä¸€â€ä¸ºä¾‹ï¼Œæˆ‘ä»¬æä¾›ä»¥ä¸‹ä¿®æ”¹æ–¹æ³•ã€‚

```kotlin
// å°†CoroutineScopeæ›´æ¢ä¸º `runBlocking()` æ–¹æ³•ï¼Œè‡ªåŠ¨é˜»å¡ä¸å”¤é†’æµ‹è¯•çº¿ç¨‹ã€‚
// CoroutineScope(Dispatchers.Default).launch {
runBlocking {
    task("A", 2000)
    task("B", 2000)
}

// ä¸å†éœ€è¦é€šè¿‡å›ºå®šçš„å»¶æ—¶ç­‰å¾…åç¨‹å®Œæˆ
// Thread.sleep(5000L)
```
